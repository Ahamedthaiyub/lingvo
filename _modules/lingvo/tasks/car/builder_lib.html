

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>lingvo.tasks.car.builder_lib &mdash; Lingvo  documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Lingvo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../lingvo.html">lingvo package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Lingvo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>lingvo.tasks.car.builder_lib</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lingvo.tasks.car.builder_lib</h1><div class="highlight"><pre>
<span></span><span class="c1"># Lint as: python3</span>
<span class="c1"># Copyright 2019 The TensorFlow Authors. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ==============================================================================</span>
<span class="sd">&quot;&quot;&quot;A collection of helper functions to build lingvo layer params.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">lingvo</span> <span class="kn">import</span> <span class="n">compat</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">builder_layers</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">layers</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">py_utils</span>
<span class="kn">from</span> <span class="nn">lingvo.tasks.car</span> <span class="kn">import</span> <span class="n">car_layers</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># Keys for NestedMap for points: points, features, and padding.</span>
<span class="n">POINTS_KEY</span> <span class="o">=</span> <span class="s1">&#39;points&#39;</span>
<span class="n">FEATURES_KEY</span> <span class="o">=</span> <span class="s1">&#39;features&#39;</span>
<span class="n">PADDING_KEY</span> <span class="o">=</span> <span class="s1">&#39;padding&#39;</span>

<span class="c1"># Keys for NestedMap for range images: xyz, features, and mask.</span>
<span class="n">XYZ_KEY</span> <span class="o">=</span> <span class="s1">&#39;xyz&#39;</span>
<span class="n">MASK_KEY</span> <span class="o">=</span> <span class="s1">&#39;mask&#39;</span>


<span class="c1">################################################################################</span>
<span class="c1"># Initializations</span>
<span class="c1">################################################################################</span>
<div class="viewcode-block" id="TruncatedGaussianInit"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.TruncatedGaussianInit">[docs]</a><span class="k">def</span> <span class="nf">TruncatedGaussianInit</span><span class="p">(</span><span class="n">filter_shape</span><span class="p">):</span>
  <span class="n">factor</span> <span class="o">=</span> <span class="mf">2.0</span>
  <span class="n">trunc_stddev</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">1.3</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">/</span> <span class="n">filter_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">TruncatedGaussian</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">trunc_stddev</span><span class="p">)</span></div>


<div class="viewcode-block" id="KaimingUniformFanInRelu"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.KaimingUniformFanInRelu">[docs]</a><span class="k">def</span> <span class="nf">KaimingUniformFanInRelu</span><span class="p">(</span><span class="n">shape</span><span class="p">):</span>
  <span class="k">del</span> <span class="n">shape</span>
  <span class="k">return</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">WeightInit</span><span class="o">.</span><span class="n">KaimingUniformFanInRelu</span><span class="p">()</span></div>


<span class="c1">################################################################################</span>
<span class="c1"># Lingvo Layer Builders</span>
<span class="c1">################################################################################</span>
<span class="c1"># pyformat: disable</span>
<div class="viewcode-block" id="ModelBuilderBase"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase">[docs]</a><span class="k">class</span> <span class="nc">ModelBuilderBase</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Model builder with commonly used layers.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">conv_init_method</span> <span class="o">=</span> <span class="n">TruncatedGaussianInit</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">linear_params_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bn_params_init</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">activation_fn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fc_bn_after_linear</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="ModelBuilderBase._Rep"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Rep">[docs]</a>  <span class="k">def</span> <span class="nf">_Rep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to construct a sequential layer repeated several time.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">SequentialLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">subs</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Seq"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Seq">[docs]</a>  <span class="k">def</span> <span class="nf">_Seq</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">SequentialLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">subs</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Branch"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Branch">[docs]</a>  <span class="k">def</span> <span class="nf">_Branch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">fetches</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">BranchLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">body</span><span class="p">,</span> <span class="n">fetches</span><span class="o">=</span><span class="n">fetches</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._BN"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._BN">[docs]</a>  <span class="k">def</span> <span class="nf">_BN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dims</span><span class="p">):</span>
    <span class="n">bn_params</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">BatchNormLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">dim</span><span class="o">=</span><span class="n">dims</span><span class="p">,</span>
        <span class="n">decay</span><span class="o">=</span><span class="mf">0.99</span><span class="p">,</span>
        <span class="c1"># TODO(b/148537111): consider setting this to True.</span>
        <span class="n">add_stats_to_moving_average_variables</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bn_params_init</span><span class="p">:</span>
      <span class="n">bn_params</span> <span class="o">=</span> <span class="n">bn_params</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">params_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bn_params_init</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bn_params</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Linear"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Linear">[docs]</a>  <span class="k">def</span> <span class="nf">_Linear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">,</span> <span class="n">params_init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">linear_params</span> <span class="o">=</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">LinearLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">input_dims</span><span class="o">=</span><span class="n">idims</span><span class="p">,</span> <span class="n">output_dims</span><span class="o">=</span><span class="n">odims</span><span class="p">)</span>

    <span class="n">params_init</span> <span class="o">=</span> <span class="n">params_init</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_params_init</span>
    <span class="k">if</span> <span class="n">params_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">linear_params</span> <span class="o">=</span> <span class="n">linear_params</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">params_init</span><span class="o">=</span><span class="n">params_init</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">linear_params</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Bias"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Bias">[docs]</a>  <span class="k">def</span> <span class="nf">_Bias</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">params_init</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">bias_params</span> <span class="o">=</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">BiasLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">params_init</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">bias_params</span> <span class="o">=</span> <span class="n">bias_params</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">params_init</span><span class="o">=</span><span class="n">params_init</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bias_params</span></div>

  <span class="c1"># TODO(tilarids): Consider using lingvo.core.activations.</span>
<div class="viewcode-block" id="ModelBuilderBase._Activation"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Activation">[docs]</a>  <span class="k">def</span> <span class="nf">_Activation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">activation_fn</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">MapLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Relu"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Relu">[docs]</a>  <span class="k">def</span> <span class="nf">_Relu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Activation</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">relu</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Swish"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Swish">[docs]</a>  <span class="k">def</span> <span class="nf">_Swish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Activation</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">swish</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Sigmoid"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Sigmoid">[docs]</a>  <span class="k">def</span> <span class="nf">_Sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Activation</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._FC"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._FC">[docs]</a>  <span class="k">def</span> <span class="nf">_FC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fully connected layer, with optional batch norm.&quot;&quot;&quot;</span>
    <span class="n">activation_fn</span> <span class="o">=</span> <span class="n">activation_fn</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation_fn</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">idims</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
      <span class="n">idims</span> <span class="o">=</span> <span class="n">idims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">fc_layers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Linear</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">use_bn</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_bn_after_linear</span><span class="p">:</span>
      <span class="c1"># Note that bn should use odims, since after linear.</span>
      <span class="n">fc_layers</span> <span class="o">=</span> <span class="n">fc_layers</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_BN</span><span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="n">odims</span><span class="p">)]</span>
    <span class="k">elif</span> <span class="n">use_bn</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_bn_after_linear</span><span class="p">):</span>
      <span class="c1"># Note that bn should use idims, since before linear.</span>
      <span class="n">fc_layers</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_BN</span><span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">)]</span> <span class="o">+</span> <span class="n">fc_layers</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Add bias since no batch norm that folds in bias.</span>
      <span class="n">fc_layers</span> <span class="o">=</span> <span class="n">fc_layers</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Bias</span><span class="p">(</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">odims</span><span class="p">)]</span>
    <span class="n">fc_layers</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Activation</span><span class="p">(</span><span class="s1">&#39;activation&#39;</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">)]</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">fc_layers</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._MLP"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._MLP">[docs]</a>  <span class="k">def</span> <span class="nf">_MLP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
      <span class="n">l</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_FC</span><span class="p">(</span><span class="s1">&#39;l</span><span class="si">%03d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="n">use_bn</span><span class="p">,</span>
                     <span class="n">activation_fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">)]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Map"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Map">[docs]</a>  <span class="k">def</span> <span class="nf">_Map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">MapLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Max"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Max">[docs]</a>  <span class="k">def</span> <span class="nf">_Max</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Map</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;axis&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">2</span><span class="p">})</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Reshape"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Reshape">[docs]</a>  <span class="k">def</span> <span class="nf">_Reshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">shape</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">MapLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shape&#39;</span><span class="p">:</span> <span class="n">shape</span><span class="p">})</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Matmul"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Matmul">[docs]</a>  <span class="k">def</span> <span class="nf">_Matmul</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">ParFn</span><span class="p">(</span><span class="o">*</span><span class="n">xs</span><span class="p">):</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">result</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Par</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ParFn</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._GLU"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._GLU">[docs]</a>  <span class="k">def</span> <span class="nf">_GLU</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">Gate</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="n">u</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">u</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Linear</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Bias</span><span class="p">(</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">odims</span> <span class="o">*</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">builder_layers</span><span class="o">.</span><span class="n">MapLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;gate&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">Gate</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Dropout"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Dropout">[docs]</a>  <span class="k">def</span> <span class="nf">_Dropout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">layers</span><span class="o">.</span><span class="n">DropoutLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">keep_prob</span><span class="o">=</span><span class="n">keep_prob</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Fetch"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Fetch">[docs]</a>  <span class="k">def</span> <span class="nf">_Fetch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">layers</span><span class="o">.</span><span class="n">FetchLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._FirstN"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._FirstN">[docs]</a>  <span class="k">def</span> <span class="nf">_FirstN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the first n args.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">FirstNLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._ArgIdx"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._ArgIdx">[docs]</a>  <span class="k">def</span> <span class="nf">_ArgIdx</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">ArgIndexLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">idx</span><span class="o">=</span><span class="n">index</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Join"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Join">[docs]</a>  <span class="k">def</span> <span class="nf">_Join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Juxtapose outputs from \*subs in a single output tuple.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">Join</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
      <span class="n">arg_lists</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">]</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">arg_lists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">arg_lists</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span> <span class="o">+</span> <span class="n">v</span>
      <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">ParallelLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span> <span class="n">merge</span><span class="o">=</span><span class="n">Join</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Par"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Par">[docs]</a>  <span class="k">def</span> <span class="nf">_Par</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to construct a parallel layer which merge branches.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_Merge</span><span class="p">(</span><span class="n">xs</span><span class="p">):</span>
      <span class="n">rets</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">ys</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">xs</span><span class="p">):</span>
        <span class="n">rets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">ys</span><span class="p">))</span>
      <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">rets</span><span class="p">)</span>

    <span class="c1"># TODO(zhifengc): fill merge_meta to compute flops and output shape, etc.</span>
    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">ParallelLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span> <span class="n">merge</span><span class="o">=</span><span class="n">_Merge</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Concat"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Concat">[docs]</a>  <span class="k">def</span> <span class="nf">_Concat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Concatenate outputs from \*subs along the last dimensions.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Par</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">xs</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._BroadcastConcat"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._BroadcastConcat">[docs]</a>  <span class="k">def</span> <span class="nf">_BroadcastConcat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Concatenate outputs from \*subs, broadcasting to match leading shape.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_Merge</span><span class="p">(</span><span class="o">*</span><span class="n">xs</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Broadcast all dimensions except the last, and concat on last dim.&quot;&quot;&quot;</span>

      <span class="c1"># Stack all shapes and take max on each dimension to get leading shape.</span>
      <span class="n">leading_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">])</span>
      <span class="n">leading_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">leading_shape</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="c1"># Broadcast each x.</span>
      <span class="n">broadcast_xs</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">xs</span><span class="p">:</span>
        <span class="n">broadcast_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">leading_shape</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">broadcast_xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">broadcast_shape</span><span class="p">))</span>

      <span class="c1"># Concat on last dimension.</span>
      <span class="n">concat_xs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">broadcast_xs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">concat_xs</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Par</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_Merge</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._ApplyFnMulti"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._ApplyFnMulti">[docs]</a>  <span class="k">def</span> <span class="nf">_ApplyFnMulti</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A common use case where every branch produces a single output tensor.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Par</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._ApplyInParallelAndMerge"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._ApplyInParallelAndMerge">[docs]</a>  <span class="k">def</span> <span class="nf">_ApplyInParallelAndMerge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">merge_fn</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Applies the subs in parallel to the given input and merges their outputs.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: String layer name.</span>
<span class="sd">      merge_fn: Function to merge the outputs of `subs`, which will be a</span>
<span class="sd">        flattened list of subs outputs. For example, if there were 3 subs with</span>
<span class="sd">        outputs (out1,), (out21, out22), (out31, out32), the output will be</span>
<span class="sd">        [out1, out21, out22, out31, out32].</span>
<span class="sd">      *subs: Modules to be applied in parallel to the input</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for this layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Join</span><span class="p">(</span><span class="s1">&#39;parallel_subs&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFn</span><span class="p">(</span><span class="s1">&#39;merge&#39;</span><span class="p">,</span> <span class="n">merge_fn</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._ApplyFn"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._ApplyFn">[docs]</a>  <span class="k">def</span> <span class="nf">_ApplyFn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply fn over the input tuple.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">ParallelLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)],</span> <span class="n">merge</span><span class="o">=</span><span class="k">lambda</span> <span class="n">xs</span><span class="p">:</span> <span class="p">(</span><span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">xs</span><span class="p">[</span><span class="mi">0</span><span class="p">])),))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._MakeInputFeatureFromPoints"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._MakeInputFeatureFromPoints">[docs]</a>  <span class="k">def</span> <span class="nf">_MakeInputFeatureFromPoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transforms points to features using the points with constant padding.</span>

<span class="sd">    Layer input/output shapes: [N x P x 3] -&gt; ([N x P x 3], [N x P x 4])</span>

<span class="sd">    Args:</span>
<span class="sd">      name: String layer name.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for this layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">PadOne</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
      <span class="n">inp</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">constant_values</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Join</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFn</span><span class="p">(</span><span class="s1">&#39;pad&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">PadOne</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Squeeze"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Squeeze">[docs]</a>  <span class="k">def</span> <span class="nf">_Squeeze</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_SqueezeFn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFn</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">_SqueezeFn</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._ConvPlain"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._ConvPlain">[docs]</a>  <span class="k">def</span> <span class="nf">_ConvPlain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filter_shape</span><span class="p">,</span> <span class="n">filter_stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                 <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span> <span class="n">conv_init_method</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">conv_init_method</span> <span class="o">=</span> <span class="n">conv_init_method</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_init_method</span><span class="p">(</span><span class="n">filter_shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">layers</span><span class="o">.</span><span class="n">Conv2DLayerNoPadding</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">filter_shape</span><span class="o">=</span><span class="n">filter_shape</span><span class="p">,</span>
        <span class="n">filter_stride</span><span class="o">=</span><span class="n">filter_stride</span><span class="p">,</span>
        <span class="n">padding</span><span class="o">=</span><span class="n">padding</span><span class="p">,</span>
        <span class="n">params_init</span><span class="o">=</span><span class="n">conv_init_method</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._DeconvPlain"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._DeconvPlain">[docs]</a>  <span class="k">def</span> <span class="nf">_DeconvPlain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filter_shape</span><span class="p">,</span> <span class="n">filter_stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)):</span>
    <span class="k">return</span> <span class="n">layers</span><span class="o">.</span><span class="n">DeconvLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
        <span class="n">filter_shape</span><span class="o">=</span><span class="n">filter_shape</span><span class="p">,</span>
        <span class="n">filter_stride</span><span class="o">=</span><span class="n">filter_stride</span><span class="p">,</span>
        <span class="n">params_init</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_init_method</span><span class="p">(</span><span class="n">filter_shape</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Conv"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Conv">[docs]</a>  <span class="k">def</span> <span class="nf">_Conv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filter_shape</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="s1">&#39;SAME&#39;</span><span class="p">,</span>
            <span class="n">use_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper to construct a conv/normalize/actvation layer.&quot;&quot;&quot;</span>
    <span class="c1"># TODO(zhifengc): Revisit whether BatchNormLayer should apply gamma when the</span>
    <span class="c1"># following activation is a relu.</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stride</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="n">filter_stride</span> <span class="o">=</span> <span class="n">stride</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stride</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
      <span class="n">filter_stride</span> <span class="o">=</span> <span class="p">(</span><span class="n">stride</span><span class="p">,</span> <span class="n">stride</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Input stride not a tuple or int. Is a </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">stride</span><span class="p">)))</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BN</span><span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="n">filter_shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="k">if</span> <span class="n">use_bn</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Identity</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ConvPlain</span><span class="p">(</span><span class="s1">&#39;conv&#39;</span><span class="p">,</span> <span class="n">filter_shape</span><span class="p">,</span> <span class="n">filter_stride</span><span class="p">,</span> <span class="n">padding</span><span class="p">),</span>
        <span class="n">norm</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Relu</span><span class="p">(</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Identity"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Identity">[docs]</a>  <span class="k">def</span> <span class="nf">_Identity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply identity transformation.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">layers</span><span class="o">.</span><span class="n">IdentityLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Shortcut"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Shortcut">[docs]</a>  <span class="k">def</span> <span class="nf">_Shortcut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">,</span> <span class="n">stride</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply ResNet shortcut transformation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">idims</span> <span class="o">!=</span> <span class="n">odims</span> <span class="ow">or</span> <span class="n">stride</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ConvPlain</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">),</span> <span class="n">stride</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Identity</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._ResidualLayer"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._ResidualLayer">[docs]</a>  <span class="k">def</span> <span class="nf">_ResidualLayer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filter_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ResNet basic layer, as in https://arxiv.org/pdf/1512.03385.pdf Fig. 2.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: string layer name.</span>
<span class="sd">      filter_size: tuple of integers (filter_height, filter_width, idims, odims)</span>
<span class="sd">        , which represent filter height, filter width, input channel size,</span>
<span class="sd">        output channel size.</span>
<span class="sd">      stride: integer of tuple of integers to apply to all dimensions when using</span>
<span class="sd">        2D convolution. This will be applied to the shortcut layer and the</span>
<span class="sd">        first convolution layer.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for a residual layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filter_height</span><span class="p">,</span> <span class="n">filter_width</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span> <span class="o">=</span> <span class="n">filter_size</span>
    <span class="n">repeated_filter_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">filter_height</span><span class="p">,</span> <span class="n">filter_width</span><span class="p">,</span> <span class="n">odims</span><span class="p">,</span> <span class="n">odims</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Add</span><span class="p">(</span>
            <span class="s1">&#39;add&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Shortcut</span><span class="p">(</span><span class="s1">&#39;shortcut&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">,</span> <span class="n">stride</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
                <span class="s1">&#39;residual&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Conv</span><span class="p">(</span><span class="s1">&#39;conv_a&#39;</span><span class="p">,</span> <span class="n">filter_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ConvPlain</span><span class="p">(</span><span class="s1">&#39;conv_b&#39;</span><span class="p">,</span> <span class="n">repeated_filter_size</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_BN</span><span class="p">(</span><span class="s1">&#39;residual_bn&#39;</span><span class="p">,</span> <span class="n">odims</span><span class="p">))),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Relu</span><span class="p">(</span><span class="s1">&#39;relu_add&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._ResidualBlock"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._ResidualBlock">[docs]</a>  <span class="k">def</span> <span class="nf">_ResidualBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filter_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">repeats</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;ResNet block that downsamples at the beginning.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: string block name.</span>
<span class="sd">      filter_size: tuple of integers (filter_height, filter_width, idims, odims)</span>
<span class="sd">        , which represent filter height, filter width, input channel size,</span>
<span class="sd">        output channel size.</span>
<span class="sd">      stride: integer of tuple of integers to apply to all dimensions when using</span>
<span class="sd">        2D convolution. It is applied only to the first downsampling layer for</span>
<span class="sd">        efficiency.</span>
<span class="sd">      repeats: integer number of residual layers to stack.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for a residual block.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">filter_height</span><span class="p">,</span> <span class="n">filter_width</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">odims</span> <span class="o">=</span> <span class="n">filter_size</span>
    <span class="n">repeated_filter_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">filter_height</span><span class="p">,</span> <span class="n">filter_width</span><span class="p">,</span> <span class="n">odims</span><span class="p">,</span> <span class="n">odims</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ResidualLayer</span><span class="p">(</span><span class="s1">&#39;res3x3_0&#39;</span><span class="p">,</span> <span class="n">filter_size</span><span class="p">,</span> <span class="n">stride</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Rep</span><span class="p">(</span>
            <span class="s1">&#39;rep&#39;</span><span class="p">,</span>
            <span class="n">repeats</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ResidualLayer</span><span class="p">(</span><span class="s1">&#39;res3x3_1&#39;</span><span class="p">,</span> <span class="n">repeated_filter_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Fetch</span><span class="p">(</span><span class="s1">&#39;final&#39;</span><span class="p">))</span></div>

  <span class="c1">##########################################</span>
  <span class="c1"># Self-attention stack.</span>
  <span class="c1">#</span>
  <span class="c1"># NOTE: layers_with_attention has TransformerLayers.  We do not use that</span>
  <span class="c1"># directly because those layers assumes input tensors are in [time, batch,</span>
  <span class="c1"># dims] so that it&#39;s convenient for left-to-right decoding use case.  Point</span>
  <span class="c1"># cloud modeling is unlikely need that.</span>
  <span class="c1">#</span>
  <span class="c1"># We also restrict the attention type to the simplest dot-attention for now.</span>
  <span class="c1">##########################################</span>
<div class="viewcode-block" id="ModelBuilderBase._SelfAttenStack"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._SelfAttenStack">[docs]</a>  <span class="k">def</span> <span class="nf">_SelfAttenStack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A self-attentional stack.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: string layer name.</span>
<span class="sd">      depth: int. The number of transformer layers.</span>
<span class="sd">      dims: int. The dimension of each transformer layer.</span>
<span class="sd">      hdims: int. The hidden dimension of each transformer layer.</span>
<span class="sd">        Typically, hdims &gt;= dims.</span>
<span class="sd">      heads: int. The number of attention heads.</span>
<span class="sd">      keep_prob: Dropout keep probability.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for this layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Rep</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Atten</span><span class="p">(</span><span class="s1">&#39;atten&#39;</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Atten"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Atten">[docs]</a>  <span class="k">def</span> <span class="nf">_Atten</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">keep_prob</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transformer self-attention layer.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_AttenSelf</span><span class="p">(</span><span class="s1">&#39;self&#39;</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_AttenFF</span><span class="p">(</span><span class="s1">&#39;ff&#39;</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._LN"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._LN">[docs]</a>  <span class="k">def</span> <span class="nf">_LN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dims</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Layer norm.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNorm</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">input_dim</span><span class="o">=</span><span class="n">dims</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Project"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Project">[docs]</a>  <span class="k">def</span> <span class="nf">_Project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Project layer. Simply X*W+b.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Linear</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Bias</span><span class="p">(</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">odims</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Add"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Add">[docs]</a>  <span class="k">def</span> <span class="nf">_Add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add two branches. out = lhs(in) + rhs(in).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFnMulti</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Multiply"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Multiply">[docs]</a>  <span class="k">def</span> <span class="nf">_Multiply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Multiply two branches. out = lhs(in) * rhs(in).&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFnMulti</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._AttenFF"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._AttenFF">[docs]</a>  <span class="k">def</span> <span class="nf">_AttenFF</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">,</span> <span class="n">keep_prob</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transformer feed-forward layer.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Add</span><span class="p">(</span>
            <span class="s1">&#39;residual&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
                <span class="s1">&#39;ff&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_LN</span><span class="p">(</span><span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="n">dims</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_FC</span><span class="p">(</span><span class="s1">&#39;fc&#39;</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Project</span><span class="p">(</span><span class="s1">&#39;proj&#39;</span><span class="p">,</span> <span class="n">hdims</span><span class="p">,</span> <span class="n">dims</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Dropout</span><span class="p">(</span><span class="s1">&#39;dropout&#39;</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">))))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._AttenSelf"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._AttenSelf">[docs]</a>  <span class="k">def</span> <span class="nf">_AttenSelf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">keep_prob</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Dot-attention, multiple heads, self-attention.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">hdims</span> <span class="o">%</span> <span class="n">heads</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;hdims=</span><span class="si">{}</span><span class="s1"> heads=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hdims</span><span class="p">,</span> <span class="n">heads</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_Atten</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Returns weighted val based on dot-attention between query and key.&quot;&quot;&quot;</span>
      <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

      <span class="c1"># Query.</span>
      <span class="n">query</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">hdims</span><span class="p">])</span>
      <span class="n">query</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">hdims</span> <span class="o">//</span> <span class="n">heads</span><span class="p">])</span>
      <span class="n">query</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

      <span class="c1"># Key.</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">hdims</span><span class="p">])</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">hdims</span> <span class="o">//</span> <span class="n">heads</span><span class="p">])</span>
      <span class="n">key</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

      <span class="c1"># query:[b, heads, n, hdims // heads]</span>
      <span class="c1"># key:  [b, heads, n, hdims // heads]^T</span>
      <span class="n">dotp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">transpose_b</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="n">probs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">dotp</span><span class="p">)</span>
      <span class="n">probs</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">])</span>

      <span class="c1"># value (aka. context)</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">hdims</span><span class="p">])</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">hdims</span> <span class="o">//</span> <span class="n">heads</span><span class="p">])</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
      <span class="n">val</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">heads</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">hdims</span> <span class="o">//</span> <span class="n">heads</span><span class="p">])</span>

      <span class="c1"># Weighted average of value (context). [b, heads, n, hdims // heads]</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
      <span class="n">out</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="p">[</span><span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">hdims</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">out</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Add</span><span class="p">(</span>
            <span class="s1">&#39;residual&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
                <span class="s1">&#39;lapd&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_LN</span><span class="p">(</span><span class="s1">&#39;ln&#39;</span><span class="p">,</span> <span class="n">dims</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFnMulti</span><span class="p">(</span>
                    <span class="s1">&#39;atten&#39;</span><span class="p">,</span>
                    <span class="n">_Atten</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Project</span><span class="p">(</span><span class="s1">&#39;query&#39;</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Project</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_Project</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">hdims</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Project</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">hdims</span><span class="p">,</span> <span class="n">dims</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Dropout</span><span class="p">(</span><span class="s1">&#39;dropout&#39;</span><span class="p">,</span> <span class="n">keep_prob</span><span class="p">))))</span></div>

  <span class="c1">##########################################</span>
  <span class="c1"># Location and Padding Aware Layers and Helpers</span>
  <span class="c1">#</span>
  <span class="c1"># These layers expect as input a NestedMap containing the following keys:</span>
  <span class="c1">#</span>
  <span class="c1">#   points: tensor with shape [..., 3] containing xyz coordinates</span>
  <span class="c1">#   features: tensor with shape [..., C] containing features for each point</span>
  <span class="c1">#   padding: tensor with same leading shape containing 0/1 with</span>
  <span class="c1">#     1 representing a padded point, and 0 representing a real point.</span>
  <span class="c1">#</span>
  <span class="c1">##########################################</span>
<div class="viewcode-block" id="ModelBuilderBase._Decorators"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Decorators">[docs]</a>  <span class="k">class</span> <span class="nc">_Decorators</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Internal decorators for builder functions.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ModelBuilderBase._Decorators.ExpectsNestedMapTensor"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Decorators.ExpectsNestedMapTensor">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">ExpectsNestedMapTensor</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">expected_keys</span><span class="o">=</span><span class="p">()):</span>
      <span class="sd">&quot;&quot;&quot;Adds a validation layer before the layer produced by builder_fn.</span>

<span class="sd">      Args:</span>
<span class="sd">        expected_keys: A string, or an iterable of strings that are expected to</span>
<span class="sd">          be in the input NestedMap.</span>

<span class="sd">      Returns:</span>
<span class="sd">        A decorator function that can be applied on builder functions.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expected_keys</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">expected_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">expected_keys</span><span class="p">]</span>
      <span class="n">expected_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected_keys</span><span class="p">)</span>

      <span class="k">def</span> <span class="nf">_ValidateFn</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Validate that inp contains the expected keys.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">):</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input not a `NestedMap`. Is a </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">inp</span><span class="p">)))</span>
        <span class="n">input_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expected_keys</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">input_keys</span><span class="p">):</span>
          <span class="n">missing_keys</span> <span class="o">=</span> <span class="n">expected_keys</span> <span class="o">-</span> <span class="n">input_keys</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Input is missing key(s): </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">inp</span>

      <span class="k">def</span> <span class="nf">_Decorator</span><span class="p">(</span><span class="n">builder_fn</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">_DecoratedFn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
          <span class="n">p</span> <span class="o">=</span> <span class="n">builder_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
          <span class="c1"># pylint: disable=protected-access</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;validated_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFn</span><span class="p">(</span><span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">_ValidateFn</span><span class="p">),</span> <span class="n">p</span><span class="p">)</span>
          <span class="c1"># pylint: enable=protected-access</span>
        <span class="k">return</span> <span class="n">_DecoratedFn</span>

      <span class="k">return</span> <span class="n">_Decorator</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Decorators.ExpectsNestedMapPointsTensor"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Decorators.ExpectsNestedMapPointsTensor">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">ExpectsNestedMapPointsTensor</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">builder_fn</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Adds a validation layer before the layer produced by builder_fn.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ExpectsNestedMapTensor</span><span class="p">(</span>
          <span class="n">expected_keys</span><span class="o">=</span><span class="p">(</span><span class="n">POINTS_KEY</span><span class="p">,</span> <span class="n">FEATURES_KEY</span><span class="p">,</span> <span class="n">PADDING_KEY</span><span class="p">))(</span><span class="n">builder_fn</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._Decorators.ExpectsNestedMapRangeImage"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._Decorators.ExpectsNestedMapRangeImage">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">ExpectsNestedMapRangeImage</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">builder_fn</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Adds a validation layer before the layer produced by builder_fn.&quot;&quot;&quot;</span>
      <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ExpectsNestedMapTensor</span><span class="p">(</span>
          <span class="n">expected_keys</span><span class="o">=</span><span class="p">(</span><span class="n">XYZ_KEY</span><span class="p">,</span> <span class="n">FEATURES_KEY</span><span class="p">,</span> <span class="n">MASK_KEY</span><span class="p">))(</span><span class="n">builder_fn</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="ModelBuilderBase._GetValue"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._GetValue">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapTensor</span><span class="p">()</span>
  <span class="k">def</span> <span class="nf">_GetValue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Expects a NestedMap as input and produces the value for the given key.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">GetValueFn</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;At layer with name=</span><span class="si">{}</span><span class="s1">. Unable to retrieve key </span><span class="si">{}</span><span class="s1">, &#39;</span>
                         <span class="s1">&#39;input not a `NestedMap`. Is a </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">inp</span><span class="p">)))</span>
      <span class="k">return</span> <span class="n">inp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Map</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">GetValueFn</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._ParMap"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._ParMap">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapTensor</span><span class="p">()</span>
  <span class="k">def</span> <span class="nf">_ParMap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key_to_sub</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform parallel layers and create a NestedMap from the outputs.</span>

<span class="sd">    Parallel branches on an input `NestedMap`. Each branch should expect the</span>
<span class="sd">    same `NestedMap` as input; each branch&#39;s output will be mapped to the</span>
<span class="sd">    specified key in key_to_sub.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: String layer name.</span>
<span class="sd">      key_to_sub: Dictionary mapping keys to sub params. Each sub should expect</span>
<span class="sd">        a NestedMap input.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for this layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sorted_keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">key_to_sub</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">sorted_subs</span> <span class="o">=</span> <span class="p">[</span><span class="n">key_to_sub</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">sorted_keys</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_MakeNestedMap</span><span class="p">(</span><span class="o">*</span><span class="n">vals</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sorted_keys</span><span class="p">,</span> <span class="n">vals</span><span class="p">)))</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFnMulti</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">_MakeNestedMap</span><span class="p">,</span> <span class="o">*</span><span class="n">sorted_subs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._SeqToKey"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._SeqToKey">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapTensor</span><span class="p">()</span>
  <span class="k">def</span> <span class="nf">_SeqToKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply sequence to only update the value at a specific key.</span>

<span class="sd">    Note: This is the more general version of SeqOnKey. SeqOnKey automatically</span>
<span class="sd">    extracts the key value before running subs, while SeqToKey passes the entire</span>
<span class="sd">    input through.</span>

<span class="sd">    This function expects a NestedMap as an input, and applies the provided</span>
<span class="sd">    subs on the entire NestedMap, but only updates the value at the specified</span>
<span class="sd">    key. The resulting value (tensor or NestedMap) from these subs is placed as</span>
<span class="sd">    the new value for the specified key in the original NestedMap. The rest of</span>
<span class="sd">    the key, value pairs are returned untouched.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: string layer name.</span>
<span class="sd">      key: string key to update after running sequence on.</span>
<span class="sd">      *subs: A list of sub layer Params that should expect the input NestedMap.</span>
<span class="sd">        The output of the subs will be placed back to the specified key.</span>
<span class="sd">    Returns:</span>
<span class="sd">      Params for this layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_Merge</span><span class="p">(</span><span class="n">outputs</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Merges the outputs from ParallelLayer.</span>

<span class="sd">      Args:</span>
<span class="sd">        outputs: A tuple of two elements: (a) the original input NestedMap and</span>
<span class="sd">          (b) the outputs from applying the sub layers in subs.</span>

<span class="sd">      Returns:</span>
<span class="sd">        A new NestedMap map with the specified key&#39;s value replaced with the</span>
<span class="sd">        result from subs.</span>
<span class="sd">      &quot;&quot;&quot;</span>

      <span class="n">input_map</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">seq_result</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">new_map</span> <span class="o">=</span> <span class="n">input_map</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">()</span>
      <span class="n">new_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">seq_result</span>

      <span class="k">return</span> <span class="p">(</span><span class="n">new_map</span><span class="p">,)</span>

    <span class="k">return</span> <span class="n">builder_layers</span><span class="o">.</span><span class="n">ParallelLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">sub</span><span class="o">=</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;key_seq&#39;</span><span class="p">,</span>
                      <span class="o">*</span><span class="n">subs</span><span class="p">)</span>
        <span class="p">],</span> <span class="n">merge</span><span class="o">=</span><span class="n">_Merge</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._SeqOnKey"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._SeqOnKey">[docs]</a>  <span class="k">def</span> <span class="nf">_SeqOnKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sequential layers operating on a specific key only.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SeqToKey</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">key</span><span class="p">),</span>
                          <span class="o">*</span><span class="n">subs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._SeqOnFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._SeqOnFeatures">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapTensor</span><span class="p">(</span><span class="n">FEATURES_KEY</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_SeqOnFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sequential layers operating on the features only.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SeqOnKey</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">FEATURES_KEY</span><span class="p">,</span> <span class="o">*</span><span class="n">subs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._PaddedMax"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._PaddedMax">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapPointsTensor</span>
  <span class="k">def</span> <span class="nf">_PaddedMax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Padding aware max pooling layer, emits a single tensor.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">_PaddedMaxFn</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Apply padded max using reduce_max with paddings replaced by neginf.&quot;&quot;&quot;</span>
      <span class="c1"># Replace all padded features with -inf.</span>
      <span class="n">neginf_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
          <span class="n">inp</span><span class="o">.</span><span class="n">padding</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">inp</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="n">inp</span><span class="o">.</span><span class="n">padding</span><span class="p">)</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">features</span> <span class="o">+</span> <span class="n">neginf_padding</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>

      <span class="c1"># Replace features of all padded points by zeros. If a batch of points are</span>
      <span class="c1"># all padded, then reduce_min over the padding will be 1. We set the</span>
      <span class="c1"># features to be zero, so that we don&#39;t get any downstream issue with</span>
      <span class="c1"># NaNs. Note that inf * 0 = NaN.</span>
      <span class="n">all_padded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">inp</span><span class="o">.</span><span class="n">padding</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
      <span class="n">all_padded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">all_padded</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span>
                                   <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">all_padded</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">features</span><span class="p">),</span> <span class="n">features</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">CheckNumerics</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Map</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">_PaddedMaxFn</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._PaddedMean"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._PaddedMean">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapPointsTensor</span>
  <span class="k">def</span> <span class="nf">_PaddedMean</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Padding aware mean pooling layer, emits a single tensor.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_PaddedMeanFn</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Apply padded mean using reduce_sum and dividing by # real points.&quot;&quot;&quot;</span>
      <span class="c1"># Replace all padded features with 0 by masking the padded features out.</span>
      <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">inp</span><span class="o">.</span><span class="n">padding</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">features</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
      <span class="n">num_real_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
      <span class="c1"># Prevent the divisor of our padded mean from ever being 0, so that</span>
      <span class="c1"># the gradient flowing back through this op doesn&#39;t give us NaNs.</span>
      <span class="n">num_real_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">num_real_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">features</span> <span class="o">/</span> <span class="n">num_real_points</span>

      <span class="c1"># Replace features of all padded points by zeros. If a batch of points are</span>
      <span class="c1"># all padded, then num_real_points will be zero. We set the features to be</span>
      <span class="c1"># zero, so that we don&#39;t get any downstream issue with NaNs.</span>
      <span class="c1"># Note that inf * 0 = NaN.</span>
      <span class="n">all_padded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">num_real_points</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
      <span class="n">all_padded</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">all_padded</span><span class="p">,</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">features</span><span class="p">))</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">all_padded</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">features</span><span class="p">),</span> <span class="n">features</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">CheckNumerics</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Map</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">_PaddedMeanFn</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._PaddedSum"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._PaddedSum">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapPointsTensor</span>
  <span class="k">def</span> <span class="nf">_PaddedSum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Padding aware sum pooling layer, emits a single tensor.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_PaddedSumFn</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
      <span class="c1"># Replace all padded features with 0 by masking the padded features out.</span>
      <span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">inp</span><span class="o">.</span><span class="n">padding</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">inp</span><span class="o">.</span><span class="n">features</span> <span class="o">*</span> <span class="n">mask</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">features</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Map</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">_PaddedSumFn</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._FeaturesFC"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._FeaturesFC">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapTensor</span><span class="p">(</span><span class="n">FEATURES_KEY</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_FeaturesFC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Applies a FC layer to `features` key, emits a `NestedMap`.&quot;&quot;&quot;</span>
    <span class="n">activation_fn</span> <span class="o">=</span> <span class="n">activation_fn</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation_fn</span>
    <span class="n">bn_join_layer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Join</span><span class="p">(</span>
        <span class="s1">&#39;join_features_padding&#39;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_features&#39;</span><span class="p">,</span> <span class="n">FEATURES_KEY</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;expand_padding&#39;</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_padding&#39;</span><span class="p">,</span> <span class="s1">&#39;padding&#39;</span><span class="p">),</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFn</span><span class="p">(</span><span class="s1">&#39;expand&#39;</span><span class="p">,</span>
                                <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])))</span>
    <span class="k">if</span> <span class="n">use_bn</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_bn_after_linear</span><span class="p">:</span>
      <span class="c1"># Note that bn should use odims, since after linear.</span>
      <span class="n">seq_p</span> <span class="o">=</span> <span class="p">[</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_SeqToKey</span><span class="p">(</span><span class="s1">&#39;linear_seq&#39;</span><span class="p">,</span>
                         <span class="n">FEATURES_KEY</span><span class="p">,</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_features&#39;</span><span class="p">,</span> <span class="n">FEATURES_KEY</span><span class="p">),</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">_Linear</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">)),</span>
          <span class="n">bn_join_layer</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_BN</span><span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="n">odims</span><span class="p">),</span>
      <span class="p">]</span>
    <span class="k">elif</span> <span class="n">use_bn</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">fc_bn_after_linear</span><span class="p">):</span>
      <span class="c1"># Note that bn should use idims, since before linear.</span>
      <span class="n">seq_p</span> <span class="o">=</span> <span class="p">[</span>
          <span class="n">bn_join_layer</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_BN</span><span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">),</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_Linear</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">),</span>
      <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Add bias since no batch norm that folds in bias.</span>
      <span class="n">seq_p</span> <span class="o">=</span> <span class="p">[</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_features&#39;</span><span class="p">,</span> <span class="n">FEATURES_KEY</span><span class="p">),</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_Linear</span><span class="p">(</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">),</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_Bias</span><span class="p">(</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">odims</span><span class="p">),</span>
      <span class="p">]</span>
    <span class="n">seq_p</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_Activation</span><span class="p">(</span><span class="s1">&#39;activation&#39;</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">)]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SeqToKey</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">FEATURES_KEY</span><span class="p">,</span> <span class="o">*</span><span class="n">seq_p</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._FeaturesMLP"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._FeaturesMLP">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapTensor</span><span class="p">(</span><span class="n">FEATURES_KEY</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_FeaturesMLP</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">l</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
      <span class="n">l</span> <span class="o">+=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_FeaturesFC</span><span class="p">(</span><span class="s1">&#39;l</span><span class="si">%03d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="n">use_bn</span><span class="p">,</span>
                             <span class="n">activation_fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">)]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">l</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._CondFC"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._CondFC">[docs]</a>  <span class="k">def</span> <span class="nf">_CondFC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">adims</span><span class="p">,</span> <span class="n">odims</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Conditional FC layer to use with GIN as a combiner.</span>

<span class="sd">    ([..., P, idims], [..., 1, adims]) -&gt; [..., P, odims]</span>

<span class="sd">    This layer expects an input tuple (features, aggregate), where features</span>
<span class="sd">    contains per-point features, and aggregate is a global feature (e.g.,</span>
<span class="sd">    computed using max-pooling over all the points). The aggregate tensor</span>
<span class="sd">    is used to compute a linear transformation that is used in this FC layer.</span>
<span class="sd">    Each example in the batch has a different linear transformation. This layer</span>
<span class="sd">    is similar to the T-Net transformation in PointNet.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: String name for this layer.</span>
<span class="sd">      idims: Dimension for last axis of features tensor.</span>
<span class="sd">      adims: Dimension for last axis of aggregate tensor.</span>
<span class="sd">      odims: Number of output dimensions.</span>
<span class="sd">      use_bn: Whether to enable batch norm.</span>
<span class="sd">      activation_fn: Optional override for the activation function. If None,</span>
<span class="sd">        defaults to the activation fn that the builder is initialized with.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for a layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">activation_fn</span> <span class="o">=</span> <span class="n">activation_fn</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation_fn</span>

    <span class="k">def</span> <span class="nf">_ReshapeTransform</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Reshape the transformation tensor to [..., idims, odims].&quot;&quot;&quot;</span>
      <span class="n">base_shape</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">inp</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">out_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">base_shape</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">idims</span><span class="p">,</span> <span class="n">odims</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">out_shape</span><span class="p">)</span>

    <span class="n">transform_net</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Matmul</span><span class="p">(</span>
        <span class="s1">&#39;cond_transform&#39;</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
            <span class="s1">&#39;prep_features&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ArgIdx</span><span class="p">(</span><span class="s1">&#39;arg0&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_BN</span><span class="p">(</span><span class="s1">&#39;bn&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_bn</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
            <span class="s1">&#39;compute_linear_transform&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ArgIdx</span><span class="p">(</span><span class="s1">&#39;arg1&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Squeeze</span><span class="p">(</span><span class="s1">&#39;squeeze&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">),</span>
            <span class="c1"># TODO(jngiam): Consider other configurations for FC dims here.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_FC</span><span class="p">(</span><span class="s1">&#39;fc0&#39;</span><span class="p">,</span> <span class="n">adims</span><span class="p">,</span> <span class="n">adims</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="n">use_bn</span><span class="p">,</span>
                     <span class="n">activation_fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">),</span>
            <span class="c1"># We use identity for the output since we want the transformation</span>
            <span class="c1"># matrix to have negative values too.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_FC</span><span class="p">(</span><span class="s1">&#39;fc1&#39;</span><span class="p">,</span> <span class="n">adims</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">idims</span> <span class="o">*</span> <span class="n">odims</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="n">use_bn</span><span class="p">,</span>
                     <span class="n">activation_fn</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">identity</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFn</span><span class="p">(</span><span class="s1">&#39;reshape&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">_ReshapeTransform</span><span class="p">)))</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">transform_net</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">use_bn</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Bias</span><span class="p">(</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="n">odims</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Activation</span><span class="p">(</span><span class="s1">&#39;activation&#39;</span><span class="p">,</span> <span class="n">activation_fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._GINCondFC"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._GINCondFC">[docs]</a>  <span class="k">def</span> <span class="nf">_GINCondFC</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">adims</span><span class="p">,</span> <span class="n">odims</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">activation_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Join</span><span class="p">(</span><span class="s1">&#39;join&#39;</span><span class="p">,</span> <span class="n">lhs</span><span class="p">,</span> <span class="n">rhs</span><span class="p">),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_CondFC</span><span class="p">(</span><span class="s1">&#39;cond_fc&#39;</span><span class="p">,</span> <span class="n">idims</span><span class="p">,</span> <span class="n">adims</span><span class="p">,</span> <span class="n">odims</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="n">use_bn</span><span class="p">,</span>
                     <span class="n">activation_fn</span><span class="o">=</span><span class="n">activation_fn</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._GIN"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._GIN">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapPointsTensor</span>
  <span class="k">def</span> <span class="nf">_GIN</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
           <span class="n">name</span><span class="p">,</span>
           <span class="n">mlp_dims</span><span class="p">,</span>
           <span class="n">aggregate_sub</span><span class="p">,</span>
           <span class="n">readout_sub</span><span class="p">,</span>
           <span class="n">combine_method</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">,</span>
           <span class="n">eps</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
           <span class="n">use_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Graph Isomorphism Network (GIN) [1].</span>

<span class="sd">    This implements the GIN network. The input goes through multiple</span>
<span class="sd">    GINIntermediateLayers which performs the update equation (eqn 4.1 in paper).</span>

<span class="sd">    The final network output is the concatenation of all the intermediate</span>
<span class="sd">    layer outputs (eqn 4.2 in paper), with readout aggregation being mean or</span>
<span class="sd">    max.</span>

<span class="sd">      output = concat([readout(f0), readout(f1),..., readout(fN)]),</span>
<span class="sd">      where f1 = intermediate_gin(g0), etc.</span>

<span class="sd">    This is akin to a DenseNet structure, where all the intermediate layers</span>
<span class="sd">    are short-circuited to the end.</span>

<span class="sd">    Using sum corresponds to the proposed method by [1], which enables learning</span>
<span class="sd">    graphs with repeated nodes. &#39;mean&#39; and &#39;max&#39; may confuse graphs with</span>
<span class="sd">    repeated nodes but could better capture distribution statistics or distinct</span>
<span class="sd">    elements.</span>

<span class="sd">    Note that eps=0 performs well in their results (Section 7).</span>

<span class="sd">    [1] How Powerful are Graph Neural Networks?</span>
<span class="sd">        Keyulu Xu, Weihua Hu, Jure Leskovec, Stefanie Jegelka. ICLR 2019.</span>
<span class="sd">        https://arxiv.org/abs/1810.00826</span>

<span class="sd">    Args:</span>
<span class="sd">      name: String layer name.</span>
<span class="sd">      mlp_dims: List of list of ints representing the intermediate feature MLPs.</span>
<span class="sd">        The first dim should match the dim of the input features. Each output</span>
<span class="sd">        dim of the MLP should match the next.</span>
<span class="sd">      aggregate_sub: Params for a layer that has padding-aware aggregation</span>
<span class="sd">        (e.g., PaddedMean, PaddedMax, PaddedSum). This is used by the</span>
<span class="sd">        intermediate layers.</span>
<span class="sd">      readout_sub: Params for a layer that has padding-aware aggregation</span>
<span class="sd">        (e.g., PaddedMean, PaddedMax, PaddedSum). This is used to aggregate</span>
<span class="sd">        the feature vectors for representing the entire graph.</span>
<span class="sd">      combine_method: Either &#39;add&#39;, &#39;concat&#39;, or &#39;cond_fc&#39;. This is used by the</span>
<span class="sd">        intermediate layers.</span>
<span class="sd">      eps: float scale parameter, see _GINIntermediateLayer for details.</span>
<span class="sd">      use_bn: Whether to enable batch norm in intermediate FC layers.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for this layer. This layer expects a `NestedMap` with points,</span>
<span class="sd">      features, and padding.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">combine_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="s1">&#39;concat&#39;</span><span class="p">,</span> <span class="s1">&#39;cond_fc&#39;</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected combine method: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">combine_method</span><span class="p">))</span>

    <span class="c1"># Validate mlp_dims; every adjacent MLP should have a matching number of</span>
    <span class="c1"># channels.</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="p">(</span><span class="n">mlp_i</span><span class="p">,</span> <span class="n">mlp_o</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">mlp_dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">mlp_dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
      <span class="n">prev_layer_dims</span> <span class="o">=</span> <span class="n">mlp_i</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">next_layer_dims</span> <span class="o">=</span> <span class="n">mlp_o</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="c1"># When concatenating, we expect the next layer to have double the input</span>
      <span class="c1"># channels.</span>
      <span class="k">if</span> <span class="n">combine_method</span> <span class="o">==</span> <span class="s1">&#39;concat&#39;</span><span class="p">:</span>
        <span class="n">prev_layer_dims</span> <span class="o">*=</span> <span class="mi">2</span>
      <span class="k">if</span> <span class="n">prev_layer_dims</span> <span class="o">!=</span> <span class="n">next_layer_dims</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;mlp_dims do not match (</span><span class="si">{}</span><span class="s1"> != </span><span class="si">{}</span><span class="s1">) at layer </span><span class="si">{}</span><span class="s1"> &#39;</span>
            <span class="s1">&#39;with dims: </span><span class="si">{}</span><span class="s1"> and </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">idx</span><span class="p">,</span> <span class="n">prev_layer_dims</span><span class="p">,</span> <span class="n">next_layer_dims</span><span class="p">,</span> <span class="n">mlp_i</span><span class="p">,</span> <span class="n">mlp_o</span><span class="p">))</span>

    <span class="c1"># Build the network recursively in a way that concats all the</span>
    <span class="c1"># intermediate outputs.</span>
    <span class="k">def</span> <span class="nf">_Build</span><span class="p">(</span><span class="n">depth</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlp_dims</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">readout_sub</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Concat</span><span class="p">(</span>
            <span class="s1">&#39;gin_concat&#39;</span><span class="p">,</span>
            <span class="n">readout_sub</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
                <span class="s1">&#39;seq&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_GINIntermediateLayer</span><span class="p">(</span>
                    <span class="s1">&#39;gin_intermediate&#39;</span><span class="p">,</span>
                    <span class="n">mlp_dims</span><span class="p">[</span><span class="n">depth</span><span class="p">],</span>
                    <span class="n">aggregate_sub</span><span class="p">,</span>
                    <span class="n">combine_method</span><span class="p">,</span>
                    <span class="n">eps</span><span class="p">,</span>
                    <span class="n">use_bn</span><span class="p">),</span>
                <span class="n">_Build</span><span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="n">p</span> <span class="o">=</span> <span class="n">_Build</span><span class="p">(</span><span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModelBuilderBase._GINIntermediateLayer"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._GINIntermediateLayer">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapPointsTensor</span>
  <span class="k">def</span> <span class="nf">_GINIntermediateLayer</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">name</span><span class="p">,</span>
      <span class="n">dims</span><span class="p">,</span>
      <span class="n">aggregate_sub</span><span class="p">,</span>
      <span class="n">combine_method</span><span class="o">=</span><span class="s1">&#39;add&#39;</span><span class="p">,</span>
      <span class="n">eps</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
      <span class="n">use_bn</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implements an intermediate GIN layer.</span>

<span class="sd">    This layer takes in a `NestedMap` and produces a `NestedMap` that contains</span>
<span class="sd">    points, features, and padding.</span>

<span class="sd">    Given features f_i for each point i, compute new features f&#39;_i:</span>

<span class="sd">      f&#39;_i = MLP((1 + eps) * f_i + aggregate(f_j))  where j are neighbors of i</span>

<span class="sd">    Note: This layer aggregates over the entire point cloud, not just the</span>
<span class="sd">    neighbors. In practice, aggregation over the neighbors can be done by having</span>
<span class="sd">    pre-grouping the points before invoking this layer.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: String layer name.</span>
<span class="sd">      dims: List of int dims for the MLP layer.</span>
<span class="sd">      aggregate_sub: Params for a layer that has padding-aware aggregation</span>
<span class="sd">        (e.g., PaddedMean, PaddedMax, PaddedSum).</span>
<span class="sd">      combine_method: Either &#39;add&#39;, &#39;concat&#39;, or &#39;cond_fc&#39;. Add follows the</span>
<span class="sd">        paper suggestion of adding the aggregated feature to each point. Concat</span>
<span class="sd">        broadcasts the aggregated features and concats it to each point. Cond_FC</span>
<span class="sd">        computes an example-dependent linear transformation; this is similar to</span>
<span class="sd">        T-Net.</span>
<span class="sd">      eps: float scale parameter, see equation above for details.</span>
<span class="sd">      use_bn: Whether to enable batch norm in FC layers.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for this layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">combine_method_to_fn</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;add&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Add</span><span class="p">,</span>
        <span class="s1">&#39;concat&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_BroadcastConcat</span><span class="p">,</span>
        <span class="s1">&#39;cond_fc&#39;</span><span class="p">:</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_GINCondFC</span><span class="p">,</span>
            <span class="n">idims</span><span class="o">=</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">odims</span><span class="o">=</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">adims</span><span class="o">=</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="n">use_bn</span><span class="o">=</span><span class="n">use_bn</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">combine_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">combine_method_to_fn</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unexpected combine method: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">combine_method</span><span class="p">))</span>
    <span class="n">combine_fn</span> <span class="o">=</span> <span class="n">combine_method_to_fn</span><span class="p">[</span><span class="n">combine_method</span><span class="p">]</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_SeqToKey</span><span class="p">(</span>
            <span class="s1">&#39;map_features&#39;</span><span class="p">,</span>
            <span class="n">FEATURES_KEY</span><span class="p">,</span>
            <span class="n">combine_fn</span><span class="p">(</span>
                <span class="s1">&#39;combine&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
                    <span class="s1">&#39;left&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_features&#39;</span><span class="p">,</span> <span class="n">FEATURES_KEY</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFn</span><span class="p">(</span><span class="s1">&#39;eps_scale&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
                    <span class="s1">&#39;right&#39;</span><span class="p">,</span>
                    <span class="n">aggregate_sub</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFn</span><span class="p">(</span><span class="s1">&#39;expand_dims&#39;</span><span class="p">,</span>
                                  <span class="n">fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">2</span><span class="p">))))),</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FeaturesMLP</span><span class="p">(</span><span class="s1">&#39;mlp&#39;</span><span class="p">,</span> <span class="n">dims</span><span class="p">,</span> <span class="n">use_bn</span><span class="o">=</span><span class="n">use_bn</span><span class="p">))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._ConcatPointsToFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._ConcatPointsToFeatures">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapPointsTensor</span>
  <span class="k">def</span> <span class="nf">_ConcatPointsToFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SeqToKey</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">FEATURES_KEY</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Concat</span><span class="p">(</span>
            <span class="s1">&#39;concat&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_points&#39;</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_features&#39;</span><span class="p">,</span> <span class="n">FEATURES_KEY</span><span class="p">)))</span></div>

<div class="viewcode-block" id="ModelBuilderBase._SetAbstraction"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._SetAbstraction">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapPointsTensor</span>
  <span class="k">def</span> <span class="nf">_SetAbstraction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">name</span><span class="p">,</span>
                      <span class="n">feature_extraction_sub</span><span class="p">,</span>
                      <span class="n">num_samples</span><span class="p">,</span>
                      <span class="n">group_size</span><span class="p">,</span>
                      <span class="n">ball_radius</span><span class="p">,</span>
                      <span class="n">sample_neighbors_uniformly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set abstraction layer that samples, groups points, and featurizes groups.</span>

<span class="sd">    This is based on PointNet++ concept of set abstractions.</span>

<span class="sd">    This layer samples `num_samples` points using Farthest Point Sampling</span>
<span class="sd">    algorithm. For each sampled point, it forms a group of size `group_size`</span>
<span class="sd">    consisting the points within the distance of `ball_radius` from the sampled</span>
<span class="sd">    point.</span>

<span class="sd">    It then applies the feature_extraction_sub to the extracted groups, note</span>
<span class="sd">    that the tensors passed to the feature_extraction_sub will have leading</span>
<span class="sd">    shapes corresponding to [batch_size, num_query_points, num_points_per_group,</span>
<span class="sd">    ...].</span>

<span class="sd">    A simple feature_extraction_sub that does a MLP followed by max pooling</span>
<span class="sd">    on the grouped points could be composed using FeaturesMLP and PaddedMax.</span>

<span class="sd">    This layer expects a NestedMap of points, features, and padding; it produces</span>
<span class="sd">    a corresponding NestedMap with updated points, features, and padding.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: name for the layer.</span>
<span class="sd">      feature_extraction_sub: Params for a layer that takes in a NestedMap of</span>
<span class="sd">        points, features, and padding. These tensors correspond to grouped</span>
<span class="sd">        points. Note that the leading shape of these tensors are [batch_size,</span>
<span class="sd">        num_query_points, num_points_per_group, ...]. This layer should produce</span>
<span class="sd">        a single tensor representing the features computed by summarizing the</span>
<span class="sd">        grouped points.</span>
<span class="sd">      num_samples: Number of points to be sampled.</span>
<span class="sd">      group_size: Number neighbours for each sampled point.</span>
<span class="sd">      ball_radius: The distance around each sampled point to obtain neighbours.</span>
<span class="sd">      sample_neighbors_uniformly: Whether to sample neighbors uniformly within</span>
<span class="sd">        the ball radius.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for Set Abstraction layer based on PointNet++.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="n">car_layers</span><span class="o">.</span><span class="n">SamplingAndGroupingLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span><span class="o">.</span><span class="n">Set</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sample_group&#39;</span><span class="p">,</span>
            <span class="n">num_samples</span><span class="o">=</span><span class="n">num_samples</span><span class="p">,</span>
            <span class="n">ball_radius</span><span class="o">=</span><span class="n">ball_radius</span><span class="p">,</span>
            <span class="n">group_size</span><span class="o">=</span><span class="n">group_size</span><span class="p">,</span>
            <span class="n">sample_neighbors_uniformly</span><span class="o">=</span><span class="n">sample_neighbors_uniformly</span><span class="p">),</span>
        <span class="c1"># Output of sampling and grouping is a NestedMap of grouped_points and</span>
        <span class="c1"># query_points. `query_points` is a nestedmap consists of the sampled</span>
        <span class="c1"># points and padding. `grouped_points` consists of the groups around the</span>
        <span class="c1"># sampled points, corresponding features and padding.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ParMap</span><span class="p">(</span>
            <span class="s1">&#39;pmap&#39;</span><span class="p">,</span>
            <span class="nb">dict</span><span class="p">(</span>
                <span class="n">points</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;seq_points&#39;</span><span class="p">,</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;query_points&#39;</span><span class="p">),</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">)),</span>
                <span class="n">features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
                    <span class="s1">&#39;seq_features&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;grouped_points&#39;</span><span class="p">),</span>
                    <span class="n">feature_extraction_sub</span><span class="p">),</span>
                <span class="n">padding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span><span class="s1">&#39;seq_padding&#39;</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;query_points&#39;</span><span class="p">),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;p&#39;</span><span class="p">,</span> <span class="s1">&#39;padding&#39;</span><span class="p">)),</span>
            <span class="p">)))</span>  <span class="c1"># pyformat: disable</span></div>

<div class="viewcode-block" id="ModelBuilderBase._PointConvParametricConv"><a class="viewcode-back" href="../../../../lingvo.tasks.car.builder_lib.html#lingvo.tasks.car.builder_lib.ModelBuilderBase._PointConvParametricConv">[docs]</a>  <span class="nd">@_Decorators</span><span class="o">.</span><span class="n">ExpectsNestedMapPointsTensor</span>
  <span class="k">def</span> <span class="nf">_PointConvParametricConv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">name</span><span class="p">,</span>
                               <span class="n">mlp_dims</span><span class="p">,</span>
                               <span class="n">num_in_channels</span><span class="p">,</span>
                               <span class="n">num_out_channels</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parametric convolution based on PointConv.</span>

<span class="sd">    Note that this layer assumes that the features have already been weighted</span>
<span class="sd">    by density. This layer follows Figure 5. in [1] but without the initial</span>
<span class="sd">    inverse density scale weighting part. When working with range images,</span>
<span class="sd">    one can use RIScaleFeaturesByDensity to scale the features beforehand.</span>

<span class="sd">    [1] PointConv: Deep Convolutional Networks on 3D Point Clouds. CVPR 2019.</span>
<span class="sd">        Wu, Wenxuan and Qi, Zhongang and Fuxin, Li.</span>

<span class="sd">    Args:</span>
<span class="sd">      name: string name for this layer.</span>
<span class="sd">      mlp_dims: dims for mlp applied to the points. the first dimension of</span>
<span class="sd">        mlp_dims must be 3.</span>
<span class="sd">      num_in_channels: integer number of input channels (features)</span>
<span class="sd">      num_out_channels: integer number of output channels (features).</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params for a parametric conv layer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mlp_dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;First dimension of mlp_dims must be 3. mlp_dims=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mlp_dims</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_CombineLastTwoDims</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])])</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
        <span class="n">name</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_Par</span><span class="p">(</span>
            <span class="s1">&#39;transpose_matmul&#39;</span><span class="p">,</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">transpose_a</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="c1"># Features [..., points, num_in_channels].</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_features&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_Seq</span><span class="p">(</span>
                <span class="s1">&#39;transform_points&#39;</span><span class="p">,</span>
                <span class="c1"># Map points into features to use FeaturesMLP which is padding</span>
                <span class="c1"># batchnorm aware.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_SeqToKey</span><span class="p">(</span>
                    <span class="s1">&#39;points_as_features&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_points&#39;</span><span class="p">,</span> <span class="s1">&#39;points&#39;</span><span class="p">)),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_FeaturesMLP</span><span class="p">(</span><span class="s1">&#39;points_mlp&#39;</span><span class="p">,</span> <span class="n">mlp_dims</span><span class="p">),</span>
                <span class="c1"># Output of this should be [..., points, mlp_dims[-1]].</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_GetValue</span><span class="p">(</span><span class="s1">&#39;get_transformed_points&#39;</span><span class="p">,</span> <span class="s1">&#39;features&#39;</span><span class="p">))),</span>
        <span class="c1"># Post transform_matmul, should be [..., num_in_channels, mlp_dims[-1]].</span>
        <span class="c1"># Note: The paper&#39;s use of conv is equivalent to reshaping so that the</span>
        <span class="c1"># last two dims are combined together.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyFn</span><span class="p">(</span><span class="s1">&#39;reshape&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">_CombineLastTwoDims</span><span class="p">),</span>
        <span class="c1"># TODO(jngiam): Consider handling batch norm carefully here, not all</span>
        <span class="c1"># center points have valid values.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_FC</span><span class="p">(</span><span class="s1">&#39;fc&#39;</span><span class="p">,</span> <span class="n">num_in_channels</span> <span class="o">*</span> <span class="n">mlp_dims</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">num_out_channels</span><span class="p">))</span></div></div>
<span class="c1"># pyformat: enable</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2018.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>