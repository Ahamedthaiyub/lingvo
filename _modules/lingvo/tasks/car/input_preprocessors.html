

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lingvo.tasks.car.input_preprocessors &mdash; Lingvo  documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home" alt="Documentation Home"> Lingvo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../lingvo.html">lingvo package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Lingvo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>lingvo.tasks.car.input_preprocessors</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lingvo.tasks.car.input_preprocessors</h1><div class="highlight"><pre>
<span></span><span class="c1"># Lint as: python3</span>
<span class="c1"># Copyright 2019 The TensorFlow Authors. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1"># ==============================================================================</span>
<span class="sd">&quot;&quot;&quot;Input preprocessors.&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">lingvo</span> <span class="kn">import</span> <span class="n">compat</span> <span class="k">as</span> <span class="n">tf</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">base_layer</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">py_utils</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">schedule</span>
<span class="kn">from</span> <span class="nn">lingvo.tasks.car</span> <span class="kn">import</span> <span class="n">car_lib</span>
<span class="kn">from</span> <span class="nn">lingvo.tasks.car</span> <span class="kn">import</span> <span class="n">detection_3d_lib</span>
<span class="kn">from</span> <span class="nn">lingvo.tasks.car</span> <span class="kn">import</span> <span class="n">geometry</span>
<span class="kn">from</span> <span class="nn">lingvo.tasks.car</span> <span class="kn">import</span> <span class="n">ops</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># pylint:disable=g-direct-tensorflow-import</span>
<span class="kn">from</span> <span class="nn">tensorflow.python.ops</span> <span class="kn">import</span> <span class="n">inplace_ops</span>
<span class="c1"># pylint:enable=g-direct-tensorflow-import</span>


<div class="viewcode-block" id="_ConsistentShuffle"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors._ConsistentShuffle">[docs]</a><span class="k">def</span> <span class="nf">_ConsistentShuffle</span><span class="p">(</span><span class="n">tensors</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Shuffle multiple tensors with the same shuffle order.&quot;&quot;&quot;</span>
  <span class="n">shuffled_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tensors</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">shuffled_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">shuffled_idx</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
  <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">shuffled_idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tensors</span><span class="p">])</span></div>


<div class="viewcode-block" id="_GetApplyPointMaskFn"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors._GetApplyPointMaskFn">[docs]</a><span class="k">def</span> <span class="nf">_GetApplyPointMaskFn</span><span class="p">(</span><span class="n">points_mask</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns a function that applies a mask to one of our points tensors.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">_ApplyPointMaskFn</span><span class="p">(</span><span class="n">points_tensor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Applies a mask to the points tensor.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">points_tensor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">points_tensor</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_tensor</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">_ApplyPointMaskFn</span></div>


<div class="viewcode-block" id="_Dense"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors._Dense">[docs]</a><span class="k">def</span> <span class="nf">_Dense</span><span class="p">(</span><span class="n">sparse</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">sparse_to_dense</span><span class="p">(</span>
      <span class="n">sparse_indices</span><span class="o">=</span><span class="n">sparse</span><span class="o">.</span><span class="n">indices</span><span class="p">,</span>
      <span class="n">output_shape</span><span class="o">=</span><span class="n">sparse</span><span class="o">.</span><span class="n">dense_shape</span><span class="p">,</span>
      <span class="n">sparse_values</span><span class="o">=</span><span class="n">sparse</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
      <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="Preprocessor"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.Preprocessor">[docs]</a><span class="k">class</span> <span class="nc">Preprocessor</span><span class="p">(</span><span class="n">base_layer</span><span class="o">.</span><span class="n">BaseLayer</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Base class for input preprocessor.</span>

<span class="sd">  Input preprocessors expect the combined output of all extractors and performs</span>
<span class="sd">  a transformation on them. Input preprocessors can add/edit/remove fields</span>
<span class="sd">  from the NestedMap of features.</span>

<span class="sd">  Note: Features correspond to that for one example (no batch dimension).</span>

<span class="sd">  Sub-classes need to implement the following three functions:</span>

<span class="sd">  1) TransformFeatures(features): Given a NestedMap of features representing the</span>
<span class="sd">     output of all the extractors, apply a transformation on the features.</span>

<span class="sd">  2) TransformShapes(shapes): Given a corresponding NestedMap of shapes,</span>
<span class="sd">     produce a NestedMap of shapes that corresponds to the transformation of the</span>
<span class="sd">     features after TransformFeatures.</span>

<span class="sd">  3) TransformDTypes(dtypes): Given a corresponding NestedMap of dtypes,</span>
<span class="sd">     produce a NestedMap of dtypes that corresponds to the transformation of the</span>
<span class="sd">     features after TransformFeatures.</span>

<span class="sd">  The preprocessor is expected to explicitly pass through untouched fields.</span>
<span class="sd">  For example, a preprocessor that does data augmentation should modify the</span>
<span class="sd">  features NestedMap on the fields it cares about augmenting, and then return</span>
<span class="sd">  the features NestedMap.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Preprocessor.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.Preprocessor.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default params.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="Preprocessor.FProp"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.Preprocessor.FProp">[docs]</a>  <span class="k">def</span> <span class="nf">FProp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs TransformFeatures.&quot;&quot;&quot;</span>
    <span class="k">del</span> <span class="n">theta</span>  <span class="c1"># unused</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">TransformFeatures</span><span class="p">(</span><span class="n">features</span><span class="p">)</span></div>

<div class="viewcode-block" id="Preprocessor.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.Preprocessor.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transforms the features for one example.</span>

<span class="sd">    Args:</span>
<span class="sd">      features: A `NestedMap` of tensors.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A `NestedMap` of tensors corresponding.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Preprocessor.TransformBatchedFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.Preprocessor.TransformBatchedFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformBatchedFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transforms the features for a batch of examples.</span>

<span class="sd">    Args:</span>
<span class="sd">      features: A `NestedMap` of batched tensors.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A `NestedMap` of tensors corresponding.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dtypes</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">dtypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TransformDTypes</span><span class="p">(</span><span class="n">dtypes</span><span class="p">)</span>
    <span class="c1"># Default impl uses map_fn.</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TransformFeatures</span><span class="p">,</span> <span class="n">elems</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">,</span> <span class="n">back_prop</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Preprocessor.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.Preprocessor.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets correct shapes corresponding to TransformFeatures.</span>

<span class="sd">    Args:</span>
<span class="sd">      shapes: A `NestedMap` of TensorShapes, corresponding to the</span>
<span class="sd">        pre-transformed features.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A `NestedMap` of TensorShapes corresponding to the transformed features.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="Preprocessor.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.Preprocessor.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sets correct dtypes corresponding to TransformFeatures.</span>

<span class="sd">    Args:</span>
<span class="sd">      dtypes: A `NestedMap` of DTypes, corresponding to the pre-transformed</span>
<span class="sd">        features.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A `NestedMap` of DTypes corresponding to the transformed features.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="EntryPreprocessor"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.EntryPreprocessor">[docs]</a><span class="k">class</span> <span class="nc">EntryPreprocessor</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A Preprocessor that transforms a NestedMap sub-structure.</span>

<span class="sd">  Some preprocessors want to apply a function to any NestedMap whose key matches</span>
<span class="sd">  a specific prefix. An EntryPreprocessor provides an interface for specifying</span>
<span class="sd">  the function transformation for a NestedMap of inputs, adding, modifying, or</span>
<span class="sd">  deleting the entries in that NestedMap.</span>

<span class="sd">  For example, if an input contains a nested structure such as:</span>
<span class="sd">    - lasers.front.xyz</span>
<span class="sd">                  .features</span>
<span class="sd">    - lasers.side.xyz</span>
<span class="sd">                 .features</span>

<span class="sd">  and one wants to apply a transform that modifies the .xyz features</span>
<span class="sd">  on both structures, one can define an EntryPreprocessor that implements:</span>

<span class="sd">    UpdateEntry(entry):</span>
<span class="sd">    UpdateEntryShape(shapes):</span>
<span class="sd">    UpdateEntryDType(dtypes):</span>

<span class="sd">  and set self.params.prefixes = [&#39;lasers.front&#39;, &#39;lasers.side&#39;]</span>
<span class="sd">  where the prefixes refer to a fully-qualified NestedMap sub-structure.</span>

<span class="sd">  The arguments to these functions will contain just the NestedMap structure</span>
<span class="sd">    whose key prefix can be found in self.params.prefixes.  One can then modify</span>
<span class="sd">    these structures as desired.</span>

<span class="sd">  Example:</span>
<span class="sd">    def UpdateEntry(self, entry):</span>
<span class="sd">       # entry is a NestedMap.</span>
<span class="sd">       assert &#39;xyz&#39; in entry</span>
<span class="sd">       entry.xyz = self._ApplyFn(entry.xyz)</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EntryPreprocessor.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.EntryPreprocessor.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;prefixes&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;pseudo_ri&#39;</span><span class="p">],</span> <span class="s1">&#39;List of keys to apply to.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="EntryPreprocessor._ApplyToMatchingStructure"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.EntryPreprocessor._ApplyToMatchingStructure">[docs]</a>  <span class="k">def</span> <span class="nf">_ApplyToMatchingStructure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nested_map</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply fn to any NestedMap sub-structure whose prefix is in p.prefixes.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="c1"># Don&#39;t mutate the original.</span>
    <span class="n">nested_map</span> <span class="o">=</span> <span class="n">nested_map</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">()</span>
    <span class="n">updated_entries</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">prefixes</span><span class="p">:</span>
      <span class="n">entry</span> <span class="o">=</span> <span class="n">nested_map</span><span class="o">.</span><span class="n">GetItem</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Prefix key </span><span class="si">{}</span><span class="s1"> selected a </span><span class="si">{}</span><span class="s1">, not a NestedMap!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">prefix</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">entry</span><span class="p">)))</span>
      <span class="n">fn</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
      <span class="n">updated_entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nested_map</span><span class="p">,</span> <span class="n">updated_entries</span></div>

<div class="viewcode-block" id="EntryPreprocessor.UpdateEntry"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.EntryPreprocessor.UpdateEntry">[docs]</a>  <span class="k">def</span> <span class="nf">UpdateEntry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the Tensors in a NestedMap entry.</span>

<span class="sd">    Args:</span>
<span class="sd">      entry: A NestedMap of Tensors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="EntryPreprocessor.UpdateEntryShape"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.EntryPreprocessor.UpdateEntryShape">[docs]</a>  <span class="k">def</span> <span class="nf">UpdateEntryShape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the shapes in a NestedMap entry.</span>

<span class="sd">    Args:</span>
<span class="sd">      shapes: A NestedMap of TensorShapes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="EntryPreprocessor.UpdateEntryDType"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.EntryPreprocessor.UpdateEntryDType">[docs]</a>  <span class="k">def</span> <span class="nf">UpdateEntryDType</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Transform the dtypes in a NestedMap entry.</span>

<span class="sd">    Args:</span>
<span class="sd">      dtypes: A NestedMap of dtypes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="EntryPreprocessor.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.EntryPreprocessor.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">features</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyToMatchingStructure</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">UpdateEntry</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="EntryPreprocessor.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.EntryPreprocessor.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">shapes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyToMatchingStructure</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">UpdateEntryShape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="EntryPreprocessor.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.EntryPreprocessor.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyToMatchingStructure</span><span class="p">(</span><span class="n">dtypes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">UpdateEntryDType</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="CreateDecoderCopy"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.CreateDecoderCopy">[docs]</a><span class="k">class</span> <span class="nc">CreateDecoderCopy</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Creates references to current lasers, images, and labels.</span>

<span class="sd">  This is useful if the data is further transformed.</span>

<span class="sd">  If desired, the keys that are copied can be customized by overriding the</span>
<span class="sd">  default keys param.</span>

<span class="sd">  This preprocessor expects features to optionally contain the following keys:</span>
<span class="sd">  - lasers - a NestedMap of tensors</span>
<span class="sd">  - images - a NestedMap of tensors</span>
<span class="sd">  - labels - a NestedMap of tensors</span>

<span class="sd">  Adds the following features (if the features existed):</span>
<span class="sd">    - decoder_copy.lasers - a copy of the lasers NestedMap</span>
<span class="sd">    - decoder_copy.images - a copy of the images NestedMap</span>
<span class="sd">    - decoder_copy.labels - a copy of the labels NestedMap</span>

<span class="sd">  The processor also by default pads the laser features; this can be disabled</span>
<span class="sd">  by setting the pad_lasers param to None.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CreateDecoderCopy.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.CreateDecoderCopy.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;keys&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;lasers&#39;</span><span class="p">,</span> <span class="s1">&#39;labels&#39;</span><span class="p">,</span> <span class="s1">&#39;images&#39;</span><span class="p">],</span>
             <span class="s1">&#39;Keys to look for and copy if exists.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;parent_key&#39;</span><span class="p">,</span> <span class="s1">&#39;decoder_copy&#39;</span><span class="p">,</span> <span class="s1">&#39;The key to nest the copies under.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;pad_lasers&#39;</span><span class="p">,</span> <span class="n">PadLaserFeatures</span><span class="o">.</span><span class="n">Params</span><span class="p">(),</span>
             <span class="s1">&#39;Params for a layer that pads the laser features.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;create_decoder_copy&#39;</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">pad_lasers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">CreateChild</span><span class="p">(</span><span class="s1">&#39;pad_lasers&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pad_lasers</span><span class="p">)</span>

<div class="viewcode-block" id="CreateDecoderCopy._DeepCopyIfExists"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.CreateDecoderCopy._DeepCopyIfExists">[docs]</a>  <span class="k">def</span> <span class="nf">_DeepCopyIfExists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">,</span> <span class="n">nested_map</span><span class="p">,</span> <span class="n">parent_key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Deep copy a specific key to a parent key if it exists.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">nested_map</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">parent_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nested_map</span><span class="p">:</span>
          <span class="n">nested_map</span><span class="p">[</span><span class="n">parent_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
        <span class="n">nested_map</span><span class="p">[</span><span class="n">parent_key</span><span class="p">][</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">nested_map</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">nested_map</span></div>

<div class="viewcode-block" id="CreateDecoderCopy.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.CreateDecoderCopy.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DeepCopyIfExists</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">parent_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">pad_lasers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">features</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">parent_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_lasers</span><span class="o">.</span><span class="n">TransformFeatures</span><span class="p">(</span>
          <span class="n">features</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">parent_key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="CreateDecoderCopy.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.CreateDecoderCopy.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DeepCopyIfExists</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">parent_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">pad_lasers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">shapes</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">parent_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_lasers</span><span class="o">.</span><span class="n">TransformShapes</span><span class="p">(</span>
          <span class="n">shapes</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">parent_key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="CreateDecoderCopy.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.CreateDecoderCopy.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">dtypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DeepCopyIfExists</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">parent_key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">pad_lasers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">dtypes</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">parent_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_lasers</span><span class="o">.</span><span class="n">TransformDTypes</span><span class="p">(</span>
          <span class="n">dtypes</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">parent_key</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="FilterByKey"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterByKey">[docs]</a><span class="k">class</span> <span class="nc">FilterByKey</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Filters features to keep only specified keys.</span>

<span class="sd">  This keeps only feature entries that are specified. This allows us to reduce</span>
<span class="sd">  the number of fields returned. For example, during training, one may not</span>
<span class="sd">  need the actual laser points if training with a pillars based model that</span>
<span class="sd">  has a preprocessor that already maps the points to grid.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FilterByKey.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterByKey.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;keep_key_prefixes&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">],</span> <span class="s1">&#39;Prefixes of keys to keep. If this &#39;</span>
        <span class="s1">&#39;contains the empty string, then it will keep all the keys.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="FilterByKey._FilterFn"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterByKey._FilterFn">[docs]</a>  <span class="k">def</span> <span class="nf">_FilterFn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">entry</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Filter a nested map.&quot;&quot;&quot;</span>
    <span class="k">del</span> <span class="n">entry</span>  <span class="c1"># unused</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_key_prefixes</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="FilterByKey.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterByKey.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">FilterKeyVal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FilterFn</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilterByKey.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterByKey.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span><span class="o">.</span><span class="n">FilterKeyVal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FilterFn</span><span class="p">)</span></div>

<div class="viewcode-block" id="FilterByKey.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterByKey.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">FilterKeyVal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_FilterFn</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="FilterGroundTruthByNumPoints"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterGroundTruthByNumPoints">[docs]</a><span class="k">class</span> <span class="nc">FilterGroundTruthByNumPoints</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Removes ground truth boxes with less than params.min_num_points points.</span>

<span class="sd">  This preprocessor expects features to contain the following keys::</span>
<span class="sd">    labels.labels of shape [..., L]</span>
<span class="sd">    labels.bboxes_3d of shape [..., L, 7]</span>
<span class="sd">    labels.bboxes_3d_mask of shape [..., L]</span>
<span class="sd">    labels.unfiltered_bboxes_3d_mask of shape [..., L]</span>
<span class="sd">    labels.bboxes_3d_num_points of shape [..., L].</span>

<span class="sd">  Modifies the bounding box data to turn off ground truth objects that don&#39;t</span>
<span class="sd">  meet the params.min_num_points point filter:</span>

<span class="sd">    labels.labels: Boxes with less than params.min_num_points have their label</span>
<span class="sd">    set to params.background_id (defaults to 0).</span>

<span class="sd">    labels.bboxes_3d_mask: Boxes with less than params.min_num_points are set</span>
<span class="sd">    to 0.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FilterGroundTruthByNumPoints.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterGroundTruthByNumPoints.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;min_num_points&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;The minimum number of points allowed before &#39;</span>
        <span class="s1">&#39;the associated ground truth box is turned off. Defaults to 1.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;background_id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;The ID of the background class we set &#39;</span>
        <span class="s1">&#39;filtered boxes to. Defaults to 0.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="FilterGroundTruthByNumPoints.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterGroundTruthByNumPoints.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">bbox_is_valid</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">greater_equal</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_num_points</span><span class="p">,</span>
                                     <span class="n">p</span><span class="o">.</span><span class="n">min_num_points</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">bbox_is_valid</span><span class="p">,</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">p</span><span class="o">.</span><span class="n">background_id</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span> <span class="o">*=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">bbox_is_valid</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="FilterGroundTruthByNumPoints.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterGroundTruthByNumPoints.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="FilterGroundTruthByNumPoints.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterGroundTruthByNumPoints.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="FilterGroundTruthByDifficulty"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterGroundTruthByDifficulty">[docs]</a><span class="k">class</span> <span class="nc">FilterGroundTruthByDifficulty</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Removes groundtruth boxes based on detection difficulty.</span>

<span class="sd">  This preprocessor expects features to contain the following keys::</span>
<span class="sd">    labels.single_frame_detection_difficulties of shape [..., L]</span>
<span class="sd">    labels.labels of shape [..., L]</span>
<span class="sd">    labels.bboxes_3d_mask of shape [..., L]</span>
<span class="sd">    labels.unfiltered_bboxes_3d_mask of shape [..., L]</span>

<span class="sd">  The preprocessor masks out the bboxes_3d_mask / labels based on whether</span>
<span class="sd">  single_frame_detection_difficulties is greater than p.difficulty_threshold.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FilterGroundTruthByDifficulty.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterGroundTruthByDifficulty.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;background_id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;The ID of the background class we set &#39;</span>
        <span class="s1">&#39;filtered boxes to. Defaults to 0.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;difficulty_threshold&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;Filter groundtruth bounding boxes whose detection difficulty is &#39;</span>
        <span class="s1">&#39;greater than `difficulty_threshold`&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="FilterGroundTruthByDifficulty.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterGroundTruthByDifficulty.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">bbox_is_valid</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">less_equal</span><span class="p">(</span>
        <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">single_frame_detection_difficulties</span><span class="p">,</span>
        <span class="n">p</span><span class="o">.</span><span class="n">difficulty_threshold</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">bbox_is_valid</span><span class="p">,</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">p</span><span class="o">.</span><span class="n">background_id</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">labels</span><span class="p">))</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span> <span class="o">*=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">bbox_is_valid</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="FilterGroundTruthByDifficulty.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterGroundTruthByDifficulty.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="FilterGroundTruthByDifficulty.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FilterGroundTruthByDifficulty.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="CountNumberOfPointsInBoxes3D"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.CountNumberOfPointsInBoxes3D">[docs]</a><span class="k">class</span> <span class="nc">CountNumberOfPointsInBoxes3D</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes bboxes_3d_num_points.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - labels.bboxes_3d of shape [L, 7]</span>
<span class="sd">  - labels.bboxes_3d_mask of shape [L]</span>

<span class="sd">  and optionally points_padding of shape [P] corresponding to the padding.</span>
<span class="sd">  if points_padding is None, then all points are considered valid.</span>

<span class="sd">  Adds the following features:</span>
<span class="sd">    labels.bboxes_3d_num_points: [L] - integer tensor containing the number of</span>
<span class="sd">      laser points for each corresponding bbox.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CountNumberOfPointsInBoxes3D.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.CountNumberOfPointsInBoxes3D.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span>
    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span>
      <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>

    <span class="n">points_in_bboxes_mask</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">IsWithinBBox3D</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span>
                                                    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">)</span>
    <span class="n">bboxes_3d_num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">points_in_bboxes_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">bboxes_3d_num_points</span> <span class="o">*=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_num_points</span> <span class="o">=</span> <span class="n">bboxes_3d_num_points</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="CountNumberOfPointsInBoxes3D.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.CountNumberOfPointsInBoxes3D.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">num_bboxes</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">num_bboxes</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="CountNumberOfPointsInBoxes3D.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.CountNumberOfPointsInBoxes3D.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="AddPerPointLabels"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.AddPerPointLabels">[docs]</a><span class="k">class</span> <span class="nc">AddPerPointLabels</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Computes the class and bbox id of each point.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - labels.bboxes_3d of shape [L, 7]</span>
<span class="sd">  - labels.labels of shape [L]</span>

<span class="sd">  This makes an assumption that each point is only in 1 box, which should</span>
<span class="sd">  almost always true in 3D. In cases where this is not true, the largest</span>
<span class="sd">  label integer and largest bbox_id will be assigned.</span>

<span class="sd">  NOTE: Be very careful that this is performed after any modifications</span>
<span class="sd">  to the semantic labels of each point in the pointcloud. Examples of this</span>
<span class="sd">  would be operators like GroundTruthAugmentation, or DropBoxesOutOfRange.</span>

<span class="sd">  Adds the following features:</span>
<span class="sd">    lasers.points_label: [P] - integer tensor containing the class id of each</span>
<span class="sd">      point.</span>
<span class="sd">    lasers.points_bbox_id: [P] - integer tensor containing box id of each</span>
<span class="sd">      point from 0 to num_bboxes, where an id of num_bboxes indicates a</span>
<span class="sd">      background point.</span>
<span class="sd">    lasers.points_bbox_3d: [P, 7] - float tensor containing bounding box of</span>
<span class="sd">      each point.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AddPerPointLabels.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.AddPerPointLabels.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;per_dimension_adjustment&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;A list of len 3 of floats with the amount (in meters) to add to &#39;</span>
        <span class="s1">&#39;each dimension of the box before using it to select points. &#39;</span>
        <span class="s1">&#39;If enabled, this is designed to protect against overly tight box &#39;</span>
        <span class="s1">&#39;annotations that appear in KITTI.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="AddPerPointLabels.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.AddPerPointLabels.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span>
    <span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span>
    <span class="n">num_points</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">)</span>
    <span class="n">num_bboxes</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">bboxes_3d</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">per_dimension_adjustment</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">per_dimension_adjustment</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;param `per_dimension_adjustment` expected to be len 3.&#39;</span><span class="p">)</span>
      <span class="n">dims_adjustment</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">per_dimension_adjustment</span> <span class="o">+</span>
                                    <span class="p">[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">bboxes_3d</span> <span class="o">+</span> <span class="n">dims_adjustment</span>

    <span class="c1"># Find which points are in each box and what class each box is.</span>
    <span class="n">points_in_bboxes_mask</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">IsWithinBBox3D</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">bboxes_3d</span><span class="p">)</span>
    <span class="n">points_in_bboxes_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">points_in_bboxes_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">points_in_bboxes_mask</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">points_in_bboxes_mask</span><span class="p">,</span>
                                              <span class="p">[</span><span class="n">num_points</span><span class="p">,</span> <span class="n">num_bboxes</span><span class="p">])</span>

    <span class="c1"># points_in_bboxes_mask is a [num_points, num_bboxes] 0/1 tensor</span>
    <span class="c1"># indicating whether that point is in a given box.</span>
    <span class="c1"># Each point should only be in one box, so after broadcasting the label</span>
    <span class="c1"># across the binary mask, we do a reduce_max to get the max label id</span>
    <span class="c1"># for each point. Since each point only belongs to one box, it will be</span>
    <span class="c1"># the only non-zero (background) label in that box.</span>
    <span class="c1"># Note: We assume background to be class_id == 0</span>
    <span class="n">points_label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span>
        <span class="n">points_in_bboxes_mask</span> <span class="o">*</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">points_bbox_id</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
        <span class="n">points_in_bboxes_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">output_type</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="c1"># If the class is background, make its id == num_bboxes</span>
    <span class="n">points_bbox_id</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">points_label</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">points_bbox_id</span><span class="p">,</span>
                              <span class="n">tf</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span><span class="n">num_bboxes</span><span class="p">,</span> <span class="p">[</span><span class="n">num_points</span><span class="p">]))</span>

    <span class="c1"># For each point, get the bbox_3d data.</span>
    <span class="n">dummy_bbox</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bboxes_3d</span><span class="p">,</span> <span class="n">dummy_bbox</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">points_bbox_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">bboxes_3d</span><span class="p">,</span> <span class="n">points_bbox_id</span><span class="p">)</span>

    <span class="n">points_label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">points_label</span><span class="p">,</span> <span class="p">[</span><span class="n">num_points</span><span class="p">])</span>
    <span class="n">points_bbox_id</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">points_bbox_id</span><span class="p">,</span> <span class="p">[</span><span class="n">num_points</span><span class="p">])</span>
    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_label</span> <span class="o">=</span> <span class="n">points_label</span>
    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_bbox_id</span> <span class="o">=</span> <span class="n">points_bbox_id</span>
    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_bbox_3d</span> <span class="o">=</span> <span class="n">points_bbox_3d</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="AddPerPointLabels.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.AddPerPointLabels.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">num_points</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">num_points</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_bbox_id</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">num_points</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_bbox_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">num_points</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="AddPerPointLabels.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.AddPerPointLabels.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_bbox_id</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_bbox_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="PointsToGrid"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PointsToGrid">[docs]</a><span class="k">class</span> <span class="nc">PointsToGrid</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Bins points to a 3D-grid using custom op: ops.point_to_grid.</span>

<span class="sd">  Expects features to have keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>

<span class="sd">  and optionally points_padding of shape [P] corresponding to the padding.</span>
<span class="sd">  if points_padding is None, then all points are considered valid.</span>

<span class="sd">  If normalizing the labels is enabled, then also expects:</span>
<span class="sd">  - labels.weights</span>
<span class="sd">  - labels.bboxes_td</span>
<span class="sd">  - labels.bboxes_td_mask</span>
<span class="sd">  - labels.bboxes_3d_mask</span>

<span class="sd">  Let:</span>
<span class="sd">    gx, gy, gz = p.grid_size</span>
<span class="sd">    F = 3 + num_laser_features</span>

<span class="sd">  Adds the following features:</span>
<span class="sd">    grid_centers: [gx, gy, gz, 3]: For each grid cell, the (x,y,z)</span>
<span class="sd">      floating point coordinate of its center.</span>
<span class="sd">    grid_num_points: [gx, gy, gz]: The number of points in each grid</span>
<span class="sd">      cell (integer).</span>
<span class="sd">    laser_grid: [gx, gy, gz, num_points_per_cell, F] - A 5D floating</span>
<span class="sd">      point Tensor containing the laser data placed into a fixed grid.</span>

<span class="sd">  Modifies the bboxes in labels to also be within the grid range x/y by default.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PointsToGrid.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PointsToGrid.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;num_points_per_cell&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span>
             <span class="s1">&#39;The maximum number of points per cell.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;grid_size&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;Grid size along x,y,z axis.&#39;</span><span class="p">)</span>

    <span class="c1"># The max range of x and y is [-80, 80].</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;grid_range_x&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="s1">&#39;The X-axis Range covered by the grid&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;grid_range_y&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">),</span> <span class="s1">&#39;The Y-axis Range covered by the grid&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;grid_range_z&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;The Z-axis Range covered by the grid&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;normalize_td_labels&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
             <span class="s1">&#39;Whether to clip the labels to the grid limits.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="PointsToGrid._NormalizeLabels"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PointsToGrid._NormalizeLabels">[docs]</a>  <span class="k">def</span> <span class="nf">_NormalizeLabels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Normalizes the bboxes within a given range.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">x_range</span><span class="p">,</span> <span class="s1">&#39;Must specify x_range if clipping.&#39;</span>
    <span class="k">assert</span> <span class="n">y_range</span><span class="p">,</span> <span class="s1">&#39;Must specify y_range if clipping.&#39;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;x_range </span><span class="si">%s</span><span class="s1"> must be 2 elements.&#39;</span> <span class="o">%</span> <span class="n">x_range</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;y_range </span><span class="si">%s</span><span class="s1"> must be 2 elements.&#39;</span> <span class="o">%</span> <span class="n">y_range</span>

    <span class="n">x_range_min</span> <span class="o">=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">x_range_len</span> <span class="o">=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_range_min</span> <span class="o">=</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">y_range_len</span> <span class="o">=</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">y_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">xmin</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">xmin</span> <span class="o">-</span> <span class="n">x_range_min</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">x_range_len</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">x_range_min</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">x_range_len</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">ymin</span> <span class="o">-</span> <span class="n">y_range_min</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">y_range_len</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">y_range_min</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">y_range_len</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmax</span></div>

<div class="viewcode-block" id="PointsToGrid.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PointsToGrid.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span>
    <span class="n">points_feature</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span>
    <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span> <span class="ow">and</span>
        <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span>
      <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>
      <span class="n">points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_feature</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>

    <span class="n">points_full</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_feature</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">points_grid_full</span><span class="p">,</span> <span class="n">grid_centers</span><span class="p">,</span> <span class="n">num_points</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">point_to_grid</span><span class="p">(</span>
        <span class="n">points_full</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_points_per_cell</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_size</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">p</span><span class="o">.</span><span class="n">grid_size</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_range_x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_range_y</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_range_z</span><span class="p">)</span>

    <span class="n">features</span><span class="o">.</span><span class="n">laser_grid</span> <span class="o">=</span> <span class="n">points_grid_full</span>
    <span class="n">features</span><span class="o">.</span><span class="n">grid_centers</span> <span class="o">=</span> <span class="n">grid_centers</span>
    <span class="n">features</span><span class="o">.</span><span class="n">grid_num_points</span> <span class="o">=</span> <span class="n">num_points</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">normalize_td_labels</span><span class="p">:</span>
      <span class="c1"># Normalize bboxes_td w.r.t grid range.</span>
      <span class="n">obb</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span>
      <span class="n">x_range</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_range_x</span>
      <span class="n">y_range</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_range_y</span>
      <span class="n">ymin</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span><span class="n">obb</span><span class="o">.</span><span class="n">bboxes_td</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">4</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">ymin</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_NormalizeLabels</span><span class="p">(</span>
          <span class="n">ymin</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">)</span>
      <span class="n">obb</span><span class="o">.</span><span class="n">bboxes_td</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
          <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ymin</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">xmax</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span> <span class="n">obb</span><span class="o">.</span><span class="n">bboxes_td</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">4</span><span class="p">:]],</span>
          <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="PointsToGrid.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PointsToGrid.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">grid_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">grid_num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grid_size</span><span class="p">))</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">laser_grid</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span>
        <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span> <span class="o">+</span>
        <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">num_points_per_cell</span><span class="p">,</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">shapes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="PointsToGrid.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PointsToGrid.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">grid_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">grid_num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">laser_grid</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="_PointPillarGridSettings"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors._PointPillarGridSettings">[docs]</a><span class="k">class</span> <span class="nc">_PointPillarGridSettings</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Settings for PointPillars model defined in paper.</span>

<span class="sd">  https://arxiv.org/abs/1812.05784</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="c1"># Chooses grid sizes that are a multiple of 16 to support point pillars</span>
  <span class="c1"># model requirements.  These also happen to match the values</span>
  <span class="c1"># in the PointPillars paper (voxel width of 0.16m in x, y)</span>
  <span class="n">GRID_X</span> <span class="o">=</span> <span class="mi">432</span>
  <span class="n">GRID_Y</span> <span class="o">=</span> <span class="mi">496</span>
  <span class="n">GRID_Z</span> <span class="o">=</span> <span class="mi">1</span>

  <span class="c1"># These fields are set in the subclasses.</span>
  <span class="n">GRID_X_RANGE</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">GRID_Y_RANGE</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="n">GRID_Z_RANGE</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="_PointPillarGridSettings.UpdateGridParams"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors._PointPillarGridSettings.UpdateGridParams">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">UpdateGridParams</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">grid_params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply PointPillars settings to grid_params.&quot;&quot;&quot;</span>
    <span class="n">grid_params</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">GRID_X</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">GRID_Y</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">GRID_Z</span><span class="p">)</span>
    <span class="n">grid_params</span><span class="o">.</span><span class="n">grid_range_x</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">GRID_X_RANGE</span>
    <span class="n">grid_params</span><span class="o">.</span><span class="n">grid_range_y</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">GRID_Y_RANGE</span>
    <span class="n">grid_params</span><span class="o">.</span><span class="n">grid_range_z</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">GRID_Z_RANGE</span></div>

<div class="viewcode-block" id="_PointPillarGridSettings.UpdateAnchorGridParams"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors._PointPillarGridSettings.UpdateAnchorGridParams">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">UpdateAnchorGridParams</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">anchor_params</span><span class="p">,</span> <span class="n">output_stride</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply PointPillars settings to anchor_params.&quot;&quot;&quot;</span>
    <span class="c1"># Set anchor settings to match grid settings.</span>
    <span class="c1"># Grid size for anchors is half the resolution.</span>
    <span class="n">anchor_params</span><span class="o">.</span><span class="n">grid_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">GRID_X</span> <span class="o">//</span> <span class="n">output_stride</span><span class="p">,</span>
                               <span class="bp">cls</span><span class="o">.</span><span class="n">GRID_Y</span> <span class="o">//</span> <span class="n">output_stride</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">GRID_Z</span><span class="p">)</span>
    <span class="n">anchor_params</span><span class="o">.</span><span class="n">grid_range_x</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">GRID_X_RANGE</span>
    <span class="n">anchor_params</span><span class="o">.</span><span class="n">grid_range_y</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">GRID_Y_RANGE</span>
    <span class="c1"># Grid along z axis should be pinned to 0.</span>
    <span class="n">anchor_params</span><span class="o">.</span><span class="n">grid_range_z</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MakeGridSettings"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.MakeGridSettings">[docs]</a><span class="k">def</span> <span class="nf">MakeGridSettings</span><span class="p">(</span><span class="n">grid_x_range</span><span class="p">,</span> <span class="n">grid_y_range</span><span class="p">,</span> <span class="n">grid_z_range</span><span class="p">,</span> <span class="n">grid_x</span><span class="p">,</span> <span class="n">grid_y</span><span class="p">,</span>
                     <span class="n">grid_z</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns configured class for PointPillar grid settings.&quot;&quot;&quot;</span>

  <span class="k">class</span> <span class="nc">GridSettings</span><span class="p">(</span><span class="n">_PointPillarGridSettings</span><span class="p">):</span>
    <span class="n">GRID_X_RANGE</span> <span class="o">=</span> <span class="n">grid_x_range</span>
    <span class="n">GRID_Y_RANGE</span> <span class="o">=</span> <span class="n">grid_y_range</span>
    <span class="n">GRID_Z_RANGE</span> <span class="o">=</span> <span class="n">grid_z_range</span>
    <span class="n">GRID_X</span> <span class="o">=</span> <span class="n">grid_x</span>
    <span class="n">GRID_Y</span> <span class="o">=</span> <span class="n">grid_y</span>
    <span class="n">GRID_Z</span> <span class="o">=</span> <span class="n">grid_z</span>

  <span class="k">return</span> <span class="n">GridSettings</span></div>


<span class="n">PointPillarGridCarSettings</span> <span class="o">=</span> <span class="n">MakeGridSettings</span><span class="p">(</span>
    <span class="n">grid_x_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">69.12</span><span class="p">),</span>
    <span class="n">grid_y_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">39.68</span><span class="p">,</span> <span class="mf">39.68</span><span class="p">),</span>
    <span class="n">grid_z_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
    <span class="n">grid_x</span><span class="o">=</span><span class="mi">432</span><span class="p">,</span>
    <span class="n">grid_y</span><span class="o">=</span><span class="mi">496</span><span class="p">,</span>
    <span class="n">grid_z</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">PointPillarGridPedCycSettings</span> <span class="o">=</span> <span class="n">MakeGridSettings</span><span class="p">(</span>
    <span class="n">grid_x_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">47.36</span><span class="p">),</span>
    <span class="n">grid_y_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">19.84</span><span class="p">,</span> <span class="mf">19.84</span><span class="p">),</span>
    <span class="n">grid_z_range</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
    <span class="n">grid_x</span><span class="o">=</span><span class="mi">432</span><span class="p">,</span>
    <span class="n">grid_y</span><span class="o">=</span><span class="mi">496</span><span class="p">,</span>
    <span class="n">grid_z</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>


<div class="viewcode-block" id="GridToPillars"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridToPillars">[docs]</a><span class="k">class</span> <span class="nc">GridToPillars</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create pillars from a grid of points.</span>

<span class="sd">  Expects features to have keys:</span>
<span class="sd">    grid_centers: [gx, gy, gz, 3]</span>

<span class="sd">    grid_num_points: [gx, gy, gz]</span>

<span class="sd">    laser_grid: [gx, gy, gz, num_points_per_cell, F]</span>

<span class="sd">  Adds the following features:</span>
<span class="sd">    point_count: [num_pillars]. The number of points in the pillar.</span>

<span class="sd">    point_locations: [num_pillars, 3]. The grid location of each pillar.</span>

<span class="sd">    pillar_points: [num_pillars, num_points_per_cell, F]. Points of each</span>
<span class="sd">    pillar.</span>

<span class="sd">  Drops the following features by default:</span>
<span class="sd">    laser_grid</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GridToPillars.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridToPillars.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;num_points_per_cell&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span>
             <span class="s1">&#39;The maximum number of points per cell.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;num_pillars&#39;</span><span class="p">,</span> <span class="mi">12000</span><span class="p">,</span> <span class="s1">&#39;The maximum number of pillars to produce.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;drop_laser_grid&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Whether to drop the laser_grid feature.&#39;</span><span class="p">)</span>
    <span class="c1"># The density based sampler is more expensive.</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;use_density_sampler&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
             <span class="s1">&#39;Use a density based sampler during pillar selection.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="GridToPillars._GumbelTransform"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridToPillars._GumbelTransform">[docs]</a>  <span class="k">def</span> <span class="nf">_GumbelTransform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">probs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds gumbel noise to log probabilities for multinomial sampling.</span>

<span class="sd">    This enables fast sampling from a multinomial distribution without</span>
<span class="sd">    replacement. See https://arxiv.org/abs/1611.01144 for details.</span>
<span class="sd">    A colab that demonstrates this in practice is here:</span>
<span class="sd">    http://colab/drive/1iuMt2n_r7dKPQG9T0UVMuK3fkbBayKjd</span>

<span class="sd">    Args:</span>
<span class="sd">      probs: A 1-D float tensor containing probabilities, summing to 1.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A 1-D float tensor of the same size of probs, with gumbel noise added to</span>
<span class="sd">      log probabilities. Taking the top k elements from this provides a</span>
<span class="sd">      multinomial sample without replacement.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">log_prob</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>
    <span class="n">probs_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>
    <span class="n">uniform_samples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="n">probs_shape</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">probs</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;uniform_samples&#39;</span><span class="p">)</span>
    <span class="n">gumbel_noise</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">uniform_samples</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">gumbel_noise</span> <span class="o">+</span> <span class="n">log_prob</span></div>

<div class="viewcode-block" id="GridToPillars._DensitySample"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridToPillars._DensitySample">[docs]</a>  <span class="k">def</span> <span class="nf">_DensitySample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_points</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="c1"># Flatten to [nx * ny * nz] for convenience during sampling.</span>
    <span class="n">num_grid_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>
    <span class="n">flattened_num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="p">[</span><span class="n">num_grid_points</span><span class="p">])</span>

    <span class="c1"># Normalize flattened_num_points to sum to 1.</span>
    <span class="n">flattened_num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">flattened_num_points</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">flattened_num_points</span> <span class="o">/=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">flattened_num_points</span><span class="p">)</span>

    <span class="c1"># TODO(jngiam): Consider generalizing this to enable other methods of</span>
    <span class="c1"># sampling: e.g., use largest deviation in z-axis. The gumbel transform</span>
    <span class="c1"># can still be applied regardless.</span>

    <span class="c1"># Add gumbel noise for multinomial sampling.</span>
    <span class="n">sampling_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GumbelTransform</span><span class="p">(</span><span class="n">flattened_num_points</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">locations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">top_k</span><span class="p">(</span>
        <span class="n">sampling_logits</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">num_pillars</span><span class="p">,</span> <span class="n">num_grid_points</span><span class="p">))</span>

    <span class="c1"># Unravel coordinates back to grid locations.</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span>

    <span class="c1"># Unravel index will return a 3 x num_locations tensor, this needs to be</span>
    <span class="c1"># transposed so that we have it as num_locations x 3.</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">locations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">locations</span></div>

<div class="viewcode-block" id="GridToPillars.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridToPillars.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">num_points</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">grid_num_points</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">use_density_sampler</span><span class="p">:</span>
      <span class="n">locations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DensitySample</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Select non-empty cells uniformly at random.</span>
      <span class="n">locations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">num_points</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

    <span class="n">num_features</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">laser_grid</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># [nx, ny, nz, np, 4] (x, y, z, f)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">laser_grid</span>
    <span class="c1"># [K, np, 4] (x, y, z, f)</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">locations</span><span class="p">)</span>
    <span class="c1"># [nx, ny, nz, 1, 3] (cx, cy, cz)</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">grid_centers</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>
    <span class="c1"># [K, 1, 3] (cx, cy, cz)</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="n">locations</span><span class="p">)</span>
    <span class="c1"># NOTE: If there are fewer pillars than p.num_pillars, the following</span>
    <span class="c1"># padding creates many &#39;fake&#39; pillars at grid cell (0, 0, 0) with</span>
    <span class="c1"># an all-zero pillar. Hopefully, the model can learn to ignore these.</span>
    <span class="c1">#</span>
    <span class="c1"># pillar_points[i, :, :] is the pillar located at pillar_locations[i, :3],</span>
    <span class="c1"># and pillar_points[i, :, :] == points_grid_full[pillar_locations[i, :3]].</span>
    <span class="c1">#   for 0 &lt;= i &lt; pillar_count;</span>
    <span class="c1"># pillar_locations[i, :3] are zero-ed, for i &gt;= pillar_count.</span>
    <span class="n">features</span><span class="o">.</span><span class="n">pillar_count</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">locations</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">features</span><span class="o">.</span><span class="n">pillar_locations</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">locations</span><span class="p">,</span>
                                                     <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">num_pillars</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">features</span><span class="o">.</span><span class="n">pillar_points</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
        <span class="n">points</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">num_pillars</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_points_per_cell</span><span class="p">,</span> <span class="n">num_features</span><span class="p">])</span>
    <span class="n">features</span><span class="o">.</span><span class="n">pillar_centers</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span>
                                                   <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">num_pillars</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">drop_laser_grid</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;laser_grid&#39;</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="GridToPillars.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridToPillars.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">num_features</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">laser_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">pillar_count</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">pillar_locations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">num_pillars</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">pillar_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span>
        <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">num_pillars</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_points_per_cell</span><span class="p">,</span> <span class="n">num_features</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">pillar_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">num_pillars</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">drop_laser_grid</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">shapes</span><span class="p">[</span><span class="s1">&#39;laser_grid&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="GridToPillars.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridToPillars.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">pillar_count</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">pillar_locations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">pillar_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">pillar_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">drop_laser_grid</span><span class="p">:</span>
      <span class="k">del</span> <span class="n">dtypes</span><span class="p">[</span><span class="s1">&#39;laser_grid&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="GridAnchorCenters"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridAnchorCenters">[docs]</a><span class="k">class</span> <span class="nc">GridAnchorCenters</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create anchor centers on a grid.</span>

<span class="sd">  Anchors are placed in the middle of each grid cell. For example, on a 2D grid</span>
<span class="sd">  range (0 -&gt; 10, 0 -&gt; 10) with a 10 x 5 grid size, the anchors will be placed</span>
<span class="sd">  at [(0.5, 1), (0.5, 3), ... , (9.5, 7), (9.5, 9)].</span>

<span class="sd">  Adds the following features:</span>
<span class="sd">    anchor_centers: [num_locations, 3] - Floating point output containing the</span>
<span class="sd">      center (x, y, z) locations for tiling anchor boxes.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GridAnchorCenters.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridAnchorCenters.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;grid_size&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;Grid size along x,y,z axis. This will &#39;</span>
        <span class="s1">&#39;be used to generate the anchor center locations. Note that this &#39;</span>
        <span class="s1">&#39;would likely be different from the grid_* parameters in &#39;</span>
        <span class="s1">&#39;LaserGridExtractor: the grid extractor may choose to extract &#39;</span>
        <span class="s1">&#39;points more densely. Instead, this should correspond to the &#39;</span>
        <span class="s1">&#39;model</span><span class="se">\&#39;</span><span class="s1">s prediction layer: the predicted anchor box residuals &#39;</span>
        <span class="s1">&#39;should match this grid.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;grid_range_x&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="s1">&#39;The x-axis range covered by the grid.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;grid_range_y&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">25</span><span class="p">),</span> <span class="s1">&#39;The y-axis range covered by the grid.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;grid_range_z&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="s1">&#39;The z-axis range covered by the grid.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="GridAnchorCenters.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridAnchorCenters.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">utils_3d</span> <span class="o">=</span> <span class="n">detection_3d_lib</span><span class="o">.</span><span class="n">Utils3D</span><span class="p">()</span>

    <span class="c1"># Compute the grid cell size and adjust the range sent to dense coordinates</span>
    <span class="c1"># by half a cell size so as to ensure that the anchors are placed in the</span>
    <span class="c1"># center of each grid cell.</span>
    <span class="n">grid_size_x</span><span class="p">,</span> <span class="n">grid_size_y</span><span class="p">,</span> <span class="n">grid_size_z</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_size</span>
    <span class="n">grid_cell_sizes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grid_range_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_range_x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">grid_size_x</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grid_range_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_range_y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">grid_size_y</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grid_range_z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">grid_range_z</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">grid_size_z</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">half_size_x</span><span class="p">,</span> <span class="n">half_size_y</span><span class="p">,</span> <span class="n">half_size_z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">grid_cell_sizes</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>

    <span class="n">grid_shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">utils_3d</span><span class="o">.</span><span class="n">CreateDenseCoordinates</span><span class="p">([</span>
        <span class="p">[</span>
            <span class="n">p</span><span class="o">.</span><span class="n">grid_range_x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">half_size_x</span><span class="p">,</span>
            <span class="n">p</span><span class="o">.</span><span class="n">grid_range_x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">half_size_x</span><span class="p">,</span>
            <span class="n">grid_size_x</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="n">p</span><span class="o">.</span><span class="n">grid_range_y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">half_size_y</span><span class="p">,</span>
            <span class="n">p</span><span class="o">.</span><span class="n">grid_range_y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">half_size_y</span><span class="p">,</span>
            <span class="n">grid_size_y</span>
        <span class="p">],</span>
        <span class="p">[</span>
            <span class="n">p</span><span class="o">.</span><span class="n">grid_range_z</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">half_size_z</span><span class="p">,</span>
            <span class="n">p</span><span class="o">.</span><span class="n">grid_range_z</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">half_size_z</span><span class="p">,</span>
            <span class="n">grid_size_z</span>
        <span class="p">],</span>
    <span class="p">])</span>  <span class="c1"># pyformat: disable</span>
    <span class="n">features</span><span class="o">.</span><span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">anchor_centers</span><span class="p">,</span> <span class="n">grid_shape</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="GridAnchorCenters.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridAnchorCenters.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">grid_size</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="GridAnchorCenters.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GridAnchorCenters.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="SparseCenterSelector"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCenterSelector">[docs]</a><span class="k">class</span> <span class="nc">SparseCenterSelector</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Select centers for anchors and cells.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>

<span class="sd">  and optionally points_padding of shape [P] corresponding to the padding.</span>
<span class="sd">  if points_padding is None, then all points are considered valid.</span>

<span class="sd">  If lasers.num_seeded_points of shape [] is provided, it indicates that the</span>
<span class="sd">  first num_seeded_points of lasers.points_xyz should be used as seeds for</span>
<span class="sd">  farthest point sampling (e.g., always chosen).  Currently the concept</span>
<span class="sd">  of seeding is not implemented for anything but farthest point sampling.</span>

<span class="sd">  Adds the following features:</span>
<span class="sd">    anchor_centers: [num_cell_centers, 3] - Floating point output containing the</span>
<span class="sd">      center (x, y, z) locations for tiling anchor boxes.</span>
<span class="sd">    cell_center_xyz: [num_cell_centers, 3] - Floating point output containing</span>
<span class="sd">      the center (x, y, z) locations for each cell to featurize.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_SAMPLING_METHODS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;farthest_point&#39;</span><span class="p">,</span> <span class="s1">&#39;random_uniform&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="SparseCenterSelector.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCenterSelector.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;num_cell_centers&#39;</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="s1">&#39;Number of centers.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;features_preparation_layers&#39;</span><span class="p">,</span> <span class="p">[],</span>
        <span class="s1">&#39;A list of Params for layers to run on the features before &#39;</span>
        <span class="s1">&#39;performing farthest point sampling. For example, one may wish to &#39;</span>
        <span class="s1">&#39;drop points out of frustum for KITTI before selecting centers. &#39;</span>
        <span class="s1">&#39;Note that these layers will not mutate the original features, &#39;</span>
        <span class="s1">&#39;instead, a copy will be made.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;sampling_method&#39;</span><span class="p">,</span> <span class="s1">&#39;farthest_point&#39;</span><span class="p">,</span>
        <span class="s1">&#39;Which sampling method to use. One of </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_SAMPLING_METHODS</span><span class="p">))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;fix_z_to_zero&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Whether to fix z to 0 when retrieving the &#39;</span>
        <span class="s1">&#39;center xyz coordinates.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sampling_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SAMPLING_METHODS</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Param `sampling_method` must be one of </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_SAMPLING_METHODS</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">features_preparation_layers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">CreateChildren</span><span class="p">(</span><span class="s1">&#39;features_preparation_layers&#39;</span><span class="p">,</span>
                          <span class="n">p</span><span class="o">.</span><span class="n">features_preparation_layers</span><span class="p">)</span>

<div class="viewcode-block" id="SparseCenterSelector._FarthestPointSampleCenters"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCenterSelector._FarthestPointSampleCenters">[docs]</a>  <span class="k">def</span> <span class="nf">_FarthestPointSampleCenters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points_xyz</span><span class="p">,</span> <span class="n">num_seeded_points</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Samples centers with Farthest Point Sampling.</span>

<span class="sd">    Args:</span>
<span class="sd">      points_xyz: An unpadded tf.float32 Tensor of shape [P, 3] with per point</span>
<span class="sd">        (x, y, z) locations. We expect any padded points to be removed before</span>
<span class="sd">        this function is called.</span>
<span class="sd">      num_seeded_points: integer indicating how many of the first</span>
<span class="sd">        num_seeded_points points in points_xyz should be considered</span>
<span class="sd">        as seeds for FPS (always chosen).</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tf.float32 Tensor of shape [p.num_cell_centers, 3] with selected centers</span>
<span class="sd">      to use as anchors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">points_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_points</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">padded_num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">)</span>

    <span class="c1"># Pad both the points and padding if for some reason the input pointcloud</span>
    <span class="c1"># has less points than p.num_cell_centers.</span>
    <span class="n">points_xy</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="n">padded_num_points</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">points_padding</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
        <span class="n">points_padding</span><span class="p">,</span> <span class="p">[</span><span class="n">padded_num_points</span><span class="p">],</span> <span class="n">pad_val</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

    <span class="n">sampled_idx</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">car_lib</span><span class="o">.</span><span class="n">FarthestPointSampler</span><span class="p">(</span>
        <span class="n">points_xy</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">points_padding</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span>
        <span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">,</span>
        <span class="n">num_seeded_points</span><span class="o">=</span><span class="n">num_seeded_points</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
    <span class="n">sampled_idx</span> <span class="o">=</span> <span class="n">sampled_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>

    <span class="c1"># Gather centers.</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">fix_z_to_zero</span><span class="p">:</span>
      <span class="n">centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">points_xy</span><span class="p">,</span> <span class="n">sampled_idx</span><span class="p">),</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
      <span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># pyformat: disable</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">sampled_idx</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">centers</span></div>

<div class="viewcode-block" id="SparseCenterSelector._RandomUniformSampleCenters"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCenterSelector._RandomUniformSampleCenters">[docs]</a>  <span class="k">def</span> <span class="nf">_RandomUniformSampleCenters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points_xyz</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Samples centers with Random Uniform Sampling.</span>

<span class="sd">    Args:</span>
<span class="sd">      points_xyz: An unpadded tf.float32 Tensor of shape [P, 3] with per point</span>
<span class="sd">        (x, y, z) locations. We expect any padded points to be removed before</span>
<span class="sd">        this function is called.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tf.float32 Tensor of shape [p.num_cell_centers, 3] with selected centers</span>
<span class="sd">      to use as anchors.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="c1"># We want the center Z value to be 0 so just exclude it</span>
    <span class="n">centers_xy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
    <span class="n">selected_centers_xy</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">centers_xy</span><span class="p">,</span>
                                               <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">selected_centers_xy</span><span class="p">,</span>
                      <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">,</span> <span class="mi">1</span><span class="p">))],</span>
                     <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="SparseCenterSelector._SampleCenters"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCenterSelector._SampleCenters">[docs]</a>  <span class="k">def</span> <span class="nf">_SampleCenters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points_xyz</span><span class="p">,</span> <span class="n">num_seeded_points</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sampling_method</span> <span class="o">==</span> <span class="s1">&#39;farthest_point&#39;</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FarthestPointSampleCenters</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">num_seeded_points</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">sampling_method</span> <span class="o">==</span> <span class="s1">&#39;random_uniform&#39;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">num_seeded_points</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
            <span class="s1">&#39;Random sampling with seeded points not yet implemented.&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RandomUniformSampleCenters</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Param `sampling_method` must be one of </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_SAMPLING_METHODS</span><span class="p">))</span></div>

<div class="viewcode-block" id="SparseCenterSelector.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCenterSelector.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">prepared_features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">prep_layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_preparation_layers</span><span class="p">:</span>
      <span class="n">prepared_features</span> <span class="o">=</span> <span class="n">prep_layer</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">prepared_features</span><span class="p">)</span>

    <span class="n">num_seeded_points</span> <span class="o">=</span> <span class="n">prepared_features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_seeded_points&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">points_data</span> <span class="o">=</span> <span class="n">prepared_features</span><span class="o">.</span><span class="n">lasers</span>

    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">points_data</span><span class="o">.</span><span class="n">points_xyz</span>
    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">points_data</span><span class="p">:</span>
      <span class="n">points_padding</span> <span class="o">=</span> <span class="n">points_data</span><span class="o">.</span><span class="n">points_padding</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">points_padding</span>
      <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>

    <span class="n">centers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SampleCenters</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">num_seeded_points</span><span class="p">)</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="n">features</span><span class="o">.</span><span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">centers</span>
    <span class="n">features</span><span class="o">.</span><span class="n">cell_center_xyz</span> <span class="o">=</span> <span class="n">centers</span>

    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="SparseCenterSelector.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCenterSelector.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">cell_center_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="SparseCenterSelector.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCenterSelector.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">cell_center_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="SparseCellGatherFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellGatherFeatures">[docs]</a><span class="k">class</span> <span class="nc">SparseCellGatherFeatures</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Select local features for each cell.</span>

<span class="sd">  This preprocessor expects features to contain:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - lasers.points_feature of shape [P, F]</span>
<span class="sd">  - cell_center_xyz of shape [C, 3]</span>

<span class="sd">  and optionally points_padding of shape [P] corresponding to the padding.</span>
<span class="sd">  if points_padding is None, then all points are considered valid.</span>

<span class="sd">  Adds the following features:</span>
<span class="sd">    cell_points_xyz: [num_centers, num_points_per_cell, 3] - Floating point</span>
<span class="sd">      output containing the (x, y, z) locations for each point for a given</span>
<span class="sd">      center.</span>
<span class="sd">    cell_feature: [num_centers, num_points_per_cell, F] - Floating point output</span>
<span class="sd">      containing the features for each point for a given center.</span>
<span class="sd">    cell_points_padding: [num_centers, num_points_per_cell] - 0/1 padding</span>
<span class="sd">      for the points in each cell.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SparseCellGatherFeatures.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellGatherFeatures.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;num_points_per_cell&#39;</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="s1">&#39;The number of points per cell.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;max_distance&#39;</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="s1">&#39;Max distance of point to cell center.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;sample_neighbors_uniformly&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;Whether to sample the neighbor points for every cell center &#39;</span>
        <span class="s1">&#39;uniformly at random. If False, this will default to selecting by &#39;</span>
        <span class="s1">&#39;distance.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="SparseCellGatherFeatures.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellGatherFeatures.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">num_centers</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">cell_center_xyz</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_features</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span>
    <span class="n">points_feature</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span>
    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span>
      <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>
      <span class="n">points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_feature</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>

    <span class="c1"># Note: points_xyz and points_feature must be unpadded as we pass</span>
    <span class="c1"># padding=None to neighborhood indices. Ensuring that it is unpadded</span>
    <span class="c1"># helps improve performance.</span>

    <span class="c1"># Get nearby points using kNN.</span>
    <span class="n">sample_indices</span><span class="p">,</span> <span class="n">sample_indices_padding</span> <span class="o">=</span> <span class="n">car_lib</span><span class="o">.</span><span class="n">NeighborhoodIndices</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">cell_center_xyz</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">p</span><span class="o">.</span><span class="n">num_points_per_cell</span><span class="p">,</span>
        <span class="n">points_padding</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_distance</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_distance</span><span class="p">,</span>
        <span class="n">sample_neighbors_uniformly</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">sample_neighbors_uniformly</span><span class="p">)</span>

    <span class="c1"># Take first example since NeighboorhoodIndices expects batch dimension.</span>
    <span class="n">sample_indices</span> <span class="o">=</span> <span class="n">sample_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>
    <span class="n">sample_indices_padding</span> <span class="o">=</span> <span class="n">sample_indices_padding</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span>

    <span class="n">sample_indices</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">sample_indices</span><span class="p">,</span>
                                       <span class="p">[</span><span class="n">num_centers</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_points_per_cell</span><span class="p">])</span>

    <span class="n">cell_points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">sample_indices</span><span class="p">)</span>
    <span class="n">cell_points_xyz</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">cell_points_xyz</span><span class="p">,</span>
                                        <span class="p">[</span><span class="n">num_centers</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_points_per_cell</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="n">cell_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">points_feature</span><span class="p">,</span> <span class="n">sample_indices</span><span class="p">)</span>
    <span class="n">cell_feature</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span>
        <span class="n">cell_feature</span><span class="p">,</span> <span class="p">[</span><span class="n">num_centers</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_points_per_cell</span><span class="p">,</span> <span class="n">num_features</span><span class="p">])</span>

    <span class="n">cell_points_padding</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span>
        <span class="n">sample_indices_padding</span><span class="p">,</span> <span class="p">[</span><span class="n">num_centers</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_points_per_cell</span><span class="p">])</span>

    <span class="n">features</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;cell_points_xyz&#39;</span><span class="p">:</span> <span class="n">cell_points_xyz</span><span class="p">,</span>
        <span class="s1">&#39;cell_feature&#39;</span><span class="p">:</span> <span class="n">cell_feature</span><span class="p">,</span>
        <span class="s1">&#39;cell_points_padding&#39;</span><span class="p">:</span> <span class="n">cell_points_padding</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="SparseCellGatherFeatures.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellGatherFeatures.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">num_centers</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">cell_center_xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">base_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">num_centers</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_points_per_cell</span><span class="p">]</span>
    <span class="n">num_features</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">cell_points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="n">base_shape</span> <span class="o">+</span> <span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">cell_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="n">base_shape</span> <span class="o">+</span> <span class="p">[</span><span class="n">num_features</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">cell_points_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="n">base_shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="SparseCellGatherFeatures.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellGatherFeatures.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">cell_points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">cell_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">cell_points_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="SparseCellCentersTopK"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellCentersTopK">[docs]</a><span class="k">class</span> <span class="nc">SparseCellCentersTopK</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Given selected centers and gathered points/features, apply a filter.</span>

<span class="sd">  This preprocessor expects features to contain `cell_center_xyz` and all</span>
<span class="sd">  entries in params.features_to_modify, and that the leading dimension should</span>
<span class="sd">  all be the same (num_cell_centers from SparseCenterSelector).</span>

<span class="sd">  We then modify all values in features that are specified in</span>
<span class="sd">  params.features_to_modify by sorting them with the specified sort function</span>
<span class="sd">  (specified by params.sort_by) operating on features.cell_center_xyz, and then</span>
<span class="sd">  taking the top K (specified by params.num_cell_centers) along the first</span>
<span class="sd">  dimension.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">_REGISTERED_SORT_FUNCTIONS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span>

<div class="viewcode-block" id="SparseCellCentersTopK.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellCentersTopK.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;num_cell_centers&#39;</span><span class="p">,</span> <span class="mi">512</span><span class="p">,</span> <span class="s1">&#39;The number of centers after filtering.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;sort_by&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="s1">&#39;A string specifying which sort function &#39;</span>
        <span class="s1">&#39;to use. Currently we just support `distance`.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;features_to_modify&#39;</span><span class="p">,</span> <span class="p">[</span>
        <span class="s1">&#39;cell_center_xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;anchor_centers&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_points_xyz&#39;</span><span class="p">,</span> <span class="s1">&#39;cell_feature&#39;</span><span class="p">,</span>
        <span class="s1">&#39;cell_points_padding&#39;</span>
    <span class="p">],</span> <span class="s1">&#39;A list of keys from the features dict to modify.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sort_by</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REGISTERED_SORT_FUNCTIONS</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> not supported. We only support </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">p</span><span class="o">.</span><span class="n">sort_by</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_REGISTERED_SORT_FUNCTIONS</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">features_to_modify</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Need to modify at least one feature.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="SparseCellCentersTopK._SortByDistance"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellCentersTopK._SortByDistance">[docs]</a>  <span class="k">def</span> <span class="nf">_SortByDistance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">cell_center_xyz</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dist</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;ASCENDING&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SparseCellCentersTopK._Sort"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellCentersTopK._Sort">[docs]</a>  <span class="k">def</span> <span class="nf">_Sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">sort_by</span> <span class="o">==</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SortByDistance</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unsupported sort function: </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">sort_by</span><span class="p">))</span></div>

<div class="viewcode-block" id="SparseCellCentersTopK.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellCentersTopK.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">sort_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Sort</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>
    <span class="n">sort_indices_top_k</span> <span class="o">=</span> <span class="n">sort_indices</span><span class="p">[:</span><span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>

    <span class="c1"># Gather each of the relevant items</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">features_to_modify</span><span class="p">:</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
      <span class="n">output_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
      <span class="n">features</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">features</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">sort_indices_top_k</span><span class="p">),</span> <span class="n">output_shape</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="SparseCellCentersTopK.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellCentersTopK.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">features_to_modify</span><span class="p">:</span>
      <span class="n">shapes</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">num_cell_centers</span><span class="p">]</span> <span class="o">+</span> <span class="n">shapes</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="SparseCellCentersTopK.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCellCentersTopK.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="TileAnchorBBoxes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.TileAnchorBBoxes">[docs]</a><span class="k">class</span> <span class="nc">TileAnchorBBoxes</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Creates anchor_bboxes given anchor_centers.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - anchor_centers of shape [...base shape..., 3]</span>

<span class="sd">  Adds the following features:</span>
<span class="sd">    anchor_bboxes: base_shape + [7] - Floating point anchor box</span>
<span class="sd">      output containing the anchor boxes and the 7 floating point</span>
<span class="sd">      values for each box that define the box (x, y, z, dx, dy, dz, phi).</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TileAnchorBBoxes.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.TileAnchorBBoxes.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;anchor_box_dimensions&#39;</span><span class="p">,</span> <span class="p">[],</span>
             <span class="s1">&#39;List of anchor box sizes per center.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;anchor_box_offsets&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">&#39;List of anchor box offsets per center.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;anchor_box_rotations&#39;</span><span class="p">,</span> <span class="p">[],</span>
             <span class="s1">&#39;List of anchor box rotations per center.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="TileAnchorBBoxes.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.TileAnchorBBoxes.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">utils_3d</span> <span class="o">=</span> <span class="n">detection_3d_lib</span><span class="o">.</span><span class="n">Utils3D</span><span class="p">()</span>

    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">anchor_box_dimensions</span>
    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">anchor_box_offsets</span>
    <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">anchor_box_rotations</span>

    <span class="n">base_shape</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">anchor_centers</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">num_box_per_center</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">anchor_box_dimensions</span><span class="p">)</span>

    <span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">anchor_centers</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">anchor_bboxes</span> <span class="o">=</span> <span class="n">utils_3d</span><span class="o">.</span><span class="n">MakeAnchorBoxes</span><span class="p">(</span>
        <span class="n">anchor_centers</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">anchor_box_dimensions</span><span class="p">),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">anchor_box_offsets</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">identity</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">anchor_box_rotations</span><span class="p">))</span>
    <span class="n">features</span><span class="o">.</span><span class="n">anchor_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">anchor_bboxes</span><span class="p">,</span>
                                        <span class="n">base_shape</span> <span class="o">+</span> <span class="p">[</span><span class="n">num_box_per_center</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="TileAnchorBBoxes.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.TileAnchorBBoxes.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">base_shape</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">anchor_centers</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">num_box_per_center</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">anchor_box_dimensions</span><span class="p">)</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">anchor_bboxes</span> <span class="o">=</span> <span class="n">base_shape</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">num_box_per_center</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="TileAnchorBBoxes.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.TileAnchorBBoxes.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">anchor_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="_AnchorBoxSettings"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors._AnchorBoxSettings">[docs]</a><span class="k">class</span> <span class="nc">_AnchorBoxSettings</span><span class="p">:</span>
  <span class="sd">&quot;&quot;&quot;Helper class to parameterize and update anchor box settings.&quot;&quot;&quot;</span>
  <span class="c1"># Implementations should fill out the following class members.</span>
  <span class="n">DIMENSION_PRIORS</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">ROTATIONS</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">CENTER_X_OFFSETS</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">CENTER_Y_OFFSETS</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">CENTER_Z_OFFSETS</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="_AnchorBoxSettings.NumAnchors"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors._AnchorBoxSettings.NumAnchors">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">NumAnchors</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">([</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">DIMENSION_PRIORS</span><span class="p">),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">ROTATIONS</span><span class="p">),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">CENTER_X_OFFSETS</span><span class="p">),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">CENTER_Y_OFFSETS</span><span class="p">),</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">CENTER_Z_OFFSETS</span><span class="p">)</span>
    <span class="p">])</span></div>

<div class="viewcode-block" id="_AnchorBoxSettings.GenerateAnchorSettings"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors._AnchorBoxSettings.GenerateAnchorSettings">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">GenerateAnchorSettings</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate anchor settings.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A `NestedMap` containing three lists of the same length:</span>
<span class="sd">        - anchor_box_dimensions</span>
<span class="sd">        - anchor_box_rotations</span>
<span class="sd">        - anchor_box_offsets</span>

<span class="sd">      These can be used with the TileAnchorBBoxes preprocessor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">anchor_box_dimensions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">anchor_box_rotations</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">anchor_box_offsets</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># The following is equivalent to a formulation of itertools.product, but</span>
    <span class="c1"># is explicitly listed for readability.</span>

    <span class="c1"># *Please note*: The ordering is important for ModelV2, which makes</span>
    <span class="c1"># assumptions that the offset dimensions come first.</span>
    <span class="k">for</span> <span class="n">cx</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">CENTER_X_OFFSETS</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">cy</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">CENTER_Y_OFFSETS</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cz</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">CENTER_Z_OFFSETS</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">rot</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">ROTATIONS</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dims</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">DIMENSION_PRIORS</span><span class="p">:</span>
              <span class="n">anchor_box_dimensions</span> <span class="o">+=</span> <span class="p">[</span><span class="n">dims</span><span class="p">]</span>
              <span class="n">anchor_box_rotations</span> <span class="o">+=</span> <span class="p">[</span><span class="n">rot</span><span class="p">]</span>
              <span class="n">anchor_box_offsets</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cz</span><span class="p">)]</span>

    <span class="c1"># Check one of the lists has entries.</span>
    <span class="k">assert</span> <span class="n">anchor_box_dimensions</span>

    <span class="k">return</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
        <span class="n">anchor_box_dimensions</span><span class="o">=</span><span class="n">anchor_box_dimensions</span><span class="p">,</span>
        <span class="n">anchor_box_rotations</span><span class="o">=</span><span class="n">anchor_box_rotations</span><span class="p">,</span>
        <span class="n">anchor_box_offsets</span><span class="o">=</span><span class="n">anchor_box_offsets</span><span class="p">)</span></div>

<div class="viewcode-block" id="_AnchorBoxSettings.Update"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors._AnchorBoxSettings.Update">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Update</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Updates anchor box settings from input configuration lists.</span>

<span class="sd">    Given dimensions priors, rotations, and offsets, computes the cartesian</span>
<span class="sd">    product of the settings.</span>

<span class="sd">    Args:</span>
<span class="sd">      params: The KITTIAnchorExtractorBase.Params() object to update.</span>

<span class="sd">    Returns:</span>
<span class="sd">      Params updated with the anchor settings.</span>

<span class="sd">      In total there are N combinations, where each (anchor_box_dimensions[i],</span>
<span class="sd">        anchor_box_rotations[i], anchor_box_offsets[i]) for i in range(N) is an</span>
<span class="sd">        option.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">params</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">GenerateAnchorSettings</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">anchor_box_dimensions</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">anchor_box_dimensions</span>
    <span class="n">p</span><span class="o">.</span><span class="n">anchor_box_rotations</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">anchor_box_rotations</span>
    <span class="n">p</span><span class="o">.</span><span class="n">anchor_box_offsets</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">anchor_box_offsets</span>
    <span class="k">return</span> <span class="n">p</span></div></div>


<div class="viewcode-block" id="MakeAnchorBoxSettings"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.MakeAnchorBoxSettings">[docs]</a><span class="k">def</span> <span class="nf">MakeAnchorBoxSettings</span><span class="p">(</span><span class="n">dimension_priors</span><span class="p">,</span> <span class="n">rotations</span><span class="p">,</span> <span class="n">center_x_offsets</span><span class="p">,</span>
                          <span class="n">center_y_offsets</span><span class="p">,</span> <span class="n">center_z_offsets</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns a configured class for setting anchor box settings.&quot;&quot;&quot;</span>

  <span class="k">class</span> <span class="nc">CustomAnchorBoxSettings</span><span class="p">(</span><span class="n">_AnchorBoxSettings</span><span class="p">):</span>
    <span class="n">DIMENSION_PRIORS</span> <span class="o">=</span> <span class="n">dimension_priors</span>
    <span class="n">ROTATIONS</span> <span class="o">=</span> <span class="n">rotations</span>
    <span class="n">CENTER_X_OFFSETS</span> <span class="o">=</span> <span class="n">center_x_offsets</span>
    <span class="n">CENTER_Y_OFFSETS</span> <span class="o">=</span> <span class="n">center_y_offsets</span>
    <span class="n">CENTER_Z_OFFSETS</span> <span class="o">=</span> <span class="n">center_z_offsets</span>

  <span class="k">return</span> <span class="n">CustomAnchorBoxSettings</span></div>


<div class="viewcode-block" id="SparseCarV1AnchorBoxSettings"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseCarV1AnchorBoxSettings">[docs]</a><span class="k">class</span> <span class="nc">SparseCarV1AnchorBoxSettings</span><span class="p">(</span><span class="n">_AnchorBoxSettings</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Anchor box settings for training on Cars for Sparse models.&quot;&quot;&quot;</span>
  <span class="c1"># Borrowed from PointPillar dimension prior for cars.</span>
  <span class="n">DIMENSION_PRIORS</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">1.6</span><span class="p">,</span> <span class="mf">3.9</span><span class="p">,</span> <span class="mf">1.56</span><span class="p">)]</span>

  <span class="c1"># 4 Rotations with axis aligned and both diagonals.</span>
  <span class="n">ROTATIONS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span>

  <span class="c1"># 25 offsets per anchor box with fixed z offset at -1.</span>
  <span class="n">CENTER_X_OFFSETS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
  <span class="n">CENTER_Y_OFFSETS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
  <span class="n">CENTER_Z_OFFSETS</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">]</span></div>


<div class="viewcode-block" id="PointPillarAnchorBoxSettingsCar"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PointPillarAnchorBoxSettingsCar">[docs]</a><span class="k">class</span> <span class="nc">PointPillarAnchorBoxSettingsCar</span><span class="p">(</span><span class="n">_AnchorBoxSettings</span><span class="p">):</span>
  <span class="n">DIMENSION_PRIORS</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">1.6</span><span class="p">,</span> <span class="mf">3.9</span><span class="p">,</span> <span class="mf">1.56</span><span class="p">)]</span>
  <span class="n">ROTATIONS</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span>
  <span class="c1"># Fixed offset for every anchor box, based on a reading of the paper / code</span>
  <span class="c1"># 0 offsets for x and y, and -1 for z.</span>
  <span class="n">CENTER_X_OFFSETS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
  <span class="n">CENTER_Y_OFFSETS</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span>
  <span class="n">CENTER_Z_OFFSETS</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">]</span></div>


<div class="viewcode-block" id="PointPillarAnchorBoxSettingsPed"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PointPillarAnchorBoxSettingsPed">[docs]</a><span class="k">class</span> <span class="nc">PointPillarAnchorBoxSettingsPed</span><span class="p">(</span><span class="n">PointPillarAnchorBoxSettingsCar</span><span class="p">):</span>
  <span class="n">DIMENSION_PRIORS</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.73</span><span class="p">)]</span>
  <span class="n">CENTER_Z_OFFSETS</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.6</span><span class="p">]</span></div>


<div class="viewcode-block" id="PointPillarAnchorBoxSettingsCyc"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PointPillarAnchorBoxSettingsCyc">[docs]</a><span class="k">class</span> <span class="nc">PointPillarAnchorBoxSettingsCyc</span><span class="p">(</span><span class="n">PointPillarAnchorBoxSettingsCar</span><span class="p">):</span>
  <span class="n">DIMENSION_PRIORS</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.76</span><span class="p">,</span> <span class="mf">1.73</span><span class="p">)]</span>
  <span class="n">CENTER_Z_OFFSETS</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.6</span><span class="p">]</span></div>


<div class="viewcode-block" id="PointPillarAnchorBoxSettingsPedCyc"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PointPillarAnchorBoxSettingsPedCyc">[docs]</a><span class="k">class</span> <span class="nc">PointPillarAnchorBoxSettingsPedCyc</span><span class="p">(</span><span class="n">PointPillarAnchorBoxSettingsCar</span><span class="p">):</span>
  <span class="n">DIMENSION_PRIORS</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.6</span><span class="p">,</span> <span class="mf">1.76</span><span class="p">,</span> <span class="mf">1.73</span><span class="p">)]</span>
  <span class="n">CENTER_Z_OFFSETS</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.6</span><span class="p">]</span></div>


<div class="viewcode-block" id="AnchorAssignment"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.AnchorAssignment">[docs]</a><span class="k">class</span> <span class="nc">AnchorAssignment</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Perform anchor assignment on the features.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - anchor_bboxes of shape [...base shape..., 7]</span>
<span class="sd">  - labels.bboxes_3d</span>
<span class="sd">  - labels.labels</span>
<span class="sd">  - labels.bboxes_3d_mask</span>

<span class="sd">  Adds the following features:</span>

<span class="sd">    anchor_localization_residuals: base_shape + [7] floating point tensor of</span>
<span class="sd">      residuals. The model is expected to regress against these residuals as</span>
<span class="sd">      targets. The residuals can be converted back into bboxes using</span>
<span class="sd">      detection_3d_lib.Utils3D.ResidualsToBBoxes.</span>
<span class="sd">    assigned_gt_idx: base_shape - The corresponding index of the ground</span>
<span class="sd">      truth bounding box for each anchor box in anchor_bboxes, anchors not</span>
<span class="sd">      assigned will have idx be set to -1.</span>
<span class="sd">    assigned_gt_bbox: base_shape + [7] - The corresponding ground</span>
<span class="sd">      truth bounding box for each anchor box in anchor_bboxes.</span>
<span class="sd">    assigned_gt_labels: base_shape - The assigned groundtruth label</span>
<span class="sd">      for each anchor box.</span>
<span class="sd">    assigned_gt_similarity_score: base_shape - The similarity score</span>
<span class="sd">      for each assigned anchor box.</span>
<span class="sd">    assigned_cls_mask: base_shape mask for classification loss per anchor.</span>
<span class="sd">      This should be 1.0 if the anchor has a foreground or background</span>
<span class="sd">      assignment; otherwise, it will be assigned to 0.0.</span>
<span class="sd">    assigned_reg_mask: base_shape mask for regression loss per anchor.</span>
<span class="sd">      This should be 1.0 if the anchor has a foreground assignment;</span>
<span class="sd">      otherwise, it will be assigned to 0.0.</span>
<span class="sd">      Note: background anchors do not have regression targets.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AnchorAssignment.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.AnchorAssignment.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;foreground_assignment_threshold&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="s1">&#39;Score (usually IOU) threshold for assigning a box as foreground.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;background_assignment_threshold&#39;</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">,</span>
        <span class="s1">&#39;Score (usually IOU) threshold for assigning a box as background.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="AnchorAssignment.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.AnchorAssignment.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">utils_3d</span> <span class="o">=</span> <span class="n">detection_3d_lib</span><span class="o">.</span><span class="n">Utils3D</span><span class="p">()</span>

    <span class="c1"># anchor_bboxes will be returned with shape [#centers, #boxes_per_center, 7]</span>
    <span class="c1"># flatten boxes here for matching.</span>
    <span class="n">base_shape</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">anchor_bboxes</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">anchor_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">anchor_bboxes</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>

    <span class="n">assigned_anchors</span> <span class="o">=</span> <span class="n">utils_3d</span><span class="o">.</span><span class="n">AssignAnchors</span><span class="p">(</span>
        <span class="n">anchor_bboxes</span><span class="p">,</span>
        <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">,</span>
        <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span><span class="p">,</span>
        <span class="n">foreground_assignment_threshold</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">foreground_assignment_threshold</span><span class="p">,</span>
        <span class="n">background_assignment_threshold</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">background_assignment_threshold</span><span class="p">)</span>

    <span class="c1"># Add new features.</span>
    <span class="n">features</span><span class="o">.</span><span class="n">assigned_gt_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">assigned_anchors</span><span class="o">.</span><span class="n">assigned_gt_idx</span><span class="p">,</span>
                                          <span class="n">base_shape</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">assigned_gt_bbox</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">assigned_anchors</span><span class="o">.</span><span class="n">assigned_gt_bbox</span><span class="p">,</span>
                                           <span class="n">base_shape</span> <span class="o">+</span> <span class="p">[</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">features</span><span class="o">.</span><span class="n">assigned_gt_labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="n">assigned_anchors</span><span class="o">.</span><span class="n">assigned_gt_labels</span><span class="p">,</span> <span class="n">base_shape</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">assigned_gt_similarity_score</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="n">assigned_anchors</span><span class="o">.</span><span class="n">assigned_gt_similarity_score</span><span class="p">,</span> <span class="n">base_shape</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">assigned_cls_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">assigned_anchors</span><span class="o">.</span><span class="n">assigned_cls_mask</span><span class="p">,</span>
                                            <span class="n">base_shape</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">assigned_reg_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">assigned_anchors</span><span class="o">.</span><span class="n">assigned_reg_mask</span><span class="p">,</span>
                                            <span class="n">base_shape</span><span class="p">)</span>

    <span class="c1"># Compute residuals.</span>
    <span class="n">features</span><span class="o">.</span><span class="n">anchor_localization_residuals</span> <span class="o">=</span> <span class="n">utils_3d</span><span class="o">.</span><span class="n">LocalizationResiduals</span><span class="p">(</span>
        <span class="n">features</span><span class="o">.</span><span class="n">anchor_bboxes</span><span class="p">,</span> <span class="n">features</span><span class="o">.</span><span class="n">assigned_gt_bbox</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="AnchorAssignment.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.AnchorAssignment.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">base_shape</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">anchor_bboxes</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">box_shape</span> <span class="o">=</span> <span class="n">base_shape</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="mi">7</span><span class="p">])</span>

    <span class="n">shapes</span><span class="o">.</span><span class="n">anchor_localization_residuals</span> <span class="o">=</span> <span class="n">box_shape</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">assigned_gt_idx</span> <span class="o">=</span> <span class="n">base_shape</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">assigned_gt_bbox</span> <span class="o">=</span> <span class="n">box_shape</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">assigned_gt_labels</span> <span class="o">=</span> <span class="n">base_shape</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">assigned_gt_similarity_score</span> <span class="o">=</span> <span class="n">base_shape</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">assigned_cls_mask</span> <span class="o">=</span> <span class="n">base_shape</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">assigned_reg_mask</span> <span class="o">=</span> <span class="n">base_shape</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="AnchorAssignment.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.AnchorAssignment.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">anchor_localization_residuals</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">assigned_gt_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">assigned_gt_bbox</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">assigned_gt_labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">assigned_gt_similarity_score</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">assigned_cls_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">assigned_reg_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="DropLaserPointsOutOfRange"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropLaserPointsOutOfRange">[docs]</a><span class="k">class</span> <span class="nc">DropLaserPointsOutOfRange</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Drops laser points that are out of pre-defined x/y/z ranges.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - lasers.points_feature of shape [P, F]</span>

<span class="sd">  and optionally points_padding of shape [P] corresponding to the padding.</span>
<span class="sd">  if points_padding is None, then all points are considered valid.</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">    Removes or sets padding to 1 for all points outside a given range. Modifies</span>
<span class="sd">    all items in the lasers subdictionary like lasers.points_xyz,</span>
<span class="sd">    lasers.points_feature, lasers.points_padding, and optionally</span>
<span class="sd">    lasers.points_label, lasers.points_bbox_id.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DropLaserPointsOutOfRange.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropLaserPointsOutOfRange.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;keep_x_range&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
             <span class="s1">&#39;Only points that have x coordinates within this range are kept.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;keep_y_range&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
             <span class="s1">&#39;Only points that have y coordinates within this range are kept.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;keep_z_range&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
        <span class="s1">&#39;Only points that have z coordinates within this range are kept. &#39;</span>
        <span class="s1">&#39;Approximate ground-removal can be performed by specifying a &#39;</span>
        <span class="s1">&#39;lower-bound on the z-range.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="DropLaserPointsOutOfRange.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropLaserPointsOutOfRange.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span>
    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># All points are real, we keep points unpadded by applying boolean_mask</span>
      <span class="c1"># on points_mask later.</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

    <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_x_range</span>
    <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_y_range</span>
    <span class="n">min_z</span><span class="p">,</span> <span class="n">max_z</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_z_range</span>

    <span class="c1"># Short-circuit if all ranges are set to -inf, inf.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isneginf</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">min_z</span><span class="p">]))</span> <span class="ow">and</span>
        <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isposinf</span><span class="p">([</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">max_z</span><span class="p">]))):</span>
      <span class="k">return</span> <span class="n">features</span>

    <span class="k">if</span> <span class="n">min_x</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_x</span>
    <span class="k">if</span> <span class="n">min_y</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_y</span>
    <span class="k">if</span> <span class="n">min_z</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">min_z</span>

    <span class="k">if</span> <span class="n">max_x</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_x</span>
    <span class="k">if</span> <span class="n">max_y</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_y</span>
    <span class="k">if</span> <span class="n">max_z</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_z</span>

    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="c1"># Suffices to just update the padding.</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">points_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span>
          <span class="n">_GetApplyPointMaskFn</span><span class="p">(</span><span class="n">points_mask</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="DropLaserPointsOutOfRange.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropLaserPointsOutOfRange.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="DropLaserPointsOutOfRange.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropLaserPointsOutOfRange.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="KITTIDropPointsOutOfFrustum"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.KITTIDropPointsOutOfFrustum">[docs]</a><span class="k">class</span> <span class="nc">KITTIDropPointsOutOfFrustum</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Drops laser points that are outside of the camera frustum.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - lasers.points_feature of shape [P, F]</span>
<span class="sd">  - images.velo_to_image_plane of shape [3, 4]</span>
<span class="sd">  - images.width of shape [1]</span>
<span class="sd">  - images.height of shape [1]</span>

<span class="sd">  and optionally points_padding of shape [P] corresponding to the padding.</span>
<span class="sd">  if points_padding is None, then all points are considered valid.</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">    lasers.points_xyz, lasers.points_feature, lasers.points_padding, and</span>
<span class="sd">    optionally lasers.points_label, lasers.points_bbox_id so that</span>
<span class="sd">    points outside the frustum have padding set to 1 or are removed.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="KITTIDropPointsOutOfFrustum.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.KITTIDropPointsOutOfFrustum.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="c1"># Drop points behind the car (behind x-axis = 0).</span>
    <span class="n">images</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">images</span>
    <span class="n">front_indices</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="c1"># Keep tensors unpadded and small using boolean_mask.</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span>
                                                   <span class="n">front_indices</span><span class="p">)</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span>
          <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">,</span> <span class="n">front_indices</span><span class="p">)</span>

    <span class="c1"># Drop those points outside the image plane.</span>
    <span class="n">points_image</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">PointsToImagePlane</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span>
                                               <span class="n">images</span><span class="o">.</span><span class="n">velo_to_image_plane</span><span class="p">)</span>
    <span class="n">in_image_plane</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">points_image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">points_image</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">points_image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span>
        <span class="p">(</span><span class="n">points_image</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)))</span>

    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="c1"># Update padding to only include front indices and in image plane.</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
      <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="n">front_indices</span>
      <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="n">in_image_plane</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">points_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span>
          <span class="n">_GetApplyPointMaskFn</span><span class="p">(</span><span class="n">in_image_plane</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="KITTIDropPointsOutOfFrustum.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.KITTIDropPointsOutOfFrustum.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="KITTIDropPointsOutOfFrustum.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.KITTIDropPointsOutOfFrustum.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="RandomWorldRotationAboutZAxis"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomWorldRotationAboutZAxis">[docs]</a><span class="k">class</span> <span class="nc">RandomWorldRotationAboutZAxis</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Rotates the world randomly as a form of data augmentation.</span>

<span class="sd">  Rotations are performed around the *z-axis*. This assumes that the car is</span>
<span class="sd">  always level. In general, we&#39;d like to instead rotate the car on the spot,</span>
<span class="sd">  this would then make sense for cases where the car is on a slope.</span>

<span class="sd">  When there are leading dimensions, this will rotate the boxes with the same</span>
<span class="sd">  transformation across all the frames. This is useful when the input is a</span>
<span class="sd">  sequence of frames from the same run segment.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [..., 3]</span>
<span class="sd">  - labels.bboxes_3d of shape [..., 7]</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">    lasers.points_xyz, labels.bboxes_3d with the same rotation applied to both.</span>

<span class="sd">  Adds the following features:</span>
<span class="sd">    world_rot_z which contains the rotation applied to the example.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomWorldRotationAboutZAxis.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomWorldRotationAboutZAxis.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;max_rotation&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;The rotation amount will be randomly picked from &#39;</span>
        <span class="s1">&#39;[-max_rotation, max_rotation).&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;include_world_rot_z&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;Whether to include the applied rotation as an additional tensor. &#39;</span>
        <span class="s1">&#39;It can be helpful to disable this when using the preprocessor in a &#39;</span>
        <span class="s1">&#39;way that expects the structure of the features to be the same &#39;</span>
        <span class="s1">&#39;(e.g., as a branch in tf.cond).&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">max_rotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_rotation needs to be specified, instead of None.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="RandomWorldRotationAboutZAxis.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomWorldRotationAboutZAxis.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">rot</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">((),</span>
                            <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_rotation</span><span class="p">,</span>
                            <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_rotation</span><span class="p">,</span>
                            <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>

    <span class="c1"># Rotating about the z-axis is equal to experiencing yaw.</span>
    <span class="n">pose</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">rot</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>

    <span class="c1"># Rotate points.</span>
    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">CoordinateTransform</span><span class="p">(</span>
        <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>

    <span class="c1"># Rotate bboxes, note that heading has a special case.</span>
    <span class="n">bboxes_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">bboxes_dims</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">bboxes_rot</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">6</span><span class="p">:]</span>

    <span class="n">bboxes_xyz</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">CoordinateTransform</span><span class="p">(</span><span class="n">bboxes_xyz</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>

    <span class="c1"># The heading correction should subtract rot from the bboxes rotations.</span>
    <span class="n">bboxes_rot</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">WrapAngleRad</span><span class="p">(</span><span class="n">bboxes_rot</span> <span class="o">-</span> <span class="n">rot</span><span class="p">)</span>

    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bboxes_xyz</span><span class="p">,</span> <span class="n">bboxes_dims</span><span class="p">,</span> <span class="n">bboxes_rot</span><span class="p">],</span>
                                          <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">include_world_rot_z</span><span class="p">:</span>
      <span class="n">features</span><span class="o">.</span><span class="n">world_rot_z</span> <span class="o">=</span> <span class="n">rot</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="RandomWorldRotationAboutZAxis.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomWorldRotationAboutZAxis.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">include_world_rot_z</span><span class="p">:</span>
      <span class="n">shapes</span><span class="o">.</span><span class="n">world_rot_z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="RandomWorldRotationAboutZAxis.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomWorldRotationAboutZAxis.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">include_world_rot_z</span><span class="p">:</span>
      <span class="n">dtypes</span><span class="o">.</span><span class="n">world_rot_z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="DropPointsOutOfFrustum"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropPointsOutOfFrustum">[docs]</a><span class="k">class</span> <span class="nc">DropPointsOutOfFrustum</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Drops points outside of pre-defined theta / phi ranges.</span>

<span class="sd">  Note that the ranges for keep_phi_range can be negative, this is because the</span>
<span class="sd">  phi values wrap around 2*pi. Thus, a valid range that filters the 90 deg</span>
<span class="sd">  frontal field of view of the car can be specified as [-pi/4, pi/4].</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - lasers.points_feature of shape [P, F]</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">  - lasers.points_xyz removing any points out of frustum.</span>
<span class="sd">  - lasers.points_feature removing any points out of frustum.</span>

<span class="sd">  Note: We expect a downstream processor that filters out boxes with few points</span>
<span class="sd">  to drop the corresponding bboxes.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DropPointsOutOfFrustum.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropPointsOutOfFrustum.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;keep_theta_range&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
             <span class="s1">&#39;Only points that have theta coordinates within this range.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;keep_phi_range&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
             <span class="s1">&#39;Only points that have phi coordinates within this range.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="DropPointsOutOfFrustum.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropPointsOutOfFrustum.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;DropPointsOutOfFrustum preprocessor does not support &#39;</span>
                       <span class="s1">&#39;padded lasers.&#39;</span><span class="p">)</span>

    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span>
    <span class="n">points_feature</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span>

    <span class="n">min_theta</span><span class="p">,</span> <span class="n">max_theta</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_theta_range</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">min_theta</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">or</span> <span class="n">min_theta</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="ow">or</span> <span class="n">max_theta</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">or</span>
        <span class="n">max_theta</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Valid values for theta are between 0 and pi, &#39;</span>
                       <span class="s1">&#39;keep_theta_range=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">keep_theta_range</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">min_theta</span> <span class="o">&gt;</span> <span class="n">max_theta</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;min_theta must be &lt;= max_theta, &#39;</span>
                       <span class="s1">&#39;keep_theta_range=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">keep_theta_range</span><span class="p">))</span>

    <span class="n">min_phi</span><span class="p">,</span> <span class="n">max_phi</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_phi_range</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">min_phi</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="ow">or</span> <span class="n">min_phi</span> <span class="o">&gt;</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="ow">or</span>
        <span class="n">max_phi</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="ow">or</span> <span class="n">max_phi</span> <span class="o">&gt;</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Valid values for phi are between -2*pi and 2*pi,&#39;</span>
                       <span class="s1">&#39;keep_phi_range=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">keep_phi_range</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">min_phi</span> <span class="o">&gt;</span> <span class="n">max_phi</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;min_phi must be &lt;= max_phi, &#39;</span>
                       <span class="s1">&#39;keep_phi_range=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">keep_phi_range</span><span class="p">))</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span>
        <span class="n">geometry</span><span class="o">.</span><span class="n">SphericalCoordinatesTransform</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># phi is returned in range [-pi, pi], we shift the values which are between</span>
    <span class="c1"># [-pi, 0] to be [pi, 2pi] instead to make the logic below easier to follow.</span>
    <span class="c1"># Hence, all phi values after this will be [0, 2pi].</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">phi</span> <span class="o">&gt;=</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">phi</span><span class="p">)</span>

    <span class="c1"># Theta does not have circular boundary conditions, a simple check suffices.</span>
    <span class="n">points_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&gt;=</span> <span class="n">min_theta</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&lt;=</span> <span class="n">max_theta</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">min_phi</span> <span class="o">&lt;</span> <span class="mf">0.</span> <span class="ow">and</span> <span class="n">max_phi</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
      <span class="c1"># Both are less than zero, we just just add 2pi and will use the regular</span>
      <span class="c1"># check.</span>
      <span class="n">min_phi</span> <span class="o">+=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
      <span class="n">max_phi</span> <span class="o">+=</span> <span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

    <span class="k">if</span> <span class="n">min_phi</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">:</span>
      <span class="c1"># The minimum threshold is below 0, so we split into checking between</span>
      <span class="c1"># (0 to min_phi) and (0 to max_phi). Note that min_phi is negative, but</span>
      <span class="c1"># phi is always positive, so we take 2*pi + min_phi to get the range of</span>
      <span class="c1"># appropriate values.</span>
      <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="n">min_phi</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&lt;=</span> <span class="n">max_phi</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Both must be greater than 0 if we get to this condition.</span>
      <span class="k">assert</span> <span class="n">min_phi</span> <span class="o">&gt;=</span> <span class="mf">0.</span>
      <span class="k">assert</span> <span class="n">max_phi</span> <span class="o">&gt;=</span> <span class="mf">0.</span>
      <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&gt;=</span> <span class="n">min_phi</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&lt;=</span> <span class="n">max_phi</span><span class="p">)</span>

    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_feature</span><span class="p">,</span>
                                                     <span class="n">points_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="DropPointsOutOfFrustum.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropPointsOutOfFrustum.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="DropPointsOutOfFrustum.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropPointsOutOfFrustum.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="DropBoxesOutOfRange"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropBoxesOutOfRange">[docs]</a><span class="k">class</span> <span class="nc">DropBoxesOutOfRange</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Drops boxes outside of pre-defined x/y/z ranges (boundaries inclusive).</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - labels.bboxes_3d of shape [N, 7]</span>
<span class="sd">  - labels.bboxes_3d_mask of shape [N]</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">  - labels.bboxes_3d_mask to mask out any additional boxes.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DropBoxesOutOfRange.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropBoxesOutOfRange.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;keep_x_range&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
             <span class="s1">&#39;Only boxes that have x coordinates within this range are kept.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;keep_y_range&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
             <span class="s1">&#39;Only boxes that have y coordinates within this range are kept.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;keep_z_range&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
             <span class="s1">&#39;Only boxes that have z coordinates within this range are kept.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="DropBoxesOutOfRange.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropBoxesOutOfRange.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">min_x</span><span class="p">,</span> <span class="n">max_x</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_x_range</span>
    <span class="n">min_y</span><span class="p">,</span> <span class="n">max_y</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_y_range</span>
    <span class="n">min_z</span><span class="p">,</span> <span class="n">max_z</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_z_range</span>

    <span class="c1"># Short-circuit if all ranges are set to -inf, inf.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isneginf</span><span class="p">([</span><span class="n">min_x</span><span class="p">,</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">min_z</span><span class="p">]))</span> <span class="ow">and</span>
        <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isposinf</span><span class="p">([</span><span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">,</span> <span class="n">max_z</span><span class="p">]))):</span>
      <span class="k">return</span> <span class="n">features</span>

    <span class="c1"># For each bounding box, compute whether any of its extrema</span>
    <span class="c1"># fall outside of the range.</span>
    <span class="n">bboxes_3d_corners</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">BBoxCorners</span><span class="p">(</span>
        <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="o">...</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bboxes_3d_corners</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">bboxes_3d_corners</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="n">min_bbox_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">bboxes_3d_corners</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">max_bbox_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">bboxes_3d_corners</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">min_bbox_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">bboxes_3d_corners</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">max_bbox_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">bboxes_3d_corners</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">min_bbox_z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_min</span><span class="p">(</span><span class="n">bboxes_3d_corners</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">max_bbox_z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">bboxes_3d_corners</span><span class="p">[:,</span> <span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">min_bbox_x</span> <span class="o">&gt;=</span> <span class="n">min_x</span><span class="p">,</span> <span class="n">max_bbox_x</span> <span class="o">&lt;=</span> <span class="n">max_x</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">min_bbox_y</span> <span class="o">&gt;=</span> <span class="n">min_y</span><span class="p">,</span> <span class="n">max_bbox_y</span> <span class="o">&lt;=</span> <span class="n">max_y</span><span class="p">)</span>
        <span class="o">&amp;</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">min_bbox_z</span> <span class="o">&gt;=</span> <span class="n">min_z</span><span class="p">,</span> <span class="n">max_bbox_z</span> <span class="o">&lt;=</span> <span class="n">max_z</span><span class="p">))</span>

    <span class="n">max_num_boxes</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">max_num_boxes</span><span class="p">)</span>

    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span> <span class="o">*=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="DropBoxesOutOfRange.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropBoxesOutOfRange.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="DropBoxesOutOfRange.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.DropBoxesOutOfRange.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="PadLaserFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PadLaserFeatures">[docs]</a><span class="k">class</span> <span class="nc">PadLaserFeatures</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Pads laser features so that the dimensions are fixed.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - lasers.points_feature of shape [P, F]</span>

<span class="sd">  and optionally points_padding of shape [P] corresponding to the padding.</span>
<span class="sd">  if points_padding is None, then all points are considered valid.</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">    lasers.points_xyz and lasers.points_feature to add padding.</span>
<span class="sd">    Optionally also modifies lasers.points_label and lasers.points_bbox_id</span>
<span class="sd">    if they exist to add padding.</span>
<span class="sd">  Modifies/adds the following features:</span>
<span class="sd">    labels.points_padding of shape [P] representing the padding.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PadLaserFeatures.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PadLaserFeatures.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;max_num_points&#39;</span><span class="p">,</span> <span class="mi">128500</span><span class="p">,</span>
             <span class="s1">&#39;Max number of points to pad the points to.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="PadLaserFeatures.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PadLaserFeatures.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">points_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span>
          <span class="n">_GetApplyPointMaskFn</span><span class="p">(</span><span class="n">points_mask</span><span class="p">))</span>

    <span class="n">npoints</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">npoints</span><span class="p">])</span>

    <span class="n">shuffled_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">npoints</span><span class="p">)</span>
    <span class="n">shuffled_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">shuffled_idx</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_PadOrTrimFn</span><span class="p">(</span><span class="n">points_tensor</span><span class="p">):</span>
      <span class="c1"># Shuffle before trimming so we have a random sampling</span>
      <span class="n">points_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">points_tensor</span><span class="p">,</span> <span class="n">shuffled_idx</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">points_tensor</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">max_num_points</span><span class="p">]</span> <span class="o">+</span>
                                  <span class="n">points_tensor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">as_list</span><span class="p">())</span>

    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">_PadOrTrimFn</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="PadLaserFeatures.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PadLaserFeatures.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="k">def</span> <span class="nf">_TransformShape</span><span class="p">(</span><span class="n">points_shape</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">max_num_points</span><span class="p">]</span> <span class="o">+</span> <span class="n">points_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">as_list</span><span class="p">())</span>

    <span class="n">shapes</span><span class="o">.</span><span class="n">lasers</span> <span class="o">=</span> <span class="n">shapes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">_TransformShape</span><span class="p">)</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">max_num_points</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="PadLaserFeatures.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.PadLaserFeatures.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="WorldScaling"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.WorldScaling">[docs]</a><span class="k">class</span> <span class="nc">WorldScaling</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Scale the world randomly as a form of data augmentation.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - labels.bboxes_3d of shape [L, 7]</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">    lasers.points_xyz, labels.bboxes_3d with the same scaling applied to both.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WorldScaling.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.WorldScaling.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;scaling&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;The scaling range.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">scaling</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;scaling needs to be specified, instead of None.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">scaling</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;scaling needs to be a list of two elements.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="WorldScaling.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.WorldScaling.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">scaling</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">((),</span>
                                <span class="n">minval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">scaling</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="c1"># Scale points [num_points, 3].</span>
    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">*=</span> <span class="n">scaling</span>

    <span class="c1"># Scaling bboxes (location and dimensions).</span>
    <span class="n">bboxes_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling</span>
    <span class="n">bboxes_dims</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">*</span> <span class="n">scaling</span>
    <span class="n">bboxes_rot</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">6</span><span class="p">:]</span>

    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bboxes_xyz</span><span class="p">,</span> <span class="n">bboxes_dims</span><span class="p">,</span> <span class="n">bboxes_rot</span><span class="p">],</span>
                                          <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="WorldScaling.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.WorldScaling.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="WorldScaling.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.WorldScaling.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="RandomDropLaserPoints"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomDropLaserPoints">[docs]</a><span class="k">class</span> <span class="nc">RandomDropLaserPoints</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Randomly dropout laser points and the corresponding features.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - lasers.points_feature of shape [P, F]</span>


<span class="sd">  Modifies the following features:</span>
<span class="sd">    lasers.points_xyz, lasers.points_feature.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomDropLaserPoints.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomDropLaserPoints.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;keep_prob&#39;</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="s1">&#39;Probability for keeping points.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="RandomDropLaserPoints.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomDropLaserPoints.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">num_points</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">)</span>

    <span class="n">pts_keep_sample_prob</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="n">num_points</span><span class="p">],</span>
                                             <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                             <span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                             <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
    <span class="n">pts_keep_mask</span> <span class="o">=</span> <span class="n">pts_keep_sample_prob</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_prob</span>

    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="c1"># Update points_padding so that where pts_keep_mask is True,</span>
      <span class="c1"># points_padding remains 0.</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span>
      <span class="n">points_mask</span> <span class="o">*=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pts_keep_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">points_mask</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span>
                                                   <span class="n">pts_keep_mask</span><span class="p">)</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span>
          <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">,</span> <span class="n">pts_keep_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="RandomDropLaserPoints.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomDropLaserPoints.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="RandomDropLaserPoints.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomDropLaserPoints.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="RandomFlipY"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomFlipY">[docs]</a><span class="k">class</span> <span class="nc">RandomFlipY</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Flip the world along axis Y as a form of data augmentation.</span>

<span class="sd">  When there are leading dimensions, this will flip the boxes with the same</span>
<span class="sd">  transformation across all the frames. This is useful when the input is a</span>
<span class="sd">  sequence of frames from the same run segment.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [..., 3]</span>
<span class="sd">  - labels.bboxes_3d of shape [..., 7]</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">    lasers.points_xyz, labels.bboxes_3d with the same flipping applied to both.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomFlipY.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomFlipY.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;flip_probability&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="s1">&#39;Probability of flipping.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="RandomFlipY.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomFlipY.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">threshold</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">p</span><span class="o">.</span><span class="n">flip_probability</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
        <span class="p">(),</span> <span class="n">minval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">threshold</span>

    <span class="c1"># Flip points</span>
    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span>
    <span class="n">points_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="o">-</span><span class="n">points_xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">points_xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">points_xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">points_y</span><span class="p">,</span> <span class="n">points_xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Flip boxes</span>
    <span class="n">bboxes_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">bboxes_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="o">-</span><span class="n">bboxes_xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">bboxes_xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">bboxes_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">bboxes_xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">],</span> <span class="n">bboxes_y</span><span class="p">,</span> <span class="n">bboxes_xyz</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">3</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Compensate rotation.</span>
    <span class="n">bboxes_dims</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">bboxes_rot</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">6</span><span class="p">:]</span>
    <span class="n">bboxes_rot</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span> <span class="n">geometry</span><span class="o">.</span><span class="n">WrapAngleRad</span><span class="p">(</span><span class="o">-</span><span class="n">bboxes_rot</span><span class="p">),</span>
                          <span class="n">bboxes_rot</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bboxes_xyz</span><span class="p">,</span> <span class="n">bboxes_dims</span><span class="p">,</span> <span class="n">bboxes_rot</span><span class="p">],</span>
                                          <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="RandomFlipY.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomFlipY.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="RandomFlipY.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomFlipY.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="GlobalTranslateNoise"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GlobalTranslateNoise">[docs]</a><span class="k">class</span> <span class="nc">GlobalTranslateNoise</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Add global translation noise of xyz coordinates to points and boxes.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - labels.bboxes_3d of shape [L, 7]</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">    lasers.points_xyz, labels.bboxes_3d with the same</span>
<span class="sd">      random translation noise applied to both.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GlobalTranslateNoise.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GlobalTranslateNoise.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;noise_std&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
             <span class="s1">&#39;Standard deviation of translation noise per axis.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="GlobalTranslateNoise.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GlobalTranslateNoise.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="c1"># Use three different seeds but the same base seed so</span>
    <span class="c1"># that the values are different.</span>
    <span class="n">base_seed</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">random_seed</span>
    <span class="n">x_seed</span> <span class="o">=</span> <span class="n">base_seed</span>
    <span class="n">y_seed</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">base_seed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">base_seed</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">z_seed</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">base_seed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">base_seed</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">random_translate_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">((),</span>
                                          <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                          <span class="n">stddev</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">noise_std</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">seed</span><span class="o">=</span><span class="n">x_seed</span><span class="p">)</span>
    <span class="n">random_translate_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">((),</span>
                                          <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                          <span class="n">stddev</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">noise_std</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">seed</span><span class="o">=</span><span class="n">y_seed</span><span class="p">)</span>
    <span class="n">random_translate_z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">((),</span>
                                          <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                          <span class="n">stddev</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">noise_std</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                          <span class="n">seed</span><span class="o">=</span><span class="n">z_seed</span><span class="p">)</span>

    <span class="n">pose</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span>
        <span class="n">random_translate_x</span><span class="p">,</span> <span class="n">random_translate_y</span><span class="p">,</span> <span class="n">random_translate_z</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="mf">0.0</span>
    <span class="p">],</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Translate points.</span>
    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span>
    <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">CoordinateTransform</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>

    <span class="c1"># Translate boxes</span>
    <span class="n">bboxes_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">bboxes_xyz</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">CoordinateTransform</span><span class="p">(</span><span class="n">bboxes_xyz</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
        <span class="p">[</span><span class="n">bboxes_xyz</span><span class="p">,</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">:]],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="GlobalTranslateNoise.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GlobalTranslateNoise.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="GlobalTranslateNoise.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GlobalTranslateNoise.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="RandomBBoxTransform"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomBBoxTransform">[docs]</a><span class="k">class</span> <span class="nc">RandomBBoxTransform</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Randomly transform bounding boxes and the points inside them.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">    - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">    - lasers.points_feature of shape [P, F]</span>
<span class="sd">    - lasers.points_padding of shape [P]</span>
<span class="sd">    - labels.bboxes_3d of shape [L, 7]</span>
<span class="sd">    - labels.bboxes_3d_mask of shape [L]</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">    lasers.points_{xyz,feature,padding}, labels.bboxes_3d with the</span>
<span class="sd">      transformed bounding boxes and points.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomBBoxTransform.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomBBoxTransform.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;max_rotation&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;The rotation amount will be randomly picked from &#39;</span>
        <span class="s1">&#39;[-max_rotation, max_rotation).&#39;</span><span class="p">)</span>
    <span class="c1"># At the moment we don&#39;t use this because it can cause boxes to collide with</span>
    <span class="c1"># each other.  We need to compute box intersections when deciding whether to</span>
    <span class="c1"># apply the translation jitter.  Theoretically we should also do this for</span>
    <span class="c1"># rotation.</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;noise_std&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
             <span class="s1">&#39;Standard deviation of translation noise per axis.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;max_scaling&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;An optional float list of length 3. When max_scaling is not none, &#39;</span>
        <span class="s1">&#39;delta parameters s_x, s_y, s_z are drawn from &#39;</span>
        <span class="s1">&#39;[-max_scaling[i], max_scaling[i]] where i is in [0, 2].&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;max_shearing&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;An optional float list of length 6. When max_shearing is not none, &#39;</span>
        <span class="s1">&#39;shearing parameters sh_x^y, sh_x^z, sh_y^x, sh_y^z, sh_z^x, sh_z^y are&#39;</span>
        <span class="s1">&#39;drawn from [-max_shearing[i], max_shearing[i]], where i is in [0, 5].&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;max_num_points_per_bbox&#39;</span><span class="p">,</span> <span class="mi">16384</span><span class="p">,</span>
        <span class="s1">&#39;The maximum number of points that fall within a bounding box. &#39;</span>
        <span class="s1">&#39;Bounding boxes with more points than this value will &#39;</span>
        <span class="s1">&#39;have some points droppped.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">max_rotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_rotation needs to be specified, instead of None.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_scaling needs to be specified as either None or &#39;</span>
                         <span class="s1">&#39;list of 3 floating point numbers, instead of </span><span class="si">{}</span><span class="s1">.&#39;</span>
                         <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;max_shearing needs to be specified as either None or &#39;</span>
                         <span class="s1">&#39;list of 6 floating point numbers, instead of </span><span class="si">{}</span><span class="s1">.&#39;</span>
                         <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">))</span>

<div class="viewcode-block" id="RandomBBoxTransform._Foreground"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomBBoxTransform._Foreground">[docs]</a>  <span class="k">def</span> <span class="nf">_Foreground</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_feature</span><span class="p">,</span> <span class="n">real_bboxes_3d</span><span class="p">,</span>
                  <span class="n">points_in_bbox_mask</span><span class="p">,</span> <span class="n">rotation</span><span class="p">,</span> <span class="n">translate_pose</span><span class="p">,</span> <span class="n">transform_fn</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extract and transform foreground points and features.&quot;&quot;&quot;</span>
    <span class="n">out_bbox_xyz</span><span class="p">,</span> <span class="n">out_bbox_feature</span><span class="p">,</span> <span class="n">out_bbox_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ForLoopBuffers</span><span class="p">(</span>
        <span class="n">features</span><span class="p">)</span>

    <span class="c1"># Only iterate over the actual number of boxes in the scene.</span>
    <span class="n">actual_num_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">ForLoop</span><span class="p">(</span>
        <span class="n">body</span><span class="o">=</span><span class="n">transform_fn</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="n">actual_num_bboxes</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">loop_state</span><span class="o">=</span><span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
            <span class="n">points_xyz</span><span class="o">=</span><span class="n">points_xyz</span><span class="p">,</span>
            <span class="n">points_feature</span><span class="o">=</span><span class="n">points_feature</span><span class="p">,</span>
            <span class="n">bboxes_3d</span><span class="o">=</span><span class="n">real_bboxes_3d</span><span class="p">,</span>
            <span class="n">points_in_bbox_mask</span><span class="o">=</span><span class="n">points_in_bbox_mask</span><span class="p">,</span>
            <span class="n">rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">,</span>
            <span class="n">translate_pose</span><span class="o">=</span><span class="n">translate_pose</span><span class="p">,</span>
            <span class="n">out_bbox_points</span><span class="o">=</span><span class="n">out_bbox_xyz</span><span class="p">,</span>
            <span class="n">out_bbox_feature</span><span class="o">=</span><span class="n">out_bbox_feature</span><span class="p">,</span>
            <span class="n">out_bbox_mask</span><span class="o">=</span><span class="n">out_bbox_mask</span><span class="p">))</span>

    <span class="c1"># Gather all of the transformed points and features</span>
    <span class="n">out_bbox_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">out_bbox_points</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">num_features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out_bbox_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">out_bbox_feature</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_features</span><span class="p">])</span>
    <span class="n">out_bbox_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ret</span><span class="o">.</span><span class="n">out_bbox_mask</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="n">fg_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">out_bbox_xyz</span><span class="p">,</span> <span class="n">out_bbox_mask</span><span class="p">)</span>
    <span class="n">fg_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">out_bbox_feature</span><span class="p">,</span> <span class="n">out_bbox_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fg_xyz</span><span class="p">,</span> <span class="n">fg_feature</span></div>

<div class="viewcode-block" id="RandomBBoxTransform._Background"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomBBoxTransform._Background">[docs]</a>  <span class="k">def</span> <span class="nf">_Background</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_feature</span><span class="p">,</span> <span class="n">points_in_bbox_mask</span><span class="p">):</span>
    <span class="c1"># If a point is in any bounding box, it is a foreground point.</span>
    <span class="n">foreground_points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_any</span><span class="p">(</span><span class="n">points_in_bbox_mask</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># All others are background.  We rotate all of the foreground points to</span>
    <span class="c1"># final_points_* and keep the background points unchanged</span>
    <span class="n">background_points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">foreground_points_mask</span><span class="p">)</span>
    <span class="n">background_points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">background_points_mask</span><span class="p">)</span>
    <span class="n">background_points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_feature</span><span class="p">,</span>
                                                <span class="n">background_points_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">background_points_xyz</span><span class="p">,</span> <span class="n">background_points_feature</span></div>

<div class="viewcode-block" id="RandomBBoxTransform._ForLoopBuffers"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomBBoxTransform._ForLoopBuffers">[docs]</a>  <span class="k">def</span> <span class="nf">_ForLoopBuffers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create and return the buffers for the for loop.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span>

    <span class="c1"># Compute the shapes and create the buffers for the For loop.</span>
    <span class="n">max_num_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">bboxes_3d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">per_box_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_num_bboxes</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">max_num_points_per_bbox</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
    <span class="n">out_bbox_points</span> <span class="o">=</span> <span class="n">inplace_ops</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
        <span class="n">per_box_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">num_features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">bbox_feature_shape</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">max_num_bboxes</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">max_num_points_per_bbox</span><span class="p">,</span> <span class="n">num_features</span>
    <span class="p">]</span>
    <span class="n">out_bbox_feature</span> <span class="o">=</span> <span class="n">inplace_ops</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
        <span class="n">bbox_feature_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">per_box_mask_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">max_num_bboxes</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">max_num_points_per_bbox</span><span class="p">]</span>
    <span class="n">out_bbox_mask</span> <span class="o">=</span> <span class="n">inplace_ops</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
        <span class="n">per_box_mask_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">init</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_bbox_points</span><span class="p">,</span> <span class="n">out_bbox_feature</span><span class="p">,</span> <span class="n">out_bbox_mask</span></div>

<div class="viewcode-block" id="RandomBBoxTransform.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomBBoxTransform.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">num_features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">Transform</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Transform the points in bounding box `i`.&quot;&quot;&quot;</span>
      <span class="n">state</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
      <span class="n">bbox_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">points_in_bbox_mask</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

      <span class="c1"># Fetch only the points in the bounding box.</span>
      <span class="n">points_xyz_masked</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">bbox_mask</span><span class="p">)</span>
      <span class="n">points_feature_masked</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">points_feature</span><span class="p">,</span> <span class="n">bbox_mask</span><span class="p">)</span>

      <span class="n">num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">points_xyz_masked</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

      <span class="c1"># TODO(vrv): Fold the following into a single transformation</span>
      <span class="c1"># matrix.</span>
      <span class="c1">#</span>
      <span class="c1"># Translate the box to the origin, then rotate the desired</span>
      <span class="c1"># rotation angle.</span>
      <span class="n">translation_vec</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
      <span class="n">rotation_vec</span> <span class="o">=</span> <span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">rotation</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
      <span class="n">pose</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="o">-</span><span class="n">translation_vec</span><span class="p">,</span> <span class="n">rotation_vec</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">points_xyz_adj</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">CoordinateTransform</span><span class="p">(</span><span class="n">points_xyz_masked</span><span class="p">,</span> <span class="n">pose</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Translate the points in the bounding box by moving dz/2 so that the</span>
        <span class="c1"># bottom of the bounding box is at Z = 0 when any of the two</span>
        <span class="c1"># (max_scaling or max_shearing) is not None</span>
        <span class="n">translation_scale_or_shear</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">state</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">pose1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">translation_scale_or_shear</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">points_xyz_adj</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">CoordinateTransform</span><span class="p">(</span><span class="n">points_xyz_adj</span><span class="p">,</span> <span class="n">pose1</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">translation_scale_or_shear</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Perform scaling to the point cloud</span>
        <span class="c1"># Scaling matrix</span>
        <span class="c1"># [[s_x+1    0      0]</span>
        <span class="c1">#  [ 0      s_y+1   0]</span>
        <span class="c1">#  [ 0       0     s_z+1]]</span>
        <span class="n">sx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span>
                               <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">sy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span>
                               <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">sz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span>
                               <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                               <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_scaling</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                               <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">scaling_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">sx</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">sy</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">sz</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">points_xyz_adj</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,kj-&gt;ki&#39;</span><span class="p">,</span> <span class="n">scaling_matrix</span><span class="p">,</span> <span class="n">points_xyz_adj</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Perform shearing to the point cloud</span>
        <span class="c1"># Shearing matrix</span>
        <span class="c1"># [[1       sh_x^y  sh_x^z]</span>
        <span class="c1">#  [sh_y^x     1    sh_y^z]</span>
        <span class="c1">#  [sh_z^x  sh_z^y     1  ]]</span>
        <span class="n">sxy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span>
                                <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">sxz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span>
                                <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">syx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span>
                                <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">syz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span>
                                <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                                <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">szx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span>
                                <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
                                <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">szy</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([],</span>
                                <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_shearing</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
                                <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">shearing_matrix</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
            <span class="p">[[</span><span class="mf">1.</span><span class="p">,</span> <span class="n">sxy</span><span class="p">,</span> <span class="n">sxz</span><span class="p">],</span> <span class="p">[</span><span class="n">syx</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">syz</span><span class="p">],</span> <span class="p">[</span><span class="n">szx</span><span class="p">,</span> <span class="n">szy</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">points_xyz_adj</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij,kj-&gt;ki&#39;</span><span class="p">,</span> <span class="n">shearing_matrix</span><span class="p">,</span> <span class="n">points_xyz_adj</span><span class="p">)</span>

      <span class="c1"># Translate the points back, adding noise if needed.</span>
      <span class="n">translation_with_noise</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">translation_vec</span> <span class="o">-</span> <span class="n">translation_scale_or_shear</span> <span class="o">+</span>
          <span class="n">state</span><span class="o">.</span><span class="n">translate_pose</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
      <span class="n">pose2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">translation_with_noise</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">final_points_xyz</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">CoordinateTransform</span><span class="p">(</span><span class="n">points_xyz_adj</span><span class="p">,</span> <span class="n">pose2</span><span class="p">)</span>

      <span class="c1"># final_points_xyz is an [M, 3] Tensor where M is the number of points in</span>
      <span class="c1"># the box.</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">num_points</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

      <span class="n">final_points_xyz</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">final_points_xyz</span><span class="p">,</span>
                                              <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">max_num_points_per_bbox</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
      <span class="n">final_points_feature</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
          <span class="n">points_feature_masked</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">max_num_points_per_bbox</span><span class="p">,</span> <span class="n">num_features</span><span class="p">])</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">points_mask</span><span class="p">,</span>
                                         <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">max_num_points_per_bbox</span><span class="p">])</span>
      <span class="n">state</span><span class="o">.</span><span class="n">out_bbox_points</span> <span class="o">=</span> <span class="n">inplace_ops</span><span class="o">.</span><span class="n">alias_inplace_update</span><span class="p">(</span>
          <span class="n">state</span><span class="o">.</span><span class="n">out_bbox_points</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">final_points_xyz</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
      <span class="n">state</span><span class="o">.</span><span class="n">out_bbox_feature</span> <span class="o">=</span> <span class="n">inplace_ops</span><span class="o">.</span><span class="n">alias_inplace_update</span><span class="p">(</span>
          <span class="n">state</span><span class="o">.</span><span class="n">out_bbox_feature</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">final_points_feature</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
      <span class="n">state</span><span class="o">.</span><span class="n">out_bbox_mask</span> <span class="o">=</span> <span class="n">inplace_ops</span><span class="o">.</span><span class="n">alias_inplace_update</span><span class="p">(</span>
          <span class="n">state</span><span class="o">.</span><span class="n">out_bbox_mask</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">points_mask</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

      <span class="k">return</span> <span class="n">state</span>

    <span class="c1"># Get the points and features that reside in boxes.</span>
    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span>
      <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>
      <span class="n">points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">,</span>
                                       <span class="n">points_mask</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span>
      <span class="n">points_feature</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span>

    <span class="c1"># Fetch real bounding boxes and compute point mask.</span>
    <span class="n">real_bboxes_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">,</span>
                                     <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span><span class="p">)</span>
    <span class="n">points_in_bbox_mask</span> <span class="o">=</span> <span class="n">geometry</span><span class="o">.</span><span class="n">IsWithinBBox3D</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">real_bboxes_3d</span><span class="p">)</span>

    <span class="c1"># Choose a random rotation for every real box.</span>
    <span class="n">num_boxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">real_bboxes_3d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rotation</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="n">num_boxes</span><span class="p">],</span>
                                 <span class="n">minval</span><span class="o">=-</span><span class="n">p</span><span class="o">.</span><span class="n">max_rotation</span><span class="p">,</span>
                                 <span class="n">maxval</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_rotation</span><span class="p">,</span>
                                 <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>

    <span class="n">base_seed</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">random_seed</span>
    <span class="n">x_seed</span> <span class="o">=</span> <span class="n">base_seed</span>
    <span class="n">y_seed</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">base_seed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">base_seed</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">z_seed</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">base_seed</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">base_seed</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">random_translate_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">([</span><span class="n">num_boxes</span><span class="p">],</span>
                                          <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                          <span class="n">stddev</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">noise_std</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                          <span class="n">seed</span><span class="o">=</span><span class="n">x_seed</span><span class="p">)</span>
    <span class="n">random_translate_y</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">([</span><span class="n">num_boxes</span><span class="p">],</span>
                                          <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                          <span class="n">stddev</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">noise_std</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                          <span class="n">seed</span><span class="o">=</span><span class="n">y_seed</span><span class="p">)</span>
    <span class="n">random_translate_z</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">([</span><span class="n">num_boxes</span><span class="p">],</span>
                                          <span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                          <span class="n">stddev</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">noise_std</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                          <span class="n">seed</span><span class="o">=</span><span class="n">z_seed</span><span class="p">)</span>

    <span class="n">translate_pose</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="p">[</span><span class="n">random_translate_x</span><span class="p">,</span> <span class="n">random_translate_y</span><span class="p">,</span> <span class="n">random_translate_z</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">fg_xyz</span><span class="p">,</span> <span class="n">fg_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Foreground</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_feature</span><span class="p">,</span>
                                          <span class="n">real_bboxes_3d</span><span class="p">,</span> <span class="n">points_in_bbox_mask</span><span class="p">,</span>
                                          <span class="n">rotation</span><span class="p">,</span> <span class="n">translate_pose</span><span class="p">,</span> <span class="n">Transform</span><span class="p">)</span>

    <span class="c1"># Concatenate them with the background points and features.</span>
    <span class="n">bg_xyz</span><span class="p">,</span> <span class="n">bg_feature</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Background</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_feature</span><span class="p">,</span>
                                          <span class="n">points_in_bbox_mask</span><span class="p">)</span>
    <span class="n">all_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bg_xyz</span><span class="p">,</span> <span class="n">fg_xyz</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">all_features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bg_feature</span><span class="p">,</span> <span class="n">fg_feature</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Shuffle the points/features randomly.</span>
    <span class="n">all_points</span><span class="p">,</span> <span class="n">all_features</span> <span class="o">=</span> <span class="n">_ConsistentShuffle</span><span class="p">((</span><span class="n">all_points</span><span class="p">,</span> <span class="n">all_features</span><span class="p">),</span>
                                                  <span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>

    <span class="c1"># Padding should technically be unnecessary: the number of points before and</span>
    <span class="c1"># after should be the same, but in practice we sometimes seem to drop a few</span>
    <span class="c1"># points, and so we pad to make the shape fixed.</span>
    <span class="c1">#</span>
    <span class="c1"># TODO(vrv): Identify the source of this problem and then assert a shape</span>
    <span class="c1"># matching check.</span>
    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
          <span class="n">all_points</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">))</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
          <span class="n">all_features</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">))</span>
      <span class="n">total_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">all_points</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">([</span><span class="n">total_points</span><span class="p">]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">all_points</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span> <span class="o">=</span> <span class="n">all_features</span>

    <span class="c1"># Translate noise.</span>
    <span class="n">bboxes_xyz</span> <span class="o">=</span> <span class="n">real_bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">bboxes_xyz</span> <span class="o">+=</span> <span class="n">translate_pose</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="n">bboxes_dim</span> <span class="o">=</span> <span class="n">real_bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span>
    <span class="c1"># Rotate bboxes by their corresponding rotation.</span>
    <span class="n">bboxes_rot</span> <span class="o">=</span> <span class="n">real_bboxes_3d</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">6</span><span class="p">:]</span>
    <span class="n">bboxes_rot</span> <span class="o">-=</span> <span class="n">rotation</span><span class="p">[:,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">bboxes_xyz</span><span class="p">,</span> <span class="n">bboxes_dim</span><span class="p">,</span> <span class="n">bboxes_rot</span><span class="p">],</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">))</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">real_bboxes_3d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="RandomBBoxTransform.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomBBoxTransform.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="RandomBBoxTransform.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomBBoxTransform.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="GroundTruthAugmentor"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GroundTruthAugmentor">[docs]</a><span class="k">class</span> <span class="nc">GroundTruthAugmentor</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Augment bounding box labels and points from a database.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">    lasers.points_xyz of shape [P, 3]</span>

<span class="sd">    lasers.points_feature of shape [P, F]</span>

<span class="sd">    lasers.points_padding of shape [P]</span>

<span class="sd">    labels.bboxes_3d of shape [L, 7]</span>

<span class="sd">    labels.bboxes_3d_mask of shape [L]</span>

<span class="sd">    labels.labels of shape [L]</span>

<span class="sd">  Modifies the above features so that additional objects from</span>
<span class="sd">  a groundtruth database are added.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GroundTruthAugmentor.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GroundTruthAugmentor.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;groundtruth_database&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;If not None, loads groundtruths from this database and adds &#39;</span>
        <span class="s1">&#39;them to the current scene. Groundtruth database is expected &#39;</span>
        <span class="s1">&#39;to be a TFRecord of KITTI or Waymo crops.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;num_db_objects&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Number of objects in the database. Because we use TFRecord &#39;</span>
        <span class="s1">&#39;we cannot easily query the number of objects efficiencly.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;max_num_points_per_bbox&#39;</span><span class="p">,</span> <span class="mi">2048</span><span class="p">,</span>
             <span class="s1">&#39;Maximum number of points in each bbox to augment with.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;filter_min_points&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s1">&#39;Minimum number of points each database object must have &#39;</span>
        <span class="s1">&#39;to be included in an example.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;filter_max_points&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Maximum number of points each database object must have &#39;</span>
        <span class="s1">&#39;to be included in an example.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;difficulty_sampling_probability&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Probability for sampling ground truth example whose difficulty &#39;</span>
        <span class="s1">&#39;equals {0, 1, 2, 3, ...}. Example: [1.0, 1.0, 1.0, 1.0] for &#39;</span>
        <span class="s1">&#39;uniform sampling 4 different difficulties. Default value is &#39;</span>
        <span class="s1">&#39;None = uniform sampling for all difficulties.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;class_sampling_probability&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;Probability for sampling ground truth example based on its class index&#39;</span>
        <span class="s1">&#39; Example: For KITTI classes are [Background, Car, Van, Truck, &#39;</span>
        <span class="s1">&#39;Pedestrian, Person_sitting, Cyclist, Tram, Misc, DontCare], using &#39;</span>
        <span class="s1">&#39;probability vector [0., 1.0, 1.0, 0., 0., 0., 0.,0., 0., 0.], we &#39;</span>
        <span class="s1">&#39;uniformly sampling Car and Van. Default value is None: Uses &#39;</span>
        <span class="s1">&#39;label_filter flag and does not sample based on class.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;filter_min_difficulty&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
             <span class="s1">&#39;Filter ground truth boxes whose difficulty is &lt; this value.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;max_augmented_bboxes&#39;</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span>
             <span class="s1">&#39;Maximum number of augmented bounding boxes per scene.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;label_filter&#39;</span><span class="p">,</span> <span class="p">[],</span>
        <span class="s1">&#39;A list where if specified, only examples of these label integers will &#39;</span>
        <span class="s1">&#39;be included in an example.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;batch_mode&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Bool value to control whether the whole&#39;</span>
        <span class="s1">&#39;groundtruth database is loaded or partially loaded to save memory&#39;</span>
        <span class="s1">&#39;usage. Setting to False loads the whole ground truth database into &#39;</span>
        <span class="s1">&#39;memory. Otherwise, only a fraction of the data will be loaded into &#39;</span>
        <span class="s1">&#39;the memory.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="GroundTruthAugmentor._ReadDB"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GroundTruthAugmentor._ReadDB">[docs]</a>  <span class="k">def</span> <span class="nf">_ReadDB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_patterns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read the groundtruth database and return as a NestedMap of Tensors.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="k">def</span> <span class="nf">Process</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Process a groundtruth record.&quot;&quot;&quot;</span>
      <span class="n">feature_map</span> <span class="o">=</span> <span class="p">{</span>
          <span class="s1">&#39;num_points&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">((),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
          <span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="s1">&#39;points_feature&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="s1">&#39;bbox_3d&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
          <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">((),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
          <span class="s1">&#39;difficulty&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">FixedLenFeature</span><span class="p">((),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
          <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
      <span class="p">}</span>

      <span class="n">example_data</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">feature_map</span><span class="p">)</span>
      <span class="n">num_points</span> <span class="o">=</span> <span class="n">example_data</span><span class="p">[</span><span class="s1">&#39;num_points&#39;</span><span class="p">]</span>

      <span class="n">points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">_Dense</span><span class="p">(</span><span class="n">example_data</span><span class="p">[</span><span class="s1">&#39;points&#39;</span><span class="p">]),</span> <span class="p">[</span><span class="n">num_points</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
          <span class="n">_Dense</span><span class="p">(</span><span class="n">example_data</span><span class="p">[</span><span class="s1">&#39;points_feature&#39;</span><span class="p">]),</span> <span class="p">[</span><span class="n">num_points</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

      <span class="c1"># TODO(vrv): Use random selection instead of first N points.</span>
      <span class="n">points</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">max_num_points_per_bbox</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">max_num_points_per_bbox</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">points_mask</span><span class="p">,</span>
                                         <span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">max_num_points_per_bbox</span><span class="p">])</span>

      <span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">_Dense</span><span class="p">(</span><span class="n">example_data</span><span class="p">[</span><span class="s1">&#39;bbox_3d&#39;</span><span class="p">]),</span> <span class="p">[</span><span class="mi">7</span><span class="p">])</span>
      <span class="n">label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">example_data</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="n">difficulty</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">example_data</span><span class="p">[</span><span class="s1">&#39;difficulty&#39;</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">,</span> <span class="n">bboxes_3d</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">difficulty</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">batch_mode</span><span class="p">:</span>
      <span class="c1"># Prepare dataset for ground truth bounding boxes. Randomly shuffle the</span>
      <span class="c1"># file patterns.</span>
      <span class="n">file_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_patterns</span><span class="p">))</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stateless_list_files</span><span class="p">(</span><span class="n">file_patterns</span><span class="p">)</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stateless_cache_dataset</span><span class="p">())</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">stateless_shuffle_dataset</span><span class="p">(</span>
              <span class="n">buffer_size</span><span class="o">=</span><span class="n">file_count</span><span class="p">,</span> <span class="n">reshuffle_each_iteration</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">,</span> <span class="n">cycle_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span>
      <span class="c1"># Only prefetch a few objects from the database to reduce memory</span>
      <span class="c1"># consumption.</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
      <span class="c1"># We need more bboxes than max_augmented_bboxes in a batch, because some</span>
      <span class="c1"># of the boxes are filtered out.</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">max_augmented_bboxes</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stateless_cache_dataset</span><span class="p">())</span><span class="o">.</span><span class="n">prefetch</span><span class="p">(</span>
          <span class="n">p</span><span class="o">.</span><span class="n">max_augmented_bboxes</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Prepare dataset for ground truth bounding boxes.</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stateless_list_files</span><span class="p">(</span><span class="n">file_patterns</span><span class="p">)</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">interleave</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">TFRecordDataset</span><span class="p">,</span> <span class="n">cycle_length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
      <span class="c1"># Read the entire dataset into memory.</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">num_db_objects</span><span class="p">)</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Process</span><span class="p">,</span> <span class="n">num_parallel_calls</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
      <span class="c1"># We batch the output of the dataset into a very large Tensor, then cache</span>
      <span class="c1"># it in memory.</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">batch</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">num_db_objects</span><span class="p">)</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stateless_cache_dataset</span><span class="p">())</span><span class="o">.</span><span class="n">repeat</span><span class="p">()</span>

    <span class="n">iterator</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">make_one_shot_iterator</span><span class="p">()</span>
    <span class="n">input_batch</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">get_next</span><span class="p">()</span>

    <span class="p">(</span><span class="n">db_points_xyz</span><span class="p">,</span> <span class="n">db_points_feature</span><span class="p">,</span> <span class="n">db_points_mask</span><span class="p">,</span> <span class="n">db_bboxes</span><span class="p">,</span> <span class="n">db_labels</span><span class="p">,</span>
     <span class="n">db_difficulties</span><span class="p">)</span> <span class="o">=</span> <span class="n">input_batch</span>
    <span class="k">return</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span>
        <span class="n">points_xyz</span><span class="o">=</span><span class="n">db_points_xyz</span><span class="p">,</span>
        <span class="n">points_feature</span><span class="o">=</span><span class="n">db_points_feature</span><span class="p">,</span>
        <span class="n">points_mask</span><span class="o">=</span><span class="n">db_points_mask</span><span class="p">,</span>
        <span class="n">bboxes_3d</span><span class="o">=</span><span class="n">db_bboxes</span><span class="p">,</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">db_labels</span><span class="p">,</span>
        <span class="n">difficulties</span><span class="o">=</span><span class="n">db_difficulties</span><span class="p">)</span></div>

<div class="viewcode-block" id="GroundTruthAugmentor._CreateExampleFilter"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GroundTruthAugmentor._CreateExampleFilter">[docs]</a>  <span class="k">def</span> <span class="nf">_CreateExampleFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Construct db example filter.</span>

<span class="sd">    Args:</span>
<span class="sd">      db: NestedMap of the following Tensors: points_mask - [N, P] - The points</span>
<span class="sd">        mask for every object in the database, where N is the number of objects</span>
<span class="sd">        and P is the maximum number of points per object.  labels - [N] - int32</span>
<span class="sd">        Label for each object in the database.  difficulties - [N] - int32</span>
<span class="sd">        Difficulty for each label in the database.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A [N] boolean Tensor for each object in the database, True if</span>
<span class="sd">      that corresponding object passes the filter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">db_points_mask</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">points_mask</span>
    <span class="n">db_label</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">labels</span>
    <span class="n">db_difficulty</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">difficulties</span>

    <span class="n">num_objects_in_database</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">db_points_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Filter number of objects.</span>
    <span class="n">points_per_object</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">db_points_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">example_filter</span> <span class="o">=</span> <span class="n">points_per_object</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">filter_min_points</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">filter_max_points</span><span class="p">:</span>
      <span class="n">example_filter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
          <span class="n">example_filter</span><span class="p">,</span> <span class="n">points_per_object</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">filter_max_points</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">difficulty_sampling_probability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># Sample db based on difficulity of each example.</span>
      <span class="n">sampling_prob</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">difficulty_sampling_probability</span>
      <span class="n">db_difficulty_probability</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">db_difficulty</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">difficulty_idx</span><span class="p">,</span> <span class="n">difficulty_prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sampling_prob</span><span class="p">):</span>
        <span class="n">db_difficulty_probability</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">db_difficulty</span><span class="p">,</span> <span class="n">difficulty_idx</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span>
            <span class="n">difficulty_prob</span><span class="p">)</span>

      <span class="n">sampled_filter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">example_filter</span><span class="p">),</span>
          <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
          <span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
          <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
          <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
      <span class="n">sampled_filter</span> <span class="o">=</span> <span class="n">sampled_filter</span> <span class="o">&lt;</span> <span class="n">db_difficulty_probability</span>
      <span class="n">example_filter</span> <span class="o">&amp;=</span> <span class="n">sampled_filter</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Filter out db examples below min difficulty</span>
      <span class="n">example_filter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
          <span class="n">example_filter</span><span class="p">,</span> <span class="n">db_difficulty</span> <span class="o">&gt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">filter_min_difficulty</span><span class="p">)</span>

    <span class="n">example_filter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">example_filter</span><span class="p">,</span> <span class="p">[</span><span class="n">num_objects_in_database</span><span class="p">])</span>
    <span class="n">db_label</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">db_label</span><span class="p">,</span> <span class="p">[</span><span class="n">num_objects_in_database</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">class_sampling_probability</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># Sample example based on its class probability.</span>
      <span class="n">sampling_prob</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">class_sampling_probability</span>
      <span class="n">db_class_probability</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">db_label</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

      <span class="k">for</span> <span class="n">class_idx</span><span class="p">,</span> <span class="n">class_prob</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sampling_prob</span><span class="p">):</span>
        <span class="n">db_class_probability</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">db_label</span><span class="p">,</span> <span class="n">class_idx</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">*</span> <span class="n">class_prob</span><span class="p">)</span>

      <span class="n">sampled_filter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">example_filter</span><span class="p">),</span>
          <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
          <span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
          <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
          <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span>
      <span class="n">sampled_filter</span> <span class="o">=</span> <span class="n">sampled_filter</span> <span class="o">&lt;</span> <span class="n">db_class_probability</span>
      <span class="n">example_filter</span> <span class="o">&amp;=</span> <span class="n">sampled_filter</span>
    <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">label_filter</span><span class="p">:</span>
      <span class="c1"># Filter based on labels.</span>
      <span class="c1"># Create a label filter where all is false</span>
      <span class="n">valid_labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">label_filter</span><span class="p">)</span>
      <span class="n">label_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_any</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">db_label</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">valid_labels</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
      <span class="n">example_filter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">example_filter</span><span class="p">,</span> <span class="n">label_mask</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">example_filter</span></div>

  <span class="c1"># TODO(vrv): Create an overlap filter that also ensures that boxes don&#39;t</span>
  <span class="c1"># overlap with groundtruth points, so that the scenes are more plausible.</span>
<div class="viewcode-block" id="GroundTruthAugmentor._FilterIndices"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GroundTruthAugmentor._FilterIndices">[docs]</a>  <span class="k">def</span> <span class="nf">_FilterIndices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gt_bboxes_3d</span><span class="p">,</span> <span class="n">db_bboxes</span><span class="p">,</span> <span class="n">db_idx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify database boxes that don&#39;t overlap with other boxes.&quot;&quot;&quot;</span>
    <span class="c1"># We accomplish overlap filtering by first computing the pairwise 3D IoU of</span>
    <span class="c1"># all boxes (concatenated) as a way of computing pairwise box overlaps.</span>
    <span class="n">num_gt_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">gt_bboxes_3d</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">filtered_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">db_bboxes</span><span class="p">,</span> <span class="n">db_idx</span><span class="p">)</span>
    <span class="n">all_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gt_bboxes_3d</span><span class="p">,</span> <span class="n">filtered_bboxes</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">pairwise_overlap</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">pairwise_iou3d</span><span class="p">(</span><span class="n">all_bboxes</span><span class="p">,</span> <span class="n">all_bboxes</span><span class="p">)</span>

    <span class="c1"># We now have an M x M matrix with 1s on the diagonal and non-zero entries</span>
    <span class="c1"># whenever a box collides with another.</span>
    <span class="c1">#</span>
    <span class="c1"># To increase the number of boxes selected, we filter the upper triangular</span>
    <span class="c1"># entries so that the boxes are chosen greedily: boxes with smaller indices</span>
    <span class="c1"># will be selected before later boxes, because earlier boxes will not appear</span>
    <span class="c1"># to collide with later boxes, but later boxes may collide with earlier</span>
    <span class="c1"># ones.</span>
    <span class="n">pairwise_overlap</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">band_part</span><span class="p">(</span><span class="n">pairwise_overlap</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># We compute the sum of the IoU overlaps for all database boxes.</span>
    <span class="n">db_overlap_sums</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">pairwise_overlap</span><span class="p">[</span><span class="n">num_gt_bboxes</span><span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Those boxes that don&#39;t overlap with any other boxes will only have</span>
    <span class="c1"># a 1.0 IoU with itself.</span>
    <span class="n">non_overlapping_boxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">db_overlap_sums</span> <span class="o">&lt;=</span> <span class="mf">1.</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Filter to select only those object ids that pass this filter.</span>
    <span class="n">db_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">db_idx</span><span class="p">,</span> <span class="n">non_overlapping_boxes</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">db_idx</span></div>

<div class="viewcode-block" id="GroundTruthAugmentor.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GroundTruthAugmentor.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">tf</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Loading groundtruth database at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">groundtruth_database</span><span class="p">))</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">groundtruth_database</span><span class="o">.</span><span class="n">Instantiate</span><span class="p">()</span><span class="o">.</span><span class="n">BuildDataSource</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ReadDB</span><span class="p">)</span><span class="o">.</span><span class="n">data</span>

    <span class="n">original_features_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">)</span>

    <span class="c1"># Compute the number of bboxes to augment.</span>
    <span class="n">num_bboxes_in_scene</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
    <span class="n">max_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">num_augmented_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">max_bboxes</span> <span class="o">-</span> <span class="n">num_bboxes_in_scene</span><span class="p">,</span>
                                      <span class="n">p</span><span class="o">.</span><span class="n">max_augmented_bboxes</span><span class="p">)</span>

    <span class="c1"># Compute an object index over all objects in the database.</span>
    <span class="n">num_objects_in_database</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">db_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">num_objects_in_database</span><span class="p">)</span>

    <span class="c1"># Find those indices whose examples pass the filters, and select only those</span>
    <span class="c1"># indices.</span>
    <span class="n">example_filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CreateExampleFilter</span><span class="p">(</span><span class="n">db</span><span class="p">)</span>
    <span class="n">db_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">db_idx</span><span class="p">,</span> <span class="n">example_filter</span><span class="p">)</span>

    <span class="c1"># At this point, we might still have a large number of object candidates,</span>
    <span class="c1"># from which we only need a sample.</span>
    <span class="c1"># To reduce the amount of computation, we randomly subsample to slightly</span>
    <span class="c1"># more than we want to augment.</span>
    <span class="n">db_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span>
        <span class="n">db_idx</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_augmented_bboxes</span> <span class="o">*</span> <span class="mi">5</span><span class="p">]</span>

    <span class="c1"># After filtering, further filter out the db boxes that would occlude with</span>
    <span class="c1"># other boxes (including other database boxes).</span>
    <span class="c1">#</span>
    <span class="c1"># Gather the filtered ground truth bounding boxes according to the mask, so</span>
    <span class="c1"># we can compute overlaps below.</span>
    <span class="n">gt_bboxes_3d_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="n">gt_bboxes_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">,</span> <span class="n">gt_bboxes_3d_mask</span><span class="p">)</span>
    <span class="n">gt_bboxes_3d</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">gt_bboxes_3d</span><span class="p">,</span> <span class="p">[</span><span class="n">num_bboxes_in_scene</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
    <span class="n">db_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_FilterIndices</span><span class="p">(</span><span class="n">gt_bboxes_3d</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">,</span> <span class="n">db_idx</span><span class="p">)</span>

    <span class="c1"># From the filtered object ids, select only as many boxes as we need.</span>
    <span class="n">shuffled_idx</span> <span class="o">=</span> <span class="n">db_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">num_augmented_bboxes</span><span class="p">]</span>
    <span class="n">num_augmented_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">shuffled_idx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Gather based off the indices.</span>
    <span class="n">sampled_points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">shuffled_idx</span><span class="p">)</span>
    <span class="n">sampled_points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">points_feature</span><span class="p">,</span> <span class="n">shuffled_idx</span><span class="p">)</span>
    <span class="n">sampled_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">points_mask</span><span class="p">,</span> <span class="n">shuffled_idx</span><span class="p">),</span>
        <span class="p">[</span><span class="n">num_augmented_bboxes</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">max_num_points_per_bbox</span><span class="p">])</span>
    <span class="n">sampled_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">bboxes_3d</span><span class="p">,</span> <span class="n">shuffled_idx</span><span class="p">)</span>
    <span class="n">sampled_labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">shuffled_idx</span><span class="p">)</span>

    <span class="c1"># Mask points/features.</span>
    <span class="n">sampled_points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">sampled_points_xyz</span><span class="p">,</span> <span class="n">sampled_mask</span><span class="p">)</span>
    <span class="n">sampled_points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">sampled_points_feature</span><span class="p">,</span>
                                             <span class="n">sampled_mask</span><span class="p">)</span>

    <span class="c1"># Flatten before concatenation with ground truths.</span>
    <span class="n">sampled_points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sampled_points_xyz</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">sampled_points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sampled_points_feature</span><span class="p">,</span>
                                        <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">original_features_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
    <span class="n">sampled_bboxes</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">sampled_bboxes</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>

    <span class="c1"># Concatenate the samples with the ground truths.</span>
    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
      <span class="c1"># Densify the original points.</span>
      <span class="n">dense_points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span>
                                         <span class="n">points_mask</span><span class="p">)</span>
      <span class="n">dense_points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">,</span>
                                             <span class="n">points_mask</span><span class="p">)</span>

      <span class="c1"># Concatenate the dense original points with our new sampled oints.</span>
      <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dense_points_xyz</span><span class="p">,</span> <span class="n">sampled_points_xyz</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dense_points_feature</span><span class="p">,</span> <span class="n">sampled_points_feature</span><span class="p">],</span>
                                 <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">original_points_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">)</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span>
                                                        <span class="n">original_points_shape</span><span class="p">)</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
          <span class="n">points_feature</span><span class="p">,</span> <span class="n">original_features_shape</span><span class="p">)</span>
      <span class="c1"># Compute the modified mask / padding.</span>
      <span class="n">final_points_mask</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span><span class="p">))</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">-</span> <span class="n">final_points_mask</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">sampled_points_xyz</span><span class="p">],</span>
                             <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
          <span class="p">[</span><span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">,</span> <span class="n">sampled_points_feature</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">points_xyz</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span> <span class="o">=</span> <span class="n">points_feature</span>

    <span class="c1"># Reconstruct a new, dense, bboxes_3d vector that includes the filtered</span>
    <span class="c1"># groundtruth bounding boxes followed by the database augmented boxes.</span>
    <span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gt_bboxes_3d</span><span class="p">,</span> <span class="n">sampled_bboxes</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">bboxes_3d</span><span class="p">,</span> <span class="p">[</span><span class="n">max_bboxes</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d</span> <span class="o">=</span> <span class="n">bboxes_3d</span>
    <span class="n">bboxes_3d_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
        <span class="n">num_bboxes_in_scene</span> <span class="o">+</span> <span class="n">num_augmented_bboxes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">bboxes_3d_mask</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span>
        <span class="n">bboxes_3d_mask</span><span class="p">,</span> <span class="p">[</span><span class="n">max_bboxes</span><span class="p">])</span>

    <span class="n">gt_labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">gt_bboxes_3d_mask</span><span class="p">)</span>
    <span class="n">gt_labels</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">gt_labels</span><span class="p">,</span> <span class="p">[</span><span class="n">num_bboxes_in_scene</span><span class="p">])</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">gt_labels</span><span class="p">,</span> <span class="n">sampled_labels</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadOrTrimTo</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="p">[</span><span class="n">max_bboxes</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="GroundTruthAugmentor.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GroundTruthAugmentor.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="GroundTruthAugmentor.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.GroundTruthAugmentor.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="FrustumDropout"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FrustumDropout">[docs]</a><span class="k">class</span> <span class="nc">FrustumDropout</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Randomly drops out points in a frustum.</span>

<span class="sd">  All points are first converted to spherical coordinates, and then a point</span>
<span class="sd">  is randomly selected. All points in the frustum around that point within</span>
<span class="sd">  a given phi, theta angle width and distance to the original greater than</span>
<span class="sd">  a given value are dropped with probability = 1 - keep_prob.</span>

<span class="sd">  Here, we can specify whether the dropped frustum is the union or intersection</span>
<span class="sd">  of the phi and theta angle filters.</span>


<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - lasers.points_feature of shape [P, F]</span>

<span class="sd">  Optionally points_padding of shape [P] corresponding to the padding.</span>
<span class="sd">  if points_padding is None, then all points are considered valid.</span>

<span class="sd">  Modifies the following features:</span>
<span class="sd">    lasers.points_xyz, lasers.points_feature, lasers.points_padding with points</span>
<span class="sd">    randomly dropped out.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FrustumDropout.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FrustumDropout.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;theta_width&#39;</span><span class="p">,</span> <span class="mf">0.03</span><span class="p">,</span> <span class="s1">&#39;Theta angle width for dropping points.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;phi_width&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;Phi angle width for dropping points.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;distance&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;Drop points that have larger distance to the&#39;</span>
        <span class="s1">&#39;origin than the value given here.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;keep_prob&#39;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s1">&#39;keep_prob: 1. = drop no points in the Frustum,&#39;</span>
        <span class="s1">&#39;0 = drop all points, between 0 and 1 = down sample the points.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;drop_type&#39;</span><span class="p">,</span> <span class="s1">&#39;union&#39;</span><span class="p">,</span> <span class="s1">&#39;Drop either the union or intersection of &#39;</span>
        <span class="s1">&#39;phi width and theta width.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">phi_width</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;phi_width must be &gt;= 0, phi_width=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">p</span><span class="o">.</span><span class="n">phi_width</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">theta_width</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;theta_width must be &gt;= 0, theta_width=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">p</span><span class="o">.</span><span class="n">theta_width</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;distance must be &gt;= 0, distance=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">distance</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_prob</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_prob</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;keep_prob must be &gt;= 0 and &lt;=1, keep_prob=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
          <span class="n">p</span><span class="o">.</span><span class="n">keep_prob</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">drop_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;union&#39;</span><span class="p">,</span> <span class="s1">&#39;intersection&#39;</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;drop_type must be union or intersection ,&#39;</span>
                       <span class="s1">&#39;drop_type=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">drop_type</span><span class="p">))</span>

<div class="viewcode-block" id="FrustumDropout.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FrustumDropout.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span>
    <span class="n">points_feature</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span>
    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="p">:</span>
      <span class="n">points_padding</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">points_padding</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">points_padding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">points_padding</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
      <span class="n">num_total_points</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">points_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">real_points_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_total_points</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">points_mask</span><span class="p">)</span>
      <span class="n">num_points</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">real_points_idx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
      <span class="n">num_total_points</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">points_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">num_points</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">r</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unstack</span><span class="p">(</span>
        <span class="n">geometry</span><span class="o">.</span><span class="n">SphericalCoordinatesTransform</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">),</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_PickRandomPoint</span><span class="p">():</span>
      <span class="n">point_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">((),</span>
                                    <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                    <span class="n">maxval</span><span class="o">=</span><span class="n">num_points</span><span class="p">,</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">points_padding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">point_idx</span> <span class="o">=</span> <span class="n">real_points_idx</span><span class="p">[</span><span class="n">point_idx</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">point_idx</span>

    <span class="c1"># Pick a point at random and drop all points that are near that point in the</span>
    <span class="c1"># frustum for distance larger than r; repeat this for both theta and phi.</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">theta_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">theta_half_width</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">theta_width</span> <span class="o">/</span> <span class="mf">2.</span>
      <span class="n">point_idx</span> <span class="o">=</span> <span class="n">_PickRandomPoint</span><span class="p">()</span>
      <span class="c1"># Points within theta width and further than distance will be dropped.</span>
      <span class="n">theta_drop_filter</span> <span class="o">=</span> <span class="p">((</span><span class="n">theta</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">point_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">theta_half_width</span><span class="p">))</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">theta</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">point_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">theta_half_width</span><span class="p">))</span> <span class="o">&amp;</span>
                           <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">distance</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">theta_drop_filter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">points_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">phi_width</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">phi_half_width</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">phi_width</span> <span class="o">/</span> <span class="mf">2.</span>
      <span class="n">point_idx</span> <span class="o">=</span> <span class="n">_PickRandomPoint</span><span class="p">()</span>
      <span class="c1"># Points within phi width and further than distance will be dropped.</span>
      <span class="n">phi_drop_filter</span> <span class="o">=</span> <span class="p">((</span><span class="n">phi</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">point_idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">phi_half_width</span><span class="p">))</span> <span class="o">&amp;</span>
                         <span class="p">(</span><span class="n">phi</span> <span class="o">&gt;</span>
                          <span class="p">(</span><span class="n">phi</span><span class="p">[</span><span class="n">point_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">phi_half_width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">distance</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">phi_drop_filter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">points_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

    <span class="c1">#  Create drop_filter by combining filters. This contains a filter for the</span>
    <span class="c1">#  points to be removed. One can use the intersection method to limit the</span>
    <span class="c1">#  dropped points be within both phi and theta ranges.</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">drop_type</span> <span class="o">==</span> <span class="s1">&#39;union&#39;</span><span class="p">:</span>
      <span class="n">drop_filter</span> <span class="o">=</span> <span class="n">theta_drop_filter</span> <span class="o">|</span> <span class="n">phi_drop_filter</span>
    <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">drop_type</span> <span class="o">==</span> <span class="s1">&#39;intersection&#39;</span><span class="p">:</span>
      <span class="n">drop_filter</span> <span class="o">=</span> <span class="n">theta_drop_filter</span> <span class="o">&amp;</span> <span class="n">phi_drop_filter</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_prob</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
      <span class="c1"># Drop all points in drop_filter.</span>
      <span class="n">down_sampling_filter</span> <span class="o">=</span> <span class="n">drop_filter</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Randomly drop points in drop_filter based on keep_prob.</span>
      <span class="n">sampling_drop_filter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="n">num_total_points</span><span class="p">],</span>
                                               <span class="n">minval</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                               <span class="n">maxval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                               <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="c1"># Points greater than the threshold (keep_prob) will be dropped.</span>
      <span class="n">sampling_drop_filter</span> <span class="o">=</span> <span class="n">sampling_drop_filter</span> <span class="o">&gt;</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_prob</span>

      <span class="c1"># Instead of dropping all points in the frustum, we drop out points</span>
      <span class="c1"># that are in the selected frustum (drop_filter).</span>
      <span class="n">down_sampling_filter</span> <span class="o">=</span> <span class="n">drop_filter</span> <span class="o">&amp;</span> <span class="n">sampling_drop_filter</span>

    <span class="n">points_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">down_sampling_filter</span>

    <span class="k">if</span> <span class="n">points_padding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_padding</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">points_mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>
      <span class="n">features</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points_feature</span><span class="p">,</span>
                                                       <span class="n">points_mask</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="FrustumDropout.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FrustumDropout.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="FrustumDropout.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.FrustumDropout.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="RepeatPreprocessor"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RepeatPreprocessor">[docs]</a><span class="k">class</span> <span class="nc">RepeatPreprocessor</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Repeat a preprocessor multiple times.</span>

<span class="sd">  This preprocessor takes a preprocessor as a subprocessor and apply the</span>
<span class="sd">  subprocessor to features multiple times (repeat_count).</span>

<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RepeatPreprocessor.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RepeatPreprocessor.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;repeat_count&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;Number of times the subprocessor is applied to&#39;</span>
             <span class="s1">&#39; features.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;subprocessor&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;One of the input preprocessors.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">subprocessor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No subprocessor was specified for RepeatPreprocessor.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">repeat_count</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">repeat_count</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;repeat_count must be &gt;= 0 and int, repeat_count=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">p</span><span class="o">.</span><span class="n">repeat_count</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">CreateChild</span><span class="p">(</span><span class="s1">&#39;subprocessor&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">subprocessor</span><span class="p">)</span>

<div class="viewcode-block" id="RepeatPreprocessor.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RepeatPreprocessor.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">repeat_count</span><span class="p">):</span>
      <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocessor</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">features</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="RepeatPreprocessor.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RepeatPreprocessor.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">repeat_count</span><span class="p">):</span>
      <span class="n">shapes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocessor</span><span class="o">.</span><span class="n">TransformShapes</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="RepeatPreprocessor.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RepeatPreprocessor.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">repeat_count</span><span class="p">):</span>
      <span class="n">dtypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocessor</span><span class="o">.</span><span class="n">TransformDTypes</span><span class="p">(</span><span class="n">dtypes</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="RandomApplyPreprocessor"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomApplyPreprocessor">[docs]</a><span class="k">class</span> <span class="nc">RandomApplyPreprocessor</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Randomly apply a preprocessor with certain probability.</span>

<span class="sd">  This preprocessor takes a preprocessor as a subprocessor and apply the</span>
<span class="sd">  subprocessor to features with certain probability.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomApplyPreprocessor.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomApplyPreprocessor.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;prob&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;The probability the subprocessor being executed.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;subprocessor&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Params for an input preprocessor.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">subprocessor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No subprocessor was specified for RepeatPreprocessor.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">prob</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">prob</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">prob</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;prob must be &gt;= 0 and &lt;=1 and float type, prob=</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">prob</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">CreateChild</span><span class="p">(</span><span class="s1">&#39;subprocessor&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">subprocessor</span><span class="p">)</span>

<div class="viewcode-block" id="RandomApplyPreprocessor.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomApplyPreprocessor.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">choice</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span>
        <span class="p">(),</span> <span class="n">minval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">p</span><span class="o">.</span><span class="n">prob</span>
    <span class="c1"># Features is passed downstream and may be modified, we make deep copies</span>
    <span class="c1"># here to use with tf.cond to avoid having tf.cond access updated</span>
    <span class="c1"># versions. Note that we need one copy for each branch in case the branches</span>
    <span class="c1"># further modify features.</span>
    <span class="n">features_0</span><span class="p">,</span> <span class="n">features_1</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">(),</span> <span class="n">features</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">()</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">choice</span><span class="p">,</span>
                       <span class="k">lambda</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocessor</span><span class="o">.</span><span class="n">TransformFeatures</span><span class="p">(</span><span class="n">features_0</span><span class="p">),</span>
                       <span class="k">lambda</span><span class="p">:</span> <span class="n">features_1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="RandomApplyPreprocessor.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomApplyPreprocessor.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">shapes_transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocessor</span><span class="o">.</span><span class="n">TransformShapes</span><span class="p">(</span><span class="n">shapes</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">shapes</span><span class="o">.</span><span class="n">IsCompatible</span><span class="p">(</span><span class="n">shapes_transformed</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;NestedMap structures are different between shapes and transformed&#39;</span>
          <span class="s1">&#39;shapes. Original shapes: </span><span class="si">{}</span><span class="s1">. Transformed shapes: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">shapes</span><span class="p">,</span> <span class="n">shapes_transformed</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">IsCompatibleWith</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">a</span><span class="o">.</span><span class="n">is_compatible_with</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span>
        <span class="n">py_utils</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span>
            <span class="n">py_utils</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">IsCompatibleWith</span><span class="p">,</span> <span class="n">shapes</span><span class="p">,</span> <span class="n">shapes_transformed</span><span class="p">))):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Shapes after transformation - </span><span class="si">{}</span><span class="s1"> are different from original &#39;</span>
          <span class="s1">&#39;shapes - </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">shapes_transformed</span><span class="p">,</span> <span class="n">shapes</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="RandomApplyPreprocessor.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomApplyPreprocessor.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">transformed_dtypes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocessor</span><span class="o">.</span><span class="n">TransformDTypes</span><span class="p">(</span><span class="n">dtypes</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">transformed_dtypes</span> <span class="o">!=</span> <span class="n">dtypes</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;DTypes after transformation of preprocessor - </span><span class="si">{}</span><span class="s1"> should be &#39;</span>
          <span class="s1">&#39;the same as </span><span class="si">{}</span><span class="s1">, but get </span><span class="si">{}</span><span class="s1">.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">subprocessor</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">,</span>
                                               <span class="n">transformed_dtypes</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="ConstantPreprocessor"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.ConstantPreprocessor">[docs]</a><span class="k">class</span> <span class="nc">ConstantPreprocessor</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Preprocessor that produces specified constant values in a nested output.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConstantPreprocessor.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.ConstantPreprocessor.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;constants&#39;</span><span class="p">,</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(),</span>
        <span class="s1">&#39;Map of key names to numpy arrays of constant values to use. &#39;</span>
        <span class="s1">&#39;Must be a NestedMap or dict convertible to NestedMap.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="ConstantPreprocessor.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.ConstantPreprocessor.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">constants</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">constants</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="ConstantPreprocessor.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.ConstantPreprocessor.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">constants</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">constants</span><span class="p">)</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">constants</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="ConstantPreprocessor.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.ConstantPreprocessor.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">constants</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">constants</span><span class="p">)</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">as_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="IdentityPreprocessor"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.IdentityPreprocessor">[docs]</a><span class="k">class</span> <span class="nc">IdentityPreprocessor</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Preprocessor that passes all inputs through.</span>

<span class="sd">  This may be useful for situations where one wants a &#39;no-op&#39; preprocessor, such</span>
<span class="sd">  as being able to randomly choose to do nothing among a set of preprocessor</span>
<span class="sd">  choices.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="IdentityPreprocessor.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.IdentityPreprocessor.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="IdentityPreprocessor.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.IdentityPreprocessor.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="IdentityPreprocessor.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.IdentityPreprocessor.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>


<div class="viewcode-block" id="RandomChoicePreprocessor"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomChoicePreprocessor">[docs]</a><span class="k">class</span> <span class="nc">RandomChoicePreprocessor</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Randomly applies a preprocessor with specified weights.</span>

<span class="sd">  The input at features[p.weight_tensor_key] must be a floating point vector</span>
<span class="sd">  Tensor whose length matches the number of subprocessors to select among. The</span>
<span class="sd">  values in that Tensor are interpreted as relative weights.</span>

<span class="sd">  For example, if p.subprocessors = [preprocessor1, preprocessor2] and the</span>
<span class="sd">  weights are [1., 2.], then preprocessor1 will be applied with probability 1/3,</span>
<span class="sd">  and preprocessor2 will be applied with probability 2/3.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RandomChoicePreprocessor.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomChoicePreprocessor.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;subprocessors&#39;</span><span class="p">,</span> <span class="p">[],</span>
        <span class="s1">&#39;Params for preprocessors. Each value should be a tuple of &#39;</span>
        <span class="s1">&#39;(Preprocessor.Params(), BaseSchedule.Params()), where the schedule &#39;</span>
        <span class="s1">&#39;defines the weights to use over time.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">subprocessors</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No subprocessors were specified.&#39;</span><span class="p">)</span>

    <span class="n">subprocessors</span><span class="p">,</span> <span class="n">schedules</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="o">.</span><span class="n">subprocessors</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_FilterNonSchedules</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
      <span class="k">return</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;cls&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="n">schedule</span><span class="o">.</span><span class="n">BaseSchedule</span><span class="p">)</span>

    <span class="n">invalid_values</span> <span class="o">=</span> <span class="p">[</span><span class="n">_FilterNonSchedules</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">schedules</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">invalid_values</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Not all schedule values were schedules: &#39;</span>
                      <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">invalid_values</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">CreateChildren</span><span class="p">(</span><span class="s1">&#39;subprocessors&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">subprocessors</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">CreateChildren</span><span class="p">(</span><span class="s1">&#39;schedules&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">schedules</span><span class="p">))</span>

<div class="viewcode-block" id="RandomChoicePreprocessor.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomChoicePreprocessor.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">choice_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">weight_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Pass a unique copy of the input to each branch, in case the</span>
    <span class="c1"># subprocessor destructively modifies the features in unexpected ways.</span>
    <span class="k">for</span> <span class="n">subp</span><span class="p">,</span> <span class="n">sched</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subprocessors</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schedules</span><span class="p">):</span>
      <span class="n">choice_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
          <span class="k">lambda</span> <span class="n">subp</span><span class="o">=</span><span class="n">subp</span><span class="p">:</span> <span class="n">subp</span><span class="o">.</span><span class="n">TransformFeatures</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">()))</span>
      <span class="n">weight_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sched</span><span class="o">.</span><span class="n">Value</span><span class="p">())</span>

    <span class="n">weight_tensor</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">weight_list</span><span class="p">)</span>
    <span class="n">chosen_bin</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">categorical</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">weight_tensor</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]),</span>
        <span class="mi">1</span><span class="p">,</span>
        <span class="n">seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">switch_case</span><span class="p">(</span><span class="n">chosen_bin</span><span class="p">,</span> <span class="n">branch_fns</span><span class="o">=</span><span class="n">choice_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="RandomChoicePreprocessor.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomChoicePreprocessor.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">transformed_shapes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">subp</span><span class="o">.</span><span class="n">TransformShapes</span><span class="p">(</span><span class="n">shapes</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">())</span> <span class="k">for</span> <span class="n">subp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocessors</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">transformed_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">curr</span> <span class="k">for</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">transformed_shapes</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Shapes after transformations were not identical: &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">transformed_shapes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transformed_shapes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="RandomChoicePreprocessor.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.RandomChoicePreprocessor.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">transformed_dtypes</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">subp</span><span class="o">.</span><span class="n">TransformDTypes</span><span class="p">(</span><span class="n">dtypes</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">())</span> <span class="k">for</span> <span class="n">subp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subprocessors</span>
    <span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">transformed_dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">curr</span> <span class="k">for</span> <span class="n">curr</span> <span class="ow">in</span> <span class="n">transformed_dtypes</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;DTypes after transformations were not identical: &#39;</span>
                       <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">transformed_dtypes</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">transformed_dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="SparseSampler"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseSampler">[docs]</a><span class="k">class</span> <span class="nc">SparseSampler</span><span class="p">(</span><span class="n">Preprocessor</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Fused SparseCenterSelector and SparseCellGatherFeatures.</span>

<span class="sd">  This preprocessor expects features to contain the following keys:</span>
<span class="sd">  - lasers.points_xyz of shape [P, 3]</span>
<span class="sd">  - lasers.points_feature of shape [P, F]</span>

<span class="sd">  Adds the following features:</span>
<span class="sd">    anchor_centers - [num_centers, 3] - Floating point output containing the</span>
<span class="sd">    center (x, y, z) locations for tiling anchor boxes.</span>

<span class="sd">    cell_center_xyz - [num_centers, 3] - Floating point output containing</span>
<span class="sd">    the center (x, y, z) locations for each cell to featurize.</span>

<span class="sd">    cell_center_padding - [num_centers] - 0/1 padding for each center.</span>

<span class="sd">    cell_points_xyz - [num_centers, num_neighbors, 3] - Floating point</span>
<span class="sd">    output containing the (x, y, z) locations for each point for a given</span>
<span class="sd">    center.</span>

<span class="sd">    cell_feature - [num_centers, num_neighbors, F] - Floating point output</span>
<span class="sd">    containing the features for each point for a given center.</span>

<span class="sd">    cell_points_padding - [num_centers, num_neighbors] - 0/1 padding</span>
<span class="sd">    for the points in each cell.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SparseSampler.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseSampler.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;center_selector&#39;</span><span class="p">,</span> <span class="s1">&#39;farthest&#39;</span><span class="p">,</span> <span class="s1">&#39;Method to sample centers. &#39;</span>
             <span class="s1">&#39;Valid options - uniform, farthest.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;neighbor_sampler&#39;</span><span class="p">,</span> <span class="s1">&#39;uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;Method to select neighbors. &#39;</span>
             <span class="s1">&#39;Valid options - uniform, closest.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;num_centers&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="s1">&#39;The number of centers to sample.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;features_preparation_layers&#39;</span><span class="p">,</span> <span class="p">[],</span>
        <span class="s1">&#39;A list of Params for layers to run on the features before &#39;</span>
        <span class="s1">&#39;performing farthest point sampling. For example, one may wish to &#39;</span>
        <span class="s1">&#39;drop points out of frustum for KITTI before selecting centers. &#39;</span>
        <span class="s1">&#39;Note that these layers will not mutate the original features, &#39;</span>
        <span class="s1">&#39;instead, a copy will be made.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;keep_z_range&#39;</span><span class="p">,</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
        <span class="s1">&#39;Only points that have z coordinates within this range are kept. &#39;</span>
        <span class="s1">&#39;Approximate ground-removal can be performed by specifying a &#39;</span>
        <span class="s1">&#39;lower-bound on the z-range.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;num_neighbors&#39;</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="s1">&#39;Sample these many points within the &#39;</span>
             <span class="s1">&#39;neighorhood.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;max_distance&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="s1">&#39;Points with L2 distances from a center &#39;</span>
        <span class="s1">&#39;larger than this threshold are not considered to be in the &#39;</span>
        <span class="s1">&#39;neighborhood.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">features_preparation_layers</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">CreateChildren</span><span class="p">(</span><span class="s1">&#39;features_preparation_layers&#39;</span><span class="p">,</span>
                          <span class="n">p</span><span class="o">.</span><span class="n">features_preparation_layers</span><span class="p">)</span>

<div class="viewcode-block" id="SparseSampler.TransformFeatures"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseSampler.TransformFeatures">[docs]</a>  <span class="k">def</span> <span class="nf">TransformFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">num_centers</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_neighbors</span>

    <span class="n">prepared_features</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">DeepCopy</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">features_preparation_layers</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">prep_layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_preparation_layers</span><span class="p">:</span>
        <span class="n">prepared_features</span> <span class="o">=</span> <span class="n">prep_layer</span><span class="o">.</span><span class="n">FPropDefaultTheta</span><span class="p">(</span><span class="n">prepared_features</span><span class="p">)</span>

    <span class="n">points_data</span> <span class="o">=</span> <span class="n">prepared_features</span><span class="o">.</span><span class="n">lasers</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">points_data</span><span class="o">.</span><span class="n">points_xyz</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>

    <span class="k">if</span> <span class="s1">&#39;points_padding&#39;</span> <span class="ow">in</span> <span class="n">points_data</span><span class="p">:</span>
      <span class="n">points_mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">points_data</span><span class="o">.</span><span class="n">points_padding</span>
      <span class="n">points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">points_mask</span><span class="p">)</span>

    <span class="c1"># If num_points &lt; num_centers, pad points to have at least num_centers</span>
    <span class="c1"># points.</span>
    <span class="n">num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">points</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">required_num_points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_centers</span><span class="p">)</span>
    <span class="n">zeros</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">required_num_points</span> <span class="o">-</span> <span class="n">num_points</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">points</span><span class="p">,</span> <span class="n">zeros</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">num_seeded_points</span> <span class="o">=</span> <span class="n">points_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;num_seeded_points&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">neighbor_algorithm</span> <span class="o">=</span> <span class="s1">&#39;auto&#39;</span>
    <span class="c1"># Based on benchmarks, the hash solution works better when the number of</span>
    <span class="c1"># centers is &gt;= 16 and there are at least 10k points per point cloud.</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">num_centers</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">:</span>
      <span class="n">neighbor_algorithm</span> <span class="o">=</span> <span class="s1">&#39;hash&#39;</span>

    <span class="n">centers</span><span class="p">,</span> <span class="n">center_paddings</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span> <span class="n">indices_paddings</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">sample_points</span><span class="p">(</span>
        <span class="n">points</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">points_padding</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">required_num_points</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
        <span class="n">num_seeded_points</span><span class="o">=</span><span class="n">num_seeded_points</span><span class="p">,</span>
        <span class="n">center_selector</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">center_selector</span><span class="p">,</span>
        <span class="n">neighbor_sampler</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">neighbor_sampler</span><span class="p">,</span>
        <span class="n">neighbor_algorithm</span><span class="o">=</span><span class="n">neighbor_algorithm</span><span class="p">,</span>
        <span class="n">num_centers</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">num_centers</span><span class="p">,</span>
        <span class="n">center_z_min</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">keep_z_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">center_z_max</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">keep_z_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">num_neighbors</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">num_neighbors</span><span class="p">,</span>
        <span class="n">max_distance</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">max_distance</span><span class="p">,</span>
        <span class="n">random_seed</span><span class="o">=</span><span class="n">p</span><span class="o">.</span><span class="n">random_seed</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">random_seed</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">centers</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">center_paddings</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">center_paddings</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">indices_paddings</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span><span class="n">indices_paddings</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">])[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">features</span><span class="o">.</span><span class="n">cell_center_padding</span> <span class="o">=</span> <span class="n">center_paddings</span>
    <span class="n">features</span><span class="o">.</span><span class="n">cell_center_xyz</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">centers</span><span class="p">),</span> <span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">features</span><span class="o">.</span><span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">features</span><span class="o">.</span><span class="n">cell_center_xyz</span>
    <span class="n">features</span><span class="o">.</span><span class="n">cell_points_xyz</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">HasShape</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">indices</span><span class="p">),</span> <span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">features</span><span class="o">.</span><span class="n">cell_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">points_data</span><span class="o">.</span><span class="n">points_feature</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
    <span class="n">features</span><span class="o">.</span><span class="n">cell_points_padding</span> <span class="o">=</span> <span class="n">indices_paddings</span>
    <span class="k">return</span> <span class="n">features</span></div>

<div class="viewcode-block" id="SparseSampler.TransformShapes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseSampler.TransformShapes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformShapes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shapes</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">num_centers</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">num_neighbors</span><span class="p">,</span> <span class="n">shapes</span><span class="o">.</span><span class="n">lasers</span><span class="o">.</span><span class="n">points_feature</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">cell_center_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">n</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">cell_center_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">cell_points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">cell_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">f</span><span class="p">])</span>
    <span class="n">shapes</span><span class="o">.</span><span class="n">cell_points_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">([</span><span class="n">n</span><span class="p">,</span> <span class="n">m</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">shapes</span></div>

<div class="viewcode-block" id="SparseSampler.TransformDTypes"><a class="viewcode-back" href="../../../../lingvo.tasks.car.input_preprocessors.html#lingvo.tasks.car.input_preprocessors.SparseSampler.TransformDTypes">[docs]</a>  <span class="k">def</span> <span class="nf">TransformDTypes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtypes</span><span class="p">):</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">anchor_centers</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">cell_center_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">cell_center_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">cell_points_xyz</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">cell_feature</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="n">dtypes</span><span class="o">.</span><span class="n">cell_points_padding</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span>
    <span class="k">return</span> <span class="n">dtypes</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>