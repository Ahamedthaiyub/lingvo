<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lingvo.tasks.mt.input_generator &mdash; Lingvo  documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../../index.html" class="icon icon-home"> Lingvo
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../lingvo.html">lingvo package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Lingvo</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
      <li>lingvo.tasks.mt.input_generator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for lingvo.tasks.mt.input_generator</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright 2018 The TensorFlow Authors. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="sd">&quot;&quot;&quot;Machine translation input generator.&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">lingvo.compat</span> <span class="k">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">base_input_generator</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">generic_input</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">hyperparams</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">ops</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">py_utils</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">summary_utils</span>
<span class="kn">from</span> <span class="nn">lingvo.core</span> <span class="kn">import</span> <span class="n">tokenizers</span>
<span class="kn">from</span> <span class="nn">lingvo.tasks.mt</span> <span class="kn">import</span> <span class="n">text_input_pb2</span>
<span class="kn">import</span> <span class="nn">tensorflow_probability</span> <span class="k">as</span> <span class="nn">tfp</span>

<span class="kn">from</span> <span class="nn">google.protobuf</span> <span class="kn">import</span> <span class="n">descriptor_pb2</span>


<div class="viewcode-block" id="NmtInput"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtInput">[docs]</a><span class="k">class</span> <span class="nc">NmtInput</span><span class="p">(</span><span class="n">base_input_generator</span><span class="o">.</span><span class="n">BaseSequenceInputGenerator</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Generator for NMT.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="NmtInput.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtInput.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defaults params for `NmtInput`.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;natural_order_model&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;Whether the model consuming the input is a natural order model. Input &#39;</span>
        <span class="s1">&#39;is generated in natural order if True. Input is generated in reversed &#39;</span>
        <span class="s1">&#39;order if False. The value should be consistent with the underlying &#39;</span>
        <span class="s1">&#39;model. Set to True if training or using a natural order model, &#39;</span>
        <span class="s1">&#39;otherwise set to False.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizers</span><span class="o">.</span><span class="n">VocabFileTokenizer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span> <span class="o">=</span> <span class="mi">300</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">natural_order_model</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">natural_order_model</span>

<div class="viewcode-block" id="NmtInput._DataSourceFromFilePattern"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtInput._DataSourceFromFilePattern">[docs]</a>  <span class="k">def</span> <span class="nf">_DataSourceFromFilePattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_pattern</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_input_kwargs</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">Proc</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Parses a serialized tf.Example record.&quot;&quot;&quot;</span>
      <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">(</span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;source_padding&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;target_id&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;target_padding&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;target_label&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;target_weight&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
      <span class="p">]</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span>
      <span class="n">bucket_key</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;source_padding&#39;</span><span class="p">]),</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;target_padding&#39;</span><span class="p">])),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">],</span> <span class="n">bucket_key</span>

    <span class="n">features</span><span class="p">,</span> <span class="n">bucket_keys</span> <span class="o">=</span> <span class="n">generic_input</span><span class="o">.</span><span class="n">GenericInput</span><span class="p">(</span>
        <span class="n">file_pattern</span><span class="o">=</span><span class="n">file_pattern</span><span class="p">,</span>
        <span class="n">processor</span><span class="o">=</span><span class="n">Proc</span><span class="p">,</span>
        <span class="n">dynamic_padding_dimensions</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">dynamic_padding_constants</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">CommonInputOpArgs</span><span class="p">())</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">BuildInputBatch</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">InfeedBatchSize</span><span class="p">(),</span>
        <span class="n">features_list</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="n">bucket_keys</span><span class="o">=</span><span class="n">bucket_keys</span><span class="p">)</span></div>

<div class="viewcode-block" id="NmtInput.BuildInputBatch"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtInput.BuildInputBatch">[docs]</a>  <span class="k">def</span> <span class="nf">BuildInputBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">features_list</span><span class="p">,</span> <span class="n">bucket_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Builds an input batch.</span>

<span class="sd">    Args:</span>
<span class="sd">      batch_size: batch size to use, defaults to infeed batch size.</span>
<span class="sd">      features_list: Use this list to build the batch.</span>
<span class="sd">      bucket_keys: If None, bucket_keys[i] is the bucketing key of the i-th</span>
<span class="sd">        sample.</span>

<span class="sd">    Returns:</span>
<span class="sd">      py_utils.NestedMap with feature names as keys and tensors as values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">bucket_keys</span> <span class="o">=</span> <span class="n">bucket_keys</span>

    <span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">src_paddings</span><span class="p">,</span> <span class="n">tgt_ids</span><span class="p">,</span> <span class="n">tgt_paddings</span><span class="p">,</span> <span class="n">tgt_labels</span><span class="p">,</span>
     <span class="n">tgt_weights</span><span class="p">)</span> <span class="o">=</span> <span class="n">features_list</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">pad_to_max_seq_length</span><span class="p">:</span>
      <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span>

      <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infeed_bucket_batch_limit</span><span class="p">)</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">infeed_bucket_batch_limit</span><span class="p">):</span>
        <span class="n">source_shape</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infeed_bucket_batch_limit</span><span class="p">),</span> <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span>
        <span class="p">]</span>
        <span class="n">target_shape</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infeed_bucket_batch_limit</span><span class="p">),</span> <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span>
        <span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">source_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">target_shape</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">src_ids</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                              <span class="n">source_shape</span><span class="p">)</span>
      <span class="n">src_paddings</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">src_paddings</span><span class="p">,</span>
                                                   <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">source_shape</span><span class="p">)</span>
      <span class="n">tgt_ids</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">tgt_ids</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                              <span class="n">target_shape</span><span class="p">)</span>
      <span class="n">tgt_paddings</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">tgt_paddings</span><span class="p">,</span>
                                                   <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">target_shape</span><span class="p">)</span>
      <span class="n">tgt_labels</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">tgt_labels</span><span class="p">,</span>
                                                 <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                 <span class="n">target_shape</span><span class="p">)</span>
      <span class="n">tgt_weights</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">tgt_weights</span><span class="p">,</span>
                                                  <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">target_shape</span><span class="p">)</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">src_paddings</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tgt_ids</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tgt_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">tgt_weights</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">tgt_paddings</span>

    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fprop_dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fprop_dtype</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_Cast</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">is_floating</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fprop_dtype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">_Cast</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="MlPerfInput"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.MlPerfInput">[docs]</a><span class="k">class</span> <span class="nc">MlPerfInput</span><span class="p">(</span><span class="n">base_input_generator</span><span class="o">.</span><span class="n">BaseSequenceInputGenerator</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Generator for MLPerf TFRecords.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="MlPerfInput.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.MlPerfInput.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Default params for `MlPerfInput`.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>

    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;natural_order_model&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;sos_id&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Start of sentence id&#39;</span>
        <span class="s1">&#39;Note in the MLPerf encoding, this is actually &lt;PAD&gt;, however we can &#39;</span>
        <span class="s1">&#39;make use of it since we never actually use &lt;PAD&gt;.&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;packed_input&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;If True, then we also consume {inputs,targets}_{position,segmentation}&#39;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">natural_order_model</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">natural_order_model</span>

<div class="viewcode-block" id="MlPerfInput._DataSourceFromFilePattern"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.MlPerfInput._DataSourceFromFilePattern">[docs]</a>  <span class="k">def</span> <span class="nf">_DataSourceFromFilePattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_pattern</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_input_kwargs</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="k">def</span> <span class="nf">_DerivePaddingsAndIds</span><span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">tgt_labels</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;tgt_ids is tgt_labels shifted right by one, with a SOS ID prepended.&quot;&quot;&quot;</span>
      <span class="n">tgt_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([[</span><span class="n">p</span><span class="o">.</span><span class="n">sos_id</span><span class="p">],</span> <span class="n">tgt_labels</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
      <span class="n">src_paddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">src_ids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="n">tgt_paddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tgt_ids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
      <span class="n">tgt_weights</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tgt_ids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

      <span class="n">bucket_key</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">src_paddings</span><span class="p">),</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">tgt_paddings</span><span class="p">)),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">src_paddings</span><span class="p">,</span> <span class="n">tgt_ids</span><span class="p">,</span> <span class="n">tgt_paddings</span><span class="p">,</span> <span class="n">tgt_weights</span><span class="p">,</span> <span class="n">bucket_key</span>

    <span class="k">def</span> <span class="nf">_ProcPacked</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;TFExample -&gt; Tensors for PackedInput.&quot;&quot;&quot;</span>
      <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">(</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;targets&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;inputs_segmentation&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;inputs_position&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;targets_segmentation&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;targets_position&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
      <span class="p">]</span>

      <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span>

      <span class="n">src_ids</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
      <span class="n">tgt_labels</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span>

      <span class="n">src_pos</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;inputs_position&#39;</span><span class="p">]</span>
      <span class="n">src_seg</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;inputs_segmentation&#39;</span><span class="p">]</span>

      <span class="n">tgt_pos</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;targets_position&#39;</span><span class="p">]</span>
      <span class="n">tgt_seg</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;targets_segmentation&#39;</span><span class="p">]</span>

      <span class="n">src_paddings</span><span class="p">,</span> <span class="n">tgt_ids</span><span class="p">,</span> <span class="n">tgt_paddings</span><span class="p">,</span> <span class="n">tgt_weights</span><span class="p">,</span> <span class="n">bucket_key</span> <span class="o">=</span> <span class="n">_DerivePaddingsAndIds</span><span class="p">(</span>
          <span class="n">src_ids</span><span class="p">,</span> <span class="n">tgt_labels</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[</span>
          <span class="n">src_ids</span><span class="p">,</span>
          <span class="n">src_paddings</span><span class="p">,</span>
          <span class="n">tgt_ids</span><span class="p">,</span>
          <span class="n">tgt_paddings</span><span class="p">,</span>
          <span class="n">tgt_labels</span><span class="p">,</span>
          <span class="n">tgt_weights</span><span class="p">,</span>
          <span class="n">src_pos</span><span class="p">,</span>
          <span class="n">src_seg</span><span class="p">,</span>
          <span class="n">tgt_pos</span><span class="p">,</span>
          <span class="n">tgt_seg</span><span class="p">,</span>
      <span class="p">],</span> <span class="n">bucket_key</span>

    <span class="k">def</span> <span class="nf">_Proc</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Parses a serialized tf.Example record.&quot;&quot;&quot;</span>
      <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">(</span><span class="s1">&#39;inputs&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;targets&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
      <span class="p">]</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span>

      <span class="n">src_ids</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;inputs&#39;</span><span class="p">]</span>
      <span class="n">tgt_labels</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;targets&#39;</span><span class="p">]</span>

      <span class="c1"># Derive trivial segmentation for unpacked input.</span>
      <span class="n">src_paddings</span><span class="p">,</span> <span class="n">tgt_ids</span><span class="p">,</span> <span class="n">tgt_paddings</span><span class="p">,</span> <span class="n">tgt_weights</span><span class="p">,</span> <span class="n">bucket_key</span> <span class="o">=</span> <span class="n">_DerivePaddingsAndIds</span><span class="p">(</span>
          <span class="n">src_ids</span><span class="p">,</span> <span class="n">tgt_labels</span><span class="p">)</span>

      <span class="n">src_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">src_ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">tgt_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">tgt_ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">src_pos</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">src_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="n">src_seg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">src_paddings</span><span class="p">)</span>
      <span class="n">tgt_pos</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">tgt_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="n">tgt_seg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">tgt_paddings</span><span class="p">)</span>

      <span class="k">return</span> <span class="p">[</span>
          <span class="n">src_ids</span><span class="p">,</span>
          <span class="n">src_paddings</span><span class="p">,</span>
          <span class="n">tgt_ids</span><span class="p">,</span>
          <span class="n">tgt_paddings</span><span class="p">,</span>
          <span class="n">tgt_labels</span><span class="p">,</span>
          <span class="n">tgt_weights</span><span class="p">,</span>
          <span class="n">src_pos</span><span class="p">,</span>
          <span class="n">src_seg</span><span class="p">,</span>
          <span class="n">tgt_pos</span><span class="p">,</span>
          <span class="n">tgt_seg</span><span class="p">,</span>
      <span class="p">],</span> <span class="n">bucket_key</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">packed_input</span><span class="p">:</span>
      <span class="n">processor_fn</span> <span class="o">=</span> <span class="n">_Proc</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">processor_fn</span> <span class="o">=</span> <span class="n">_ProcPacked</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CommonInputOpArgs</span><span class="p">()</span>
    <span class="c1"># In pure Eager or tf.function mode, add this kwarg so `GenericInputV2` ops</span>
    <span class="c1"># get used instead of `GenericInput`.</span>
    <span class="k">if</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">IsEagerMode</span><span class="p">():</span>
      <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;allow_eager&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="c1"># Pass `extra_input_kwargs` into GenericInput calls.</span>
      <span class="n">kwargs</span> <span class="o">|=</span> <span class="n">extra_input_kwargs</span>

    <span class="n">features</span><span class="p">,</span> <span class="n">bucket_keys</span> <span class="o">=</span> <span class="n">generic_input</span><span class="o">.</span><span class="n">GenericInput</span><span class="p">(</span>
        <span class="n">file_pattern</span><span class="o">=</span><span class="n">file_pattern</span><span class="p">,</span>
        <span class="n">processor</span><span class="o">=</span><span class="n">processor_fn</span><span class="p">,</span>
        <span class="n">dynamic_padding_dimensions</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">dynamic_padding_constants</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">BuildInputBatch</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">InfeedBatchSize</span><span class="p">(),</span>
        <span class="n">features_list</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="n">bucket_keys</span><span class="o">=</span><span class="n">bucket_keys</span><span class="p">)</span></div>

<div class="viewcode-block" id="MlPerfInput.BuildInputBatch"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.MlPerfInput.BuildInputBatch">[docs]</a>  <span class="k">def</span> <span class="nf">BuildInputBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">features_list</span><span class="p">,</span> <span class="n">bucket_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Builds an input batch.</span>

<span class="sd">    Args:</span>
<span class="sd">      batch_size: batch size to use, defaults to infeed batch size.</span>
<span class="sd">      features_list: Use this list to build the batch.</span>
<span class="sd">      bucket_keys: If None, bucket_keys[i] is the bucketing key of the i-th</span>
<span class="sd">        sample.</span>

<span class="sd">    Returns:</span>
<span class="sd">      py_utils.NestedMap with feature names as keys and tensors as values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">bucket_keys</span> <span class="o">=</span> <span class="n">bucket_keys</span>

    <span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">src_paddings</span><span class="p">,</span> <span class="n">tgt_ids</span><span class="p">,</span> <span class="n">tgt_paddings</span><span class="p">,</span> <span class="n">tgt_labels</span><span class="p">,</span> <span class="n">tgt_weights</span><span class="p">,</span>
     <span class="n">src_seg_pos</span><span class="p">,</span> <span class="n">src_seg_ids</span><span class="p">,</span> <span class="n">tgt_seg_pos</span><span class="p">,</span> <span class="n">tgt_seg_ids</span><span class="p">)</span> <span class="o">=</span> <span class="n">features_list</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">pad_to_max_seq_length</span><span class="p">:</span>
      <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span>

      <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infeed_bucket_batch_limit</span><span class="p">)</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">infeed_bucket_batch_limit</span><span class="p">):</span>
        <span class="n">source_shape</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infeed_bucket_batch_limit</span><span class="p">),</span> <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span>
        <span class="p">]</span>
        <span class="n">target_shape</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infeed_bucket_batch_limit</span><span class="p">),</span> <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span>
        <span class="p">]</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">source_shape</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">target_shape</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="n">src_ids</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                              <span class="n">source_shape</span><span class="p">)</span>
      <span class="n">src_paddings</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">src_paddings</span><span class="p">,</span>
                                                   <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">source_shape</span><span class="p">)</span>
      <span class="n">tgt_ids</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">tgt_ids</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                              <span class="n">target_shape</span><span class="p">)</span>
      <span class="n">tgt_paddings</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">tgt_paddings</span><span class="p">,</span>
                                                   <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">target_shape</span><span class="p">)</span>
      <span class="n">tgt_labels</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">tgt_labels</span><span class="p">,</span>
                                                 <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                 <span class="n">target_shape</span><span class="p">)</span>
      <span class="n">tgt_weights</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">tgt_weights</span><span class="p">,</span>
                                                  <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">target_shape</span><span class="p">)</span>

      <span class="n">src_seg_ids</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">src_seg_ids</span><span class="p">,</span>
                                                  <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">source_shape</span><span class="p">)</span>
      <span class="n">src_seg_pos</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">src_seg_pos</span><span class="p">,</span>
                                                  <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">source_shape</span><span class="p">)</span>
      <span class="n">tgt_seg_ids</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">tgt_seg_ids</span><span class="p">,</span>
                                                  <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">target_shape</span><span class="p">)</span>
      <span class="n">tgt_seg_pos</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">tgt_seg_pos</span><span class="p">,</span>
                                                  <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                  <span class="n">target_shape</span><span class="p">)</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">src_paddings</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tgt_ids</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tgt_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">tgt_weights</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">tgt_paddings</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">segment_pos</span> <span class="o">=</span> <span class="n">src_seg_pos</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">segment_ids</span> <span class="o">=</span> <span class="n">src_seg_ids</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">segment_pos</span> <span class="o">=</span> <span class="n">tgt_seg_pos</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">segment_ids</span> <span class="o">=</span> <span class="n">tgt_seg_ids</span>

    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fprop_dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fprop_dtype</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_Cast</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">is_floating</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fprop_dtype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">_Cast</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="_GetSegmentPos"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator._GetSegmentPos">[docs]</a><span class="k">def</span> <span class="nf">_GetSegmentPos</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Returns a segment_pos tensor from the given weights tensor.&quot;&quot;&quot;</span>
  <span class="n">maxlen</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">weights</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">ret</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">maxlen</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">weights</span> <span class="o">*</span> <span class="n">ret</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span></div>


<div class="viewcode-block" id="_GetDescriptorSetForTextInput"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator._GetDescriptorSetForTextInput">[docs]</a><span class="k">def</span> <span class="nf">_GetDescriptorSetForTextInput</span><span class="p">():</span>
  <span class="sd">&quot;&quot;&quot;Returns a string for tf.io.decode_proto&#39;s descriptor_source.&quot;&quot;&quot;</span>
  <span class="n">file_descriptor_set</span> <span class="o">=</span> <span class="n">descriptor_pb2</span><span class="o">.</span><span class="n">FileDescriptorSet</span><span class="p">()</span>
  <span class="n">text_input_pb2</span><span class="o">.</span><span class="n">DESCRIPTOR</span><span class="o">.</span><span class="n">CopyToProto</span><span class="p">(</span><span class="n">file_descriptor_set</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">add</span><span class="p">())</span>
  <span class="k">return</span> <span class="sa">b</span><span class="s1">&#39;bytes://&#39;</span> <span class="o">+</span> <span class="n">file_descriptor_set</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">()</span></div>


<div class="viewcode-block" id="TextPackedInput"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput">[docs]</a><span class="k">class</span> <span class="nc">TextPackedInput</span><span class="p">(</span><span class="n">base_input_generator</span><span class="o">.</span><span class="n">BaseSequenceInputGenerator</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Generator for packed text input.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="TextPackedInput.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Defaults params for TextInput.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A Params object for TextPackedInput.</span>

<span class="sd">    Notes about usage:</span>

<span class="sd">    * Input files contain UTF8 encoded texts. p.input_file_type controls</span>
<span class="sd">      what format to extract these texts from. The default is &#39;tsv&#39;, in which</span>
<span class="sd">      case p.file_pattern should be prefixed by file type &#39;text:&#39;, and</span>
<span class="sd">      every line in the input file should have text columns separated by</span>
<span class="sd">      a tab &#39;\t&#39;. Otherwise p.input_file_type can be Sentence or SentencePair</span>
<span class="sd">      protos.</span>

<span class="sd">      For tsv input files, in the default case, the file should contain 2</span>
<span class="sd">      columns, for the source and the target sentence. Special cases:</span>

<span class="sd">      - When quality scores are present (see p.quality_score_filter_fn below),</span>
<span class="sd">        it should contain 3 columns, the last being a quality score.</span>
<span class="sd">      - When MASS is enabled, it should contain a single column.</span>

<span class="sd">    * p.tokenizer or p.tokenizer_dict is used to perform string to id</span>
<span class="sd">      conversions. If key `src` or `tgt` is present in p.tokenizer_dict,</span>
<span class="sd">      it will be used for generating the ids for src or tgt, respectively.</span>
<span class="sd">      Otherwise the default tokenizer will be used.</span>

<span class="sd">    * p.packing_factor depends on the training data and max lengths used.</span>

<span class="sd">      If this value is too small, we generate packed batches that contain</span>
<span class="sd">      too many padding that could have been used to pack more examples.</span>
<span class="sd">      If this value is too large, we use more host memory and randomly discard</span>
<span class="sd">      examples that could not fit.</span>

<span class="sd">      One can look at the &#39;examples/src_packed_token_ratio&#39; (or</span>
<span class="sd">      &#39;examples/tgt_packed_token_ratio&#39;) graph to determine if</span>
<span class="sd">      its value is too small. For example, with p.packing_factor=3.5, if we</span>
<span class="sd">      observe that &#39;examples/src_packed_token_ratio&#39; is saturated at 1.0, this</span>
<span class="sd">      means 3.5 is likely too small. If we instead observe that</span>
<span class="sd">      &#39;examples/src_packed_token_ratio&#39; fluctuates around 0.5, this means 3.5 is</span>
<span class="sd">      larger than needed.</span>

<span class="sd">      We believe that there can be a slight bias against longer sequences</span>
<span class="sd">      (meaning longer sequences have a slightly higher probability of being</span>
<span class="sd">      dropped) when packing factor is too large to have to drop data. The</span>
<span class="sd">      remedy is either use larger effective batch size, or use a conservative</span>
<span class="sd">      packing factor to not drop data.</span>

<span class="sd">      Note that the metric &#39;num_samples_in_batch&#39; is a static value for</span>
<span class="sd">      max global number of samples, while &#39;exmples/num_packed_examples&#39;</span>
<span class="sd">      is the actual number of samples per batch.</span>

<span class="sd">    * p.source_max_length and p.target_max_length control both the shape of</span>
<span class="sd">      the generated input batch (how long each row is) and the filtering</span>
<span class="sd">      (max allowed lengths for source and targt, respectively).</span>

<span class="sd">      p.bucket_upper_bound also conrols the filtering of examples. Inputs</span>
<span class="sd">      with either source or target sequence lengths exceeding it will be</span>
<span class="sd">      filtered out.</span>

<span class="sd">      It&#39;s not meaningful to set p.bucket_upper_bound higher than both</span>
<span class="sd">      p.source_max_length and p.target_max_length.</span>

<span class="sd">      When packing is enabled, however, a smaller p.bucket_upper_bound means</span>
<span class="sd">      that individual sequences have a smaller max length, but the packed</span>
<span class="sd">      batch may have a larger total length.</span>

<span class="sd">    * p.file_pattern_task_ids, p.task_to_{src,tgt}_lang_map are all used</span>
<span class="sd">      to manipulate batch.{src,tgt}.task_ids.</span>

<span class="sd">      For each eaxmple, its task is obtained from the source id, which is</span>
<span class="sd">      the index of the example&#39;s origin file in p.file_pattern. The task</span>
<span class="sd">      id populated in the input batch is determined by:</span>
<span class="sd">      p.task_to_{src,tgt}_lang_map[ p.file_pattern_task_ids[souce_id] ],</span>
<span class="sd">      for src and tgt, respectively, where if a list is empty it falls</span>
<span class="sd">      back to an identity map.</span>

<span class="sd">      In the future we may define a separate lang_ids field to the input</span>
<span class="sd">      batch to disambiguate.</span>

<span class="sd">    * p.quality_score_filter_fn can be used when a column of quality score</span>
<span class="sd">      is present in the input .tsv file. The quality score must be the last</span>
<span class="sd">      column. This filter function returns True to filter, e.g. use</span>
<span class="sd">      p.quality_score_filter_fn = lambda x: x &lt;= 0.3 for scores where higher</span>
<span class="sd">      means better.</span>

<span class="sd">      p.quality_score_filter_fn typically should only contain a simple</span>
<span class="sd">      comparison (&lt;, &gt;, &lt;=, or &gt;=), as it relies on tf.Tensor&#39;s overloading</span>
<span class="sd">      of __le__() etc. to work. For example: lambda x: ( 0.3 &lt; x and x &lt; 0.9)</span>
<span class="sd">      won&#39;t work. But tf.math.logical_and(0.3 &lt; x, x &lt; 0.9) is okay.</span>

<span class="sd">      Also note that &#39;p.quality_score_filter_fn = lambda _: False&#39; is</span>
<span class="sd">      equivalent with &#39;p.quality_score_filter_fn = None&#39;, in which case</span>
<span class="sd">      no quality score column is needed (or evaluated).</span>

<span class="sd">    * Consider enabling multithreading for the trainer job (in the Train()</span>
<span class="sd">      method). For example: p.num_batcher_threads = 128.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>

    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;file_pattern_task_ids&#39;</span><span class="p">,</span> <span class="p">[],</span>
             <span class="s1">&#39;task_id corresponding to list of file_patterns.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;task_to_src_lang_map&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">&#39;Map of task id to src language id.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;task_to_tgt_lang_map&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">&#39;Map of task id to tgt language id.&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;packing_factor&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;A multiplicative factor for packing. This is the ratio between &#39;</span>
        <span class="s1">&#39;pre-packing batch size and after-packing batch size. If None, &#39;</span>
        <span class="s1">&#39;packing is disabled; otherwise the packing factor should be a &#39;</span>
        <span class="s1">&#39;float &gt;= 1.&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;quality_score_filter_fn&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;A user defined boolean function on a float (quality score). &#39;</span>
        <span class="s1">&#39;When present, the input .tsv file has an additional column &#39;</span>
        <span class="s1">&#39;of floats representing a quality score, and each line is &#39;</span>
        <span class="s1">&#39;filtered out when this function returns True on that score.&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;input_file_type&#39;</span><span class="p">,</span> <span class="s1">&#39;tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;The type of input file contents.&#39;</span>
        <span class="s1">&#39; Must be one of [&quot;tsv&quot;, &quot;sentence_proto&quot;], for tab-separated&#39;</span>
        <span class="s1">&#39; values, or Sentence/SentencePair protos, respectively.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;single_column_input&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Indicates input is single-column rather&#39;</span>
        <span class="s1">&#39; than double-column. When input_file_type is sentence_proto, this&#39;</span>
        <span class="s1">&#39; means Sentence proto rather than SentencePair proto.&#39;</span><span class="p">)</span>

    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;natural_order_model&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;Only True is supported now.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;target_language&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Language on target side.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;mass_layer&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;If not None, use the specified layer to do &#39;</span>
             <span class="s1">&#39;MASS masking.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;mass_task_ids&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;List of task IDs for MASS. If None and &#39;</span>
        <span class="s1">&#39;single_column_input=True, apply MASS to all tasks, otherwise &#39;</span>
        <span class="s1">&#39;only apply to the specified tasks.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;enable_mass_for_eval&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Enables masking during eval.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;keep_truncated&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Permits using truncated seqs instead &#39;</span>
        <span class="s1">&#39;of filtering them out. Doesnt append EOS to truncated seqs.&#39;</span><span class="p">)</span>
    <span class="c1"># TODO(b/201766229): Re-enable ID histograms when root problem is resolved.</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;suppress_id_histograms&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span>
             <span class="s1">&#39;Suppresses histograms for source and target ids.&#39;</span><span class="p">)</span>
    <span class="c1"># Back translation</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;bt_task_ids&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">&#39;List of task ids for back-translation.&#39;</span><span class="p">)</span>
    <span class="c1"># Denoising (https://arxiv.org/pdf/1711.00043)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;denoise&#39;</span><span class="p">,</span> <span class="n">hyperparams</span><span class="o">.</span><span class="n">Params</span><span class="p">(),</span> <span class="s1">&#39;Params for denosing tasks.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">denoise</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;task_ids&#39;</span><span class="p">,</span> <span class="p">[],</span> <span class="s1">&#39;List of task IDs for denoising.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">denoise</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;noise_sent_prob&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                     <span class="s1">&#39;Probability of noising an input sentence.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">denoise</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;shuffle_tok_range&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;Range of noise for shuffling tokens, following&#39;</span>
        <span class="s1">&#39; https://arxiv.org/pdf/1711.00043. Note that shuffle_tok_range of 3 &#39;</span>
        <span class="s1">&#39;implies tokens may be permuted at most 3 position.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">denoise</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;drop_tok_prob&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;Probability of dropping tokens.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">denoise</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;blank_tok_prob&#39;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;Probability of blanking tokens.&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">denoise</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;blank_id&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;ID of blank token.&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">natural_order_model</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Only p.natural_order_model=True is supported now.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">natural_order_model</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">natural_order_model</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">packing_factor</span><span class="p">:</span>
      <span class="c1"># Packing is enabled. We override p.bucket_batch_limit with the</span>
      <span class="c1"># pre-packing batch size.</span>
      <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">packing_factor</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;p.packing_factor must be &gt;= 1.0: &#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">packing_factor</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">bucket_upper_bound</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">bucket_batch_limit</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;when packing is enabled, p.bucket_upper_bound &#39;</span>
            <span class="s1">&#39;and p.bucket_batch_limits must be arrays of length &#39;</span>
            <span class="s1">&#39;1:&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">bucket_upper_bound</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">bucket_batch_limit</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_packed_batch_size</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">bucket_batch_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">p</span><span class="o">.</span><span class="n">bucket_batch_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">bucket_batch_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">packing_factor</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_packed_batch_size</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Ensure that the max lengths are not None, as tokenizer.StringsToIds()</span>
    <span class="c1"># might use it to pad the encoded ids tensor.</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">bucket_upper_bound</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">p</span><span class="o">.</span><span class="n">source_max_length</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">target_max_length</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">input_file_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tsv&#39;</span><span class="p">,</span> <span class="s1">&#39;sentence_proto&#39;</span><span class="p">]:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;p.input_file_type must be one of [&quot;tsv&quot;,&#39;</span>
                       <span class="s1">&#39; &quot;sentence_proto&quot;], got </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                           <span class="n">params</span><span class="o">.</span><span class="n">input_file_type</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">quality_score_filter_fn</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">quality_score_filter_fn</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
          <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">quality_score_filter_fn</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">)</span> <span class="ow">and</span>
          <span class="n">p</span><span class="o">.</span><span class="n">quality_score_filter_fn</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;p.quality_score_filter_fn must return a bool on a float input, &#39;</span>
            <span class="s1">&#39;e.g. p.quality_score_filter_fn = lambda x: x &lt;= 0.3.&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">input_file_type</span> <span class="o">!=</span> <span class="s1">&#39;tsv&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;p.quality_score_filter_fn requires p.input_file_type == &quot;tsv&quot;.&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_src_tokenizer_key</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;src&#39;</span> <span class="k">if</span> <span class="s1">&#39;src&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_dict</span> <span class="k">else</span>
                               <span class="n">base_input_generator</span><span class="o">.</span><span class="n">DEFAULT_TOKENIZER_KEY</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_src_tokenizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_tokenizer_key</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tgt_tokenizer_key</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;tgt&#39;</span> <span class="k">if</span> <span class="s1">&#39;tgt&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_dict</span> <span class="k">else</span>
                               <span class="n">base_input_generator</span><span class="o">.</span><span class="n">DEFAULT_TOKENIZER_KEY</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_tgt_tokenizer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_tokenizer_key</span><span class="p">]</span>

    <span class="c1"># TODO(alisonlui): Support single-column Sentence proto input.</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">single_column_input</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">input_file_type</span> <span class="o">==</span> <span class="s1">&#39;sentence_proto&#39;</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
          <span class="s1">&#39;Single column Sentence proto input not yet supported.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">mass_layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">single_column_input</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must be single_column_input if mass layer is provided.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">mass_layer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># Creat the MASS layer (wrapper for the MASS op).</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">CreateChild</span><span class="p">(</span><span class="s1">&#39;mass_layer&#39;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">mass_layer</span><span class="p">)</span>

<div class="viewcode-block" id="TextPackedInput._GetBucketKey"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._GetBucketKey">[docs]</a>  <span class="k">def</span> <span class="nf">_GetBucketKey</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">features</span><span class="p">,</span> <span class="n">filtered</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns the bucket key for a given input.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="c1"># We return the max of sourcec or target sequence length if and only if both</span>
    <span class="c1"># src and tgt fit. Otherwise we return a key of -1 to filter out this input.</span>
    <span class="k">def</span> <span class="nf">_MaxLen</span><span class="p">():</span>
      <span class="n">src_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="n">tgt_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">src_len</span><span class="p">,</span> <span class="n">tgt_len</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">keep_truncated</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">_MaxLen</span><span class="p">()</span>

    <span class="c1"># The token ids are not truncated if and only if it ends with padding</span>
    <span class="c1"># or the last id is EOS.</span>
    <span class="n">src_fits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_tokenizer</span><span class="o">.</span><span class="n">eos_id</span><span class="p">))</span>
    <span class="n">tgt_fits</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tgt_tokenizer</span><span class="o">.</span><span class="n">eos_id</span><span class="p">))</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
        <span class="n">filtered</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">src_fits</span><span class="p">,</span> <span class="n">tgt_fits</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">filtered</span><span class="p">,</span> <span class="k">lambda</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">_MaxLen</span><span class="p">)</span></div>

<div class="viewcode-block" id="TextPackedInput._GetTaskIds"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._GetTaskIds">[docs]</a>  <span class="k">def</span> <span class="nf">_GetTaskIds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look up the correct task_id from the source_id tensor.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">file_pattern_task_ids</span><span class="p">:</span>
      <span class="n">file_task_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">file_pattern_task_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">file_task_ids</span><span class="p">,</span> <span class="n">source_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">source_id</span></div>

<div class="viewcode-block" id="TextPackedInput._GetLangIds"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._GetLangIds">[docs]</a>  <span class="k">def</span> <span class="nf">_GetLangIds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Look up the correct lang_id from the source_id tensor.&quot;&quot;&quot;</span>
    <span class="n">task_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetTaskIds</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span>
    <span class="n">src_lang_id</span> <span class="o">=</span> <span class="n">task_id</span>
    <span class="n">tgt_lang_id</span> <span class="o">=</span> <span class="n">task_id</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">task_to_src_lang_map</span><span class="p">:</span>
      <span class="n">src_langs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">task_to_src_lang_map</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="n">src_lang_id</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">src_langs</span><span class="p">,</span> <span class="n">task_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">task_to_tgt_lang_map</span><span class="p">:</span>
      <span class="n">tgt_langs</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">task_to_tgt_lang_map</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="n">tgt_lang_id</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tgt_langs</span><span class="p">,</span> <span class="n">task_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">src_lang_id</span><span class="p">,</span> <span class="n">tgt_lang_id</span></div>

<div class="viewcode-block" id="TextPackedInput._ProcessSingleInput"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._ProcessSingleInput">[docs]</a>  <span class="k">def</span> <span class="nf">_ProcessSingleInput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs strings-to-ids on the given input pair via p.tokenizer_dict.&quot;&quot;&quot;</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">src_labels</span><span class="p">,</span> <span class="n">src_paddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">StringsToIds</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">is_source</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_tokenizer_key</span><span class="p">)</span>
    <span class="n">tgt_ids</span><span class="p">,</span> <span class="n">tgt_labels</span><span class="p">,</span> <span class="n">tgt_paddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">StringsToIds</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">is_source</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_tgt_tokenizer_key</span><span class="p">)</span>
    <span class="c1"># Mask positions to 0 where padding is 1 for consistency. We do this because</span>
    <span class="c1"># tokenizer implementation may use EOS token to pad.</span>
    <span class="n">src_labels</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">ApplyPadding</span><span class="p">(</span><span class="n">src_paddings</span><span class="p">,</span> <span class="n">src_labels</span><span class="p">)</span>
    <span class="n">tgt_ids</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">ApplyPadding</span><span class="p">(</span><span class="n">tgt_paddings</span><span class="p">,</span> <span class="n">tgt_ids</span><span class="p">)</span>
    <span class="n">tgt_labels</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">ApplyPadding</span><span class="p">(</span><span class="n">tgt_paddings</span><span class="p">,</span> <span class="n">tgt_labels</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">src_labels</span>
    <span class="c1"># ids_indicator is 1 if and only if the output from tokenizer has a</span>
    <span class="c1"># non-padded id. Unlike weights, it will not mutate and can be used for</span>
    <span class="c1"># determining actual sequence length, for example.</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src_paddings</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">src_paddings</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">src_paddings</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tgt_ids</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">tgt_labels</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tgt_paddings</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">tgt_paddings</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">tgt_paddings</span>

    <span class="n">src_task_id</span><span class="p">,</span> <span class="n">tgt_task_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetLangIds</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span>
    <span class="c1"># task_ids are padded with zeros.</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">task_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">src_task_id</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">source_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">source_id</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">task_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">tgt_task_id</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">source_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">source_id</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">use_tpu</span><span class="p">():</span>
      <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">strs</span> <span class="o">=</span> <span class="n">src</span>
      <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">strs</span> <span class="o">=</span> <span class="n">tgt</span>
    <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">)</span></div>

<div class="viewcode-block" id="TextPackedInput._ProcessMASSInput"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._ProcessMASSInput">[docs]</a>  <span class="k">def</span> <span class="nf">_ProcessMASSInput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_id</span><span class="p">,</span> <span class="n">src</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Perform MASS input processing.&quot;&quot;&quot;</span>
    <span class="n">skip_mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">do_eval</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">enable_mass_for_eval</span>
    <span class="k">if</span> <span class="n">skip_mass</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">mass_layer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># At eval time, we copy src to tgt</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ProcessSingleInput</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">paddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">StringsToIds</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">is_source</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_src_tokenizer_key</span><span class="p">)</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">paddings</span>
    <span class="n">actual_seq_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">src_lang_ids</span><span class="p">,</span> <span class="n">tgt_lang_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetLangIds</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span>

    <span class="n">mass_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_layer</span><span class="o">.</span><span class="n">Mask</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">actual_seq_len</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">mass_out</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">paddings</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">task_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">src_lang_ids</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">source_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">source_id</span>
    <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span> <span class="o">=</span> <span class="n">weights</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">mass_out</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">mass_out</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">labels</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">paddings</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">mass_out</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">weights</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">task_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">tgt_lang_ids</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">source_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span> <span class="o">*</span> <span class="n">source_id</span>
    <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span> <span class="o">=</span> <span class="n">weights</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">use_tpu</span><span class="p">():</span>
      <span class="n">features</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">strs</span> <span class="o">=</span> <span class="n">src</span>
      <span class="n">features</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">strs</span> <span class="o">=</span> <span class="n">src</span>
    <span class="k">return</span> <span class="n">features</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">)</span></div>

<div class="viewcode-block" id="TextPackedInput._ReadRecordTsv"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._ReadRecordTsv">[docs]</a>  <span class="k">def</span> <span class="nf">_ReadRecordTsv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads a single input record from a tab-separated values file.&quot;&quot;&quot;</span>
    <span class="c1"># Assuming UTF8 text input separated by tabs.</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">split</span><span class="p">([</span><span class="n">record</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;RaggedTensor&#39;</span><span class="p">)</span>
    <span class="c1"># If the row_lengths are not enough (e.g. row has only 1 column),</span>
    <span class="c1"># record_batcher throws away this record but it does not crash the program</span>
    <span class="c1"># per lingvo/core/ops/record_batcher.cc.</span>
    <span class="c1"># This means that it&#39;s okay if the file contains more columns than needed.</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">tgt</span> <span class="o">=</span> <span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="c1"># We manually filter the record if either source or target sentence is an</span>
    <span class="c1"># empty string.</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="mi">0</span><span class="p">),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">tgt</span><span class="p">),</span> <span class="mi">0</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">quality_score_filter_fn</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">filtered</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
        <span class="n">filtered</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">quality_score_filter_fn</span><span class="p">(</span>
            <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">to_number</span><span class="p">(</span><span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])))</span>
    <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">filtered</span></div>

<div class="viewcode-block" id="TextPackedInput._ReadRecordTsvSingleColumn"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._ReadRecordTsvSingleColumn">[docs]</a>  <span class="k">def</span> <span class="nf">_ReadRecordTsvSingleColumn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads an input record, taking first column of one or more TSV columns.&quot;&quot;&quot;</span>
    <span class="c1"># Assuming UTF8 text input which may have 1 or more tab-separated columns</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">split</span><span class="p">([</span><span class="n">record</span><span class="p">],</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">result_type</span><span class="o">=</span><span class="s1">&#39;RaggedTensor&#39;</span><span class="p">)</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">src</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">filtered</span></div>

<div class="viewcode-block" id="TextPackedInput._ReadRecordSentencePairProto"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._ReadRecordSentencePairProto">[docs]</a>  <span class="k">def</span> <span class="nf">_ReadRecordSentencePairProto</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reads the input record as a binary SentencePair proto.&quot;&quot;&quot;</span>
    <span class="c1"># We defer handling the `lang` field in the proto until TextPackedInput</span>
    <span class="c1"># figures out how to handle lang_ids. For now `lang` fields are ignored.</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">sentence_protos</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_proto</span><span class="p">(</span>
        <span class="nb">bytes</span><span class="o">=</span><span class="n">record</span><span class="p">,</span>
        <span class="n">message_type</span><span class="o">=</span><span class="s1">&#39;tensorflow.lingvo.SentencePair&#39;</span><span class="p">,</span>
        <span class="n">field_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;src_sentence&#39;</span><span class="p">,</span> <span class="s1">&#39;tgt_sentence&#39;</span><span class="p">],</span>
        <span class="n">output_types</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">],</span>
        <span class="n">descriptor_source</span><span class="o">=</span><span class="n">_GetDescriptorSetForTextInput</span><span class="p">())</span>
    <span class="n">sentence_protos</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">sentence_protos</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">sentences</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">decode_proto</span><span class="p">(</span>
        <span class="nb">bytes</span><span class="o">=</span><span class="n">sentence_protos</span><span class="p">,</span>
        <span class="n">message_type</span><span class="o">=</span><span class="s1">&#39;tensorflow.lingvo.Sentence&#39;</span><span class="p">,</span>
        <span class="n">field_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sentence&#39;</span><span class="p">],</span>
        <span class="n">output_types</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">],</span>
        <span class="n">descriptor_source</span><span class="o">=</span><span class="n">_GetDescriptorSetForTextInput</span><span class="p">())</span>
    <span class="n">sentences</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">sentences</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sentences</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sentences</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></div>

<div class="viewcode-block" id="TextPackedInput._DataSourceFromFilePattern"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._DataSourceFromFilePattern">[docs]</a>  <span class="k">def</span> <span class="nf">_DataSourceFromFilePattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">file_pattern</span><span class="p">,</span>
                                 <span class="n">input_source_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                 <span class="o">**</span><span class="n">extra_input_kwargs</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">Processor</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">record</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Parses a record, which is a line of text.&quot;&quot;&quot;</span>

      <span class="n">task_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetTaskIds</span><span class="p">(</span><span class="n">source_id</span><span class="p">)</span>

      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">input_file_type</span> <span class="o">==</span> <span class="s1">&#39;tsv&#39;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">_ApplyMass</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
          <span class="n">mass_task_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">mass_task_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
          <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_any</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">task_id</span><span class="p">,</span> <span class="n">mass_task_ids</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">_MASSInput</span><span class="p">():</span>
          <span class="n">src</span><span class="p">,</span> <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadRecordTsvSingleColumn</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ProcessMASSInput</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">src</span><span class="p">),</span> <span class="n">filtered</span>

        <span class="k">def</span> <span class="nf">_SingleInput</span><span class="p">():</span>
          <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">,</span> <span class="n">filtered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadRecordTsv</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ProcessSingleInput</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">),</span> <span class="n">filtered</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">single_column_input</span><span class="p">:</span>
          <span class="c1"># For monolingual input, MASS is applied by default.</span>
          <span class="c1"># If mass_task_ids is specified, only apply MASS to specified tasks.</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">mass_task_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="n">_ApplyMass</span><span class="p">(</span><span class="n">task_id</span><span class="p">)</span>
            <span class="n">features</span><span class="p">,</span> <span class="n">filtered</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="n">_MASSInput</span><span class="p">,</span> <span class="n">_SingleInput</span><span class="p">)</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="n">features</span><span class="p">,</span> <span class="n">filtered</span> <span class="o">=</span> <span class="n">_MASSInput</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">features</span><span class="p">,</span> <span class="n">filtered</span> <span class="o">=</span> <span class="n">_SingleInput</span><span class="p">()</span>

      <span class="k">else</span><span class="p">:</span>
        <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ReadRecordSentencePairProto</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ProcessSingleInput</span><span class="p">(</span><span class="n">source_id</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">tgt</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">features</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GetBucketKey</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">filtered</span><span class="p">)</span>

    <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">CommonInputOpArgs</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">IsEagerMode</span><span class="p">():</span>
      <span class="c1"># In pure Eager or tf.function mode, add this kwarg so `GenericInputV2`</span>
      <span class="c1"># ops get used instead of `GenericInput`.</span>
      <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;allow_eager&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
      <span class="c1"># Pass `extra_input_kwargs` into GenericInput calls.</span>
      <span class="n">kwargs</span> <span class="o">|=</span> <span class="n">extra_input_kwargs</span>

    <span class="n">batch</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">generic_input</span><span class="o">.</span><span class="n">GenericInput</span><span class="p">(</span>
        <span class="n">processor</span><span class="o">=</span><span class="n">Processor</span><span class="p">,</span>
        <span class="n">file_pattern</span><span class="o">=</span><span class="n">file_pattern</span><span class="p">,</span>
        <span class="n">input_source_weights</span><span class="o">=</span><span class="n">input_source_weights</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Pack</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span></div>

<div class="viewcode-block" id="TextPackedInput._ApplyPacking"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._ApplyPacking">[docs]</a>  <span class="k">def</span> <span class="nf">_ApplyPacking</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Packs a given batch.</span>

<span class="sd">    Note that this may change the batch size.</span>

<span class="sd">    This function packs the input batch and adds .segment_ids and .segment_pos</span>
<span class="sd">    fields to its `src` and `tgt` fields.</span>

<span class="sd">    Args:</span>
<span class="sd">      batch: a `.NestedMap` of input tensors to be packed. It is modified in</span>
<span class="sd">        place.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">src_actual_seq_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">tgt_actual_seq_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">suppress_id_histograms</span><span class="p">:</span>
      <span class="n">summary_utils</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="s1">&#39;source_seq_lengths&#39;</span><span class="p">,</span> <span class="n">src_actual_seq_len</span><span class="p">)</span>
      <span class="n">summary_utils</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="s1">&#39;target_seq_lengths&#39;</span><span class="p">,</span> <span class="n">tgt_actual_seq_len</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">packing_factor</span><span class="p">:</span>
      <span class="c1"># Supply segment_ids and segment_pos with no packing.</span>
      <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">segment_ids</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span>
      <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">segment_pos</span> <span class="o">=</span> <span class="n">_GetSegmentPos</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">)</span>
      <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">segment_ids</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span>
      <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">segment_pos</span> <span class="o">=</span> <span class="n">_GetSegmentPos</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span><span class="p">)</span>
      <span class="k">return</span>

    <span class="p">(</span><span class="n">src_segment_ids</span><span class="p">,</span> <span class="n">src_segment_pos</span><span class="p">,</span> <span class="n">src_indices_in_input</span><span class="p">,</span> <span class="n">tgt_segment_ids</span><span class="p">,</span>
     <span class="n">tgt_segment_pos</span><span class="p">,</span> <span class="n">tgt_indices_in_input</span><span class="p">)</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">pack_sequences</span><span class="p">(</span>
         <span class="n">src_actual_seq_len</span><span class="p">,</span> <span class="n">tgt_actual_seq_len</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ScaledBatchSize</span><span class="p">(),</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">source_max_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">)</span>

    <span class="n">uniq_src_indices_in_input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">src_indices_in_input</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">y</span>
    <span class="n">uniq_tgt_indices_in_input</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">tgt_indices_in_input</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span><span class="o">.</span><span class="n">y</span>
    <span class="n">summary_utils</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
        <span class="s1">&#39;packed_source_seq_lengths&#39;</span><span class="p">,</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">src_actual_seq_len</span><span class="p">,</span> <span class="n">uniq_src_indices_in_input</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">summary_utils</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
        <span class="s1">&#39;packed_target_seq_lengths&#39;</span><span class="p">,</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">tgt_actual_seq_len</span><span class="p">,</span> <span class="n">uniq_tgt_indices_in_input</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

    <span class="c1"># Ratio of number of non-padded tokens. If &lt; 1.0, we are dropping</span>
    <span class="c1"># input data due to p.packing_factor too high.</span>
    <span class="n">src_orig_tokens_count</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">src_actual_seq_len</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">src_packed_tokens_count</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">src_segment_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">summary_utils</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s1">&#39;examples/src_packed_token_ratio&#39;</span><span class="p">,</span>
                         <span class="n">src_packed_tokens_count</span> <span class="o">/</span> <span class="n">src_orig_tokens_count</span><span class="p">)</span>
    <span class="n">tgt_orig_tokens_count</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tgt_actual_seq_len</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">tgt_packed_tokens_count</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tgt_segment_ids</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>
    <span class="n">summary_utils</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="s1">&#39;examples/tgt_packed_token_ratio&#39;</span><span class="p">,</span>
                         <span class="n">tgt_packed_tokens_count</span> <span class="o">/</span> <span class="n">tgt_orig_tokens_count</span><span class="p">)</span>

    <span class="c1"># We deferred adding .paddings and use its complement .ids_indicator</span>
    <span class="c1"># exclusively so that we can apply the packing with padding set to 0 for all</span>
    <span class="c1"># fields.</span>
    <span class="k">def</span> <span class="nf">ApplyPackingToSource</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ops</span><span class="o">.</span><span class="n">apply_packing</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">src_segment_ids</span><span class="p">,</span> <span class="n">src_indices_in_input</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">ops</span><span class="o">.</span><span class="n">apply_packing</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">src_segment_ids</span><span class="p">,</span> <span class="n">src_indices_in_input</span><span class="p">)</span>

    <span class="n">src_paddings</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">apply_packing</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">src_segment_ids</span><span class="p">,</span>
                                     <span class="n">src_indices_in_input</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">ApplyPackingToSource</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">src_paddings</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">segment_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">src_segment_ids</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">segment_pos</span> <span class="o">=</span> <span class="n">src_segment_pos</span>

    <span class="k">def</span> <span class="nf">ApplyPackingToTarget</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ops</span><span class="o">.</span><span class="n">apply_packing</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">tgt_segment_ids</span><span class="p">,</span> <span class="n">tgt_indices_in_input</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">ops</span><span class="o">.</span><span class="n">apply_packing</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tgt_segment_ids</span><span class="p">,</span> <span class="n">tgt_indices_in_input</span><span class="p">)</span>

    <span class="n">tgt_paddings</span> <span class="o">=</span> <span class="n">ops</span><span class="o">.</span><span class="n">apply_packing</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">paddings</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tgt_segment_ids</span><span class="p">,</span>
                                     <span class="n">tgt_indices_in_input</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">ApplyPackingToTarget</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">tgt_paddings</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">segment_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tgt_segment_ids</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">segment_pos</span> <span class="o">=</span> <span class="n">tgt_segment_pos</span>

    <span class="c1"># The number of examples is indicated by the segment_ids of the target.</span>
    <span class="n">num_segments</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">segment_ids</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">num_examples</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">num_segments</span><span class="p">)</span>
    <span class="c1"># Note that this is per infeed value when p.use_per_host_infeed = True.</span>
    <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;examples/num_packed_examples&#39;</span>
    <span class="n">summary_utils</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">num_examples</span><span class="p">)</span></div>

<div class="viewcode-block" id="TextPackedInput._ScaledBatchSize"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._ScaledBatchSize">[docs]</a>  <span class="k">def</span> <span class="nf">_ScaledBatchSize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Adjust (post-packing) batch size according to the cluster spec.</span>
    <span class="c1"># See the impl of BaseSequenceInputGenerator.infeed_bucket_batch_limit()</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_packed_batch_size</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bucket_batch_limit</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">scaled_batch_size</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">cluster</span><span class="o">.</span><span class="n">num_splits_per_client</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">use_per_host_infeed</span> <span class="ow">and</span> <span class="n">cluster</span><span class="o">.</span><span class="n">num_tpu_hosts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">scaled_batch_size</span> <span class="o">=</span> <span class="n">scaled_batch_size</span> <span class="o">//</span> <span class="n">cluster</span><span class="o">.</span><span class="n">num_tpu_hosts</span>
    <span class="k">return</span> <span class="n">scaled_batch_size</span></div>

  <span class="c1"># TODO(yujieq): create a separate wrapper layer for the noise-adding process</span>
<div class="viewcode-block" id="TextPackedInput._AddNoise"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._AddNoise">[docs]</a>  <span class="k">def</span> <span class="nf">_AddNoise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adding noise the src (see https://arxiv.org/pdf/1711.00043).</span>

<span class="sd">    This function implement 3 types of noise (hyparams defined in</span>
<span class="sd">    self.params.denoise):</span>
<span class="sd">    1) slightly shuffle the sentence following p.shuffle_tok_range</span>
<span class="sd">    2) randomly drop tokens with probability p.drop_tok_prob</span>
<span class="sd">    3) randomly mask tokens with probability p.blank_tok_prob</span>
<span class="sd">    The noises are added to the input with probability p.noise_sent_prob.</span>

<span class="sd">    Args:</span>
<span class="sd">      batch: a `.NestedMap` of the input batch.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">IsSpecialExample</span><span class="p">(</span><span class="n">task_ids</span><span class="p">,</span> <span class="n">special_task_ids</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;A utility function indicates whether inputs belong to specific tasks.</span>

<span class="sd">      Args:</span>
<span class="sd">        task_ids: Task ids for the input batch. Tensor of shape [batch].</span>
<span class="sd">        special_task_ids: A list of specified task ids.</span>

<span class="sd">      Returns:</span>
<span class="sd">        A tensor indicating whether each sample in the batch belong to the</span>
<span class="sd">        specified task. Return a tensor of size [batch].</span>
<span class="sd">      &quot;&quot;&quot;</span>
      <span class="n">batch_size</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">GetShape</span><span class="p">(</span><span class="n">task_ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_any</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">task_ids</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
                  <span class="n">tf</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
                      <span class="n">special_task_ids</span><span class="p">,</span>
                      <span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">special_task_ids</span><span class="p">)]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">denoise</span>
    <span class="n">batch_size</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">source_max_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Shuffle tokens according to p.shuffle_tok_range</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">source_max_len</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="n">p</span><span class="o">.</span><span class="n">shuffle_tok_range</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Don&#39;t shuffle eos or padding</span>
    <span class="n">shuffle_tok_range</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">fill</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">source_max_len</span><span class="p">],</span>
                                <span class="nb">float</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">shuffle_tok_range</span><span class="p">))</span>
    <span class="n">shifted_paddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">shifted_paddings</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">noise</span><span class="p">,</span> <span class="n">shuffle_tok_range</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">broadcast_to</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">source_max_len</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="p">[</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">source_max_len</span><span class="p">])</span>
    <span class="n">noisy_indices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">+</span> <span class="n">noise</span>
    <span class="n">permutations</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">noisy_indices</span><span class="p">)</span>
    <span class="n">stacked</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">permutations</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">denoise_src_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">map_fn</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">stacked</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Select tokens to drop with probability=p.drop_tok_prob</span>
    <span class="n">random_drop_tok</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">source_max_len</span><span class="p">])</span>
    <span class="c1"># Don&#39;t drop eos token</span>
    <span class="n">is_keep_tok</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">greater</span><span class="p">(</span><span class="n">random_drop_tok</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">drop_tok_prob</span><span class="p">),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">denoise_src_ids</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_src_tokenizer</span><span class="o">.</span><span class="n">eos_id</span><span class="p">))</span>
    <span class="n">denoise_src_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ragged</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span><span class="n">denoise_src_ids</span><span class="p">,</span>
                                             <span class="n">is_keep_tok</span><span class="p">)</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span>
                                                 <span class="n">default_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                 <span class="n">shape</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">))</span>
    <span class="n">denoise_src_paddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ragged</span><span class="o">.</span><span class="n">boolean_mask</span><span class="p">(</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span><span class="p">,</span> <span class="n">is_keep_tok</span><span class="p">)</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">(</span>
            <span class="n">default_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">))</span>

    <span class="c1"># Select tokens to blank with probability=p.blank_tok_prob</span>
    <span class="c1"># Don&#39;t blank eos token</span>
    <span class="n">random_blank_tok</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">source_max_len</span><span class="p">])</span>
    <span class="n">shifted_paddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">denoise_src_paddings</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">is_blank_tok</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">random_blank_tok</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">blank_tok_prob</span><span class="p">),</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">shifted_paddings</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">blank_id</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">fill</span><span class="p">([</span><span class="n">batch_size</span><span class="p">,</span> <span class="n">source_max_len</span><span class="p">],</span> <span class="n">p</span><span class="o">.</span><span class="n">blank_id</span><span class="p">)</span>
    <span class="n">denoise_src_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_blank_tok</span><span class="p">,</span> <span class="n">blank_id</span><span class="p">,</span> <span class="n">denoise_src_ids</span><span class="p">)</span>

    <span class="c1"># Select denoising task examples with probability=p.denoise_sent_prob</span>
    <span class="n">random_uniform_sent</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">([</span><span class="n">batch_size</span><span class="p">])</span>
    <span class="n">is_denoise_sent</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">random_uniform_sent</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">noise_sent_prob</span><span class="p">),</span>
        <span class="n">IsSpecialExample</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_GetTaskIds</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">source_ids</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">p</span><span class="o">.</span><span class="n">task_ids</span><span class="p">))</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_denoise_sent</span><span class="p">,</span> <span class="n">denoise_src_ids</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_denoise_sent</span><span class="p">,</span> <span class="n">denoise_src_paddings</span><span class="p">,</span>
                                  <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span></div>

<div class="viewcode-block" id="TextPackedInput._Pack"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.TextPackedInput._Pack">[docs]</a>  <span class="k">def</span> <span class="nf">_Pack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pack the current input batch `ret` as a NestedMap of packed tensors.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">denoise</span><span class="o">.</span><span class="n">task_ids</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">denoise</span><span class="o">.</span><span class="n">noise_sent_prob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_AddNoise</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_ApplyPacking</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;weights&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">src</span> <span class="ow">or</span> <span class="s1">&#39;weights&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="p">:</span>
      <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span>
      <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span>
    <span class="k">if</span> <span class="s1">&#39;paddings&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">src</span> <span class="ow">or</span> <span class="s1">&#39;paddings&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="p">:</span>
      <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">weights</span>
      <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">weights</span>
    <span class="k">del</span> <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids_indicator</span>
    <span class="k">del</span> <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids_indicator</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pad_to_max_seq_length</span><span class="p">:</span>
      <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">source_max_length</span>

      <span class="k">def</span> <span class="nf">_EnsureSrcShape</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">ensure_shape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ScaledBatchSize</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">ensure_shape</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ScaledBatchSize</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">source_max_length</span><span class="p">])</span>

      <span class="k">def</span> <span class="nf">_EnsureTgtShape</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">tf</span><span class="o">.</span><span class="n">string</span><span class="p">:</span>
          <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">ensure_shape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ScaledBatchSize</span><span class="p">()])</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">ensure_shape</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ScaledBatchSize</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">target_max_length</span><span class="p">])</span>

      <span class="n">ret</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">_EnsureSrcShape</span><span class="p">)</span>
      <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">_EnsureTgtShape</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">suppress_id_histograms</span><span class="p">:</span>
      <span class="n">summary_utils</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="s1">&#39;source_token_ids&#39;</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
      <span class="n">summary_utils</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="s1">&#39;target_token_ids&#39;</span><span class="p">,</span> <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

    <span class="c1"># Casts floating point tensors to fprop_dtype before returning.</span>
    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Cast</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NmtDoubleInput"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput">[docs]</a><span class="k">class</span> <span class="nc">NmtDoubleInput</span><span class="p">(</span><span class="n">NmtInput</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Generator to read datasets where each data contains two sentence pairs.</span>

<span class="sd">  Each training example from the dataset consists of two sentence pairs. The</span>
<span class="sd">  second sentence pair can be a monolingual sentence pair if its source and</span>
<span class="sd">  target sentences are the same (i.e. mono_source_id=mono_target_id). This input</span>
<span class="sd">  generator supports adding masking and word permutation noises to the source</span>
<span class="sd">  sentence. The dataset contains tensorflow examples with fields as follows:</span>
<span class="sd">  `source_id`: The source sentence ids.</span>
<span class="sd">  `source_paddings`: The source paddings.</span>
<span class="sd">  `target_id`: The right shift copy of target_label starting with &lt;s&gt; tokens.</span>
<span class="sd">  `target_paddings`:  The target paddings.</span>
<span class="sd">  `target_label`: The target sentence ids.</span>
<span class="sd">  `target_weight`: The target weights.</span>
<span class="sd">  `mono_source_id`: The source sentence ids for another sentence pair.</span>
<span class="sd">  `mono_source_padding`: The source padddings for another sentence pair.</span>
<span class="sd">  `mono_target_id`: The right shift copy of mono_target_label.</span>
<span class="sd">  `mono_target_padding`: The target paddings for another sentence pair.</span>
<span class="sd">  `mono_target_label`: The target sentence ids for another sentence pair.</span>
<span class="sd">  `mono_target_weight`: The target weights for another sentence pair.</span>
<span class="sd">  &#39;natural_order`: Narural order or not, default 1.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NmtDoubleInput.Params"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput.Params">[docs]</a>  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">Params</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defaults params for NmtInputWithMono.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;packed_input&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;Whether to pack up data mainly for TPU&#39;</span>
             <span class="s1">&#39;training&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;source_mask_ratio&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;Percentage of source ids being replaced&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span>
        <span class="s1">&#39;source_mask_ratio_beta&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s1">&#39;A comma seperated list to represent two parameters in Beta&#39;</span>
        <span class="s1">&#39;distribution. It will be used when source_mask_ratio &lt;=0&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;permutation_distance&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;Permutation distance for shuffling&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;mask_word_id&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;&lt;mask&gt; word id&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;mask_words_ratio&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;Ratio of &lt;mask&gt; words in a sentence&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;pad_id&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;&lt;pad&gt; id&#39;</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">Define</span><span class="p">(</span><span class="s1">&#39;vocab_file&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;Vocabulary file path&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="NmtDoubleInput._DataSourceFromFilePattern"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput._DataSourceFromFilePattern">[docs]</a>  <span class="k">def</span> <span class="nf">_DataSourceFromFilePattern</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_pattern</span><span class="p">,</span> <span class="o">**</span><span class="n">extra_input_kwargs</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">Proc</span><span class="p">(</span><span class="n">record</span><span class="p">):</span>
      <span class="sd">&quot;&quot;&quot;Parses a serialized tf.Example record.&quot;&quot;&quot;</span>
      <span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span>
          <span class="p">(</span><span class="s1">&#39;source_id&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;source_padding&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;target_id&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;target_padding&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;target_label&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;target_weight&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;mono_source_id&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;mono_source_padding&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;mono_target_id&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;mono_target_padding&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;mono_target_label&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;mono_target_weight&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)),</span>
          <span class="p">(</span><span class="s1">&#39;natural_order&#39;</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">VarLenFeature</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
      <span class="p">]</span>
      <span class="n">features</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">parse_single_example</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="n">outputs</span><span class="p">))</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">values</span>
      <span class="n">bucket_key</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;source_padding&#39;</span><span class="p">]),</span>
              <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">features</span><span class="p">[</span><span class="s1">&#39;target_padding&#39;</span><span class="p">])),</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="k">return</span> <span class="p">[</span><span class="n">features</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">outputs</span><span class="p">],</span> <span class="n">bucket_key</span>

    <span class="n">features</span><span class="p">,</span> <span class="n">bucket_keys</span> <span class="o">=</span> <span class="n">generic_input</span><span class="o">.</span><span class="n">GenericInput</span><span class="p">(</span>
        <span class="n">file_pattern</span><span class="o">=</span><span class="n">file_pattern</span><span class="p">,</span>
        <span class="n">processor</span><span class="o">=</span><span class="n">Proc</span><span class="p">,</span>
        <span class="n">dynamic_padding_dimensions</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">13</span><span class="p">,</span>
        <span class="n">dynamic_padding_constants</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">CommonInputOpArgs</span><span class="p">())</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">BuildInputBatch</span><span class="p">(</span>
        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">InfeedBatchSize</span><span class="p">(),</span>
        <span class="n">features_list</span><span class="o">=</span><span class="n">features</span><span class="p">,</span>
        <span class="n">bucket_keys</span><span class="o">=</span><span class="n">bucket_keys</span><span class="p">)</span></div>

<div class="viewcode-block" id="NmtDoubleInput.BuildInputBatch"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput.BuildInputBatch">[docs]</a>  <span class="k">def</span> <span class="nf">BuildInputBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">features_list</span><span class="p">,</span> <span class="n">bucket_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Builds an input batch.</span>

<span class="sd">    Args:</span>
<span class="sd">      batch_size: batch size to use, defaults to infeed batch size.</span>
<span class="sd">      features_list: Use this list to build the batch.</span>
<span class="sd">      bucket_keys: If None, bucket_keys[i] is the bucketing key of the i-th</span>
<span class="sd">        sample.</span>

<span class="sd">    Returns:</span>
<span class="sd">      py_utils.NestedMap with feature names as keys and tensors as values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>

    <span class="c1"># mono_source_id and mono_target_id could be a parallel sentence pair or</span>
    <span class="c1"># a monolingual sentence pair where mono_target_id = mono_source_id.</span>
    <span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">src_paddings</span><span class="p">,</span> <span class="n">tgt_ids</span><span class="p">,</span> <span class="n">tgt_paddings</span><span class="p">,</span> <span class="n">tgt_labels</span><span class="p">,</span> <span class="n">tgt_weights</span><span class="p">,</span>
     <span class="n">mono_src_ids</span><span class="p">,</span> <span class="n">mono_src_paddings</span><span class="p">,</span> <span class="n">mono_tgt_ids</span><span class="p">,</span> <span class="n">mono_tgt_paddings</span><span class="p">,</span>
     <span class="n">mono_tgt_labels</span><span class="p">,</span> <span class="n">mono_tgt_weights</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="n">features_list</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">src_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">src_paddings</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tgt_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tgt_labels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">tgt_weights</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">tgt_paddings</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">other_src</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">mono_src_ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">mono_src_paddings</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">ret</span><span class="o">.</span><span class="n">other_tgt</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">NestedMap</span><span class="p">()</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">mono_tgt_ids</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">mono_tgt_paddings</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">mono_tgt_labels</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">ret</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">mono_tgt_weights</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ProcessBatch</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">packed_input</span><span class="p">:</span>
      <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_Pack</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fprop_dtype</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fprop_dtype</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">_Cast</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">is_floating</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fprop_dtype</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">_Cast</span><span class="p">)</span></div>

<div class="viewcode-block" id="NmtDoubleInput._SelectMaskPositions"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput._SelectMaskPositions">[docs]</a>  <span class="k">def</span> <span class="nf">_SelectMaskPositions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paddings</span><span class="p">,</span> <span class="n">ratio</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sampled_num</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sample ratio * len(sentences) or sampled_num positions from sentences.</span>

<span class="sd">    Args:</span>
<span class="sd">      paddings: a paddings tensor of shape [batch, time].</span>
<span class="sd">      ratio: a sampling ratio of a float or a tensor of shape [batch].</span>
<span class="sd">      sampled_num: a tensor of shape [batch] and will be used when ratio=None.</span>

<span class="sd">    Returns:</span>
<span class="sd">      mask: a mask tensor with 1 as selected positions and 0 as non-selected</span>
<span class="sd">          positions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">paddings</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="o">-</span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)))</span>
    <span class="n">input_length</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">paddings</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">input_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sequence_mask</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">input_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="n">input_mask</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">input_mask</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mf">1e9</span><span class="p">)</span>
    <span class="n">topk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">input_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">sampled_num</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">topk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sampled_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">topk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">topk</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
      <span class="n">topk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">topk</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="n">topk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">topk</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">sampled_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span>
    <span class="k">elif</span> <span class="n">ratio</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>
      <span class="n">topk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">topk</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
      <span class="n">topk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">topk</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">topk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">topk</span><span class="p">)</span>
      <span class="n">sampled_num</span> <span class="o">=</span> <span class="p">(</span><span class="n">input_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span>

    <span class="n">sampled_num</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">sampled_num</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">topk</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">topk</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">top_k</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">topk</span><span class="p">)</span>

    <span class="n">seq_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sequence_mask</span><span class="p">(</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">sampled_num</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">),</span> <span class="n">topk</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">seq_mask</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">top_id</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">topk</span><span class="p">)</span> <span class="o">//</span> <span class="n">topk</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">top_id</span><span class="p">,</span> <span class="n">indices</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sparse_to_dense</span><span class="p">(</span>
        <span class="n">indices</span><span class="p">,</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">validate_indices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">*</span> <span class="n">input_mask</span>
    <span class="k">return</span> <span class="n">mask</span></div>

<div class="viewcode-block" id="NmtDoubleInput._ShuffleWords"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput._ShuffleWords">[docs]</a>  <span class="k">def</span> <span class="nf">_ShuffleWords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">paddings</span><span class="p">,</span> <span class="n">permutation_distance</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Locally shuffle words with permutation_distance.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">vocab_file</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;p.vocab_file must be set if adding word shuffling noise.&#39;</span><span class="p">)</span>
    <span class="n">vocab</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">gfile</span><span class="o">.</span><span class="n">GFile</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">vocab_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fr</span><span class="p">:</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">vocab</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="n">sep_token</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xe2\x96\x81</span><span class="s1">&#39;</span>
    <span class="n">seq_length</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">paddings</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">seq_shape</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">seq</span><span class="p">)</span>
    <span class="n">bpe_end</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">vocab</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">word</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">sep_token</span><span class="p">):</span>
        <span class="n">bpe_end</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">bpe_end</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">bpe_end</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">bpe_end</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">seq_mask</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sequence_mask</span><span class="p">(</span><span class="n">seq_length</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">seq</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">seq_mask_r</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sequence_mask</span><span class="p">(</span><span class="n">seq_length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">seq</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">noise</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">seq_shape</span><span class="p">,</span> <span class="n">minval</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">maxval</span><span class="o">=</span><span class="n">permutation_distance</span><span class="p">)</span>
    <span class="n">seq_bpe_end</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">bpe_end</span><span class="p">,</span> <span class="n">seq</span><span class="p">)</span>
    <span class="n">seq_bpe_end</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
        <span class="n">seq_bpe_end</span><span class="p">,</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span> <span class="n">constant_values</span><span class="o">=</span><span class="mf">1.</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">:]</span>
    <span class="n">seq_bpe_end</span> <span class="o">=</span> <span class="n">seq_bpe_end</span> <span class="o">*</span> <span class="n">seq_mask</span>
    <span class="n">word_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">seq_bpe_end</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">word_idx</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_max</span><span class="p">(</span><span class="n">word_idx</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-</span> <span class="n">word_idx</span>
    <span class="n">word_pos_pad</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">seq_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">seq_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">//</span> <span class="n">seq_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">word_pos_pad</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">word_pos_pad</span><span class="p">,</span> <span class="n">seq_shape</span><span class="p">)</span>
    <span class="n">word_pos</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">word_pos_pad</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">word_idx</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">word_idx</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">noise</span><span class="p">,</span> <span class="n">word_pos</span><span class="p">)</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">*</span> <span class="n">seq_mask_r</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">seq_mask_r</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e6</span>
    <span class="n">scores</span> <span class="o">=</span> <span class="n">scores</span> <span class="o">+</span> <span class="mf">1e-6</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">word_pos_pad</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="n">perm_scores</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">scores</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">word_pos_perm</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">word_pos_pad</span><span class="p">,</span> <span class="n">perm_scores</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">new_seq</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather_nd</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">word_pos_perm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_seq</span></div>

<div class="viewcode-block" id="NmtDoubleInput._MaskWords"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput._MaskWords">[docs]</a>  <span class="k">def</span> <span class="nf">_MaskWords</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">paddings</span><span class="p">,</span> <span class="n">ratio</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replace ratio*len(seq) words with &lt;mask&gt; words.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">ratio</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">mask_words_ratio</span>
    <span class="n">seq_not_keep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectMaskPositions</span><span class="p">(</span><span class="n">paddings</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>
    <span class="n">seq_not_keep</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">seq_not_keep</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">mask_words</span> <span class="o">=</span> <span class="n">seq_not_keep</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">mask_word_id</span>
    <span class="n">new_seq</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">seq_not_keep</span><span class="p">)</span> <span class="o">*</span> <span class="n">seq</span> <span class="o">+</span> <span class="n">mask_words</span>
    <span class="k">return</span> <span class="n">new_seq</span></div>

<div class="viewcode-block" id="NmtDoubleInput._GenerateNoiseSents"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput._GenerateNoiseSents">[docs]</a>  <span class="k">def</span> <span class="nf">_GenerateNoiseSents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">paddings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add noises to seq.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">permutation_distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
      <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ShuffleWords</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">paddings</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">permutation_distance</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">mask_words_ratio</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
      <span class="n">seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MaskWords</span><span class="p">(</span><span class="n">seq</span><span class="p">,</span> <span class="n">paddings</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">mask_words_ratio</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">seq</span><span class="p">,</span> <span class="n">paddings</span></div>

<div class="viewcode-block" id="NmtDoubleInput._CreateSourceLambdas"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput._CreateSourceLambdas">[docs]</a>  <span class="k">def</span> <span class="nf">_CreateSourceLambdas</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_paddings</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Generate a 0/1 tensor where 1 takes up a percentage for each row.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">source_mask_ratio</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">:</span>
      <span class="n">ratio</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">convert_to_tensor</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">source_mask_ratio</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">source_mask_ratio_beta</span> <span class="o">=</span> <span class="p">[</span>
          <span class="nb">float</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">source_mask_ratio_beta</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
      <span class="p">]</span>

      <span class="n">beta_dist</span> <span class="o">=</span> <span class="n">tfp</span><span class="o">.</span><span class="n">distributions</span><span class="o">.</span><span class="n">Beta</span><span class="p">(</span><span class="n">source_mask_ratio_beta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="n">source_mask_ratio_beta</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
      <span class="n">ratio</span> <span class="o">=</span> <span class="n">beta_dist</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">source_paddings</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
      <span class="n">ratio</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">ratio</span><span class="p">)</span>
    <span class="n">source_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_SelectMaskPositions</span><span class="p">(</span><span class="n">source_paddings</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">source_mask</span></div>

<div class="viewcode-block" id="NmtDoubleInput._ProcessBatch"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput._ProcessBatch">[docs]</a>  <span class="k">def</span> <span class="nf">_ProcessBatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Aligns lengths of two source batches and target batch.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">ids</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">max_len</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">max_len</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">ids</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">PadBatch</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;paddings&#39;</span><span class="p">:</span>
          <span class="n">src</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">max_len</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">src</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">max_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="n">PadBatch</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
    <span class="n">PadBatch</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="p">)</span>
    <span class="n">PadBatch</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="p">)</span>
    <span class="n">PadBatch</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">RepTokens</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">paddings</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">pad_id</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ids</span>
      <span class="n">new_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="n">paddings</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
          <span class="n">tf</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span><span class="o">.</span><span class="n">pad_id</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">new_ids</span>

    <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">RepTokens</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">RepTokens</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span>
                                    <span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">paddings</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">RepTokens</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">paddings</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">ids</span> <span class="o">=</span> <span class="n">RepTokens</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span>
                                    <span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">paddings</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">RepTokens</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">paddings</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">RepTokens</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                       <span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">paddings</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">paddings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_GenerateNoiseSents</span><span class="p">(</span>
        <span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">ids</span><span class="p">,</span> <span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">paddings</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">source_mask_ratio</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">source_mask_ratio_beta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">source_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_CreateSourceLambdas</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">batch</span></div>

<div class="viewcode-block" id="NmtDoubleInput._Pack"><a class="viewcode-back" href="../../../../lingvo.tasks.mt.input_generator.html#lingvo.tasks.mt.input_generator.NmtDoubleInput._Pack">[docs]</a>  <span class="k">def</span> <span class="nf">_Pack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Pack up multiple examples into one sequence.&quot;&quot;&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
    <span class="n">bucket_length</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">bucket_upper_bound</span><span class="p">,</span> <span class="p">[</span><span class="n">bucket_length</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infeed_bucket_batch_limit</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">split_num</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">infeed_bucket_batch_limit</span><span class="p">,</span> <span class="p">[</span><span class="n">index</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">bs</span>
    <span class="n">fdtype</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">paddings</span><span class="o">.</span><span class="n">dtype</span>

    <span class="k">def</span> <span class="nf">GenerateSegmentPos</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
      <span class="n">segment_pos</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ids</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span>
      <span class="n">segment_pos</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">segment_pos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
      <span class="n">segment_pos</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">segment_pos</span><span class="p">,</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ids</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">segment_pos</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">GenerateSegmentIds</span><span class="p">(</span><span class="n">ids</span><span class="p">):</span>
      <span class="n">segment_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">split_num</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fdtype</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="n">segment_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">segment_ids</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span>
          <span class="p">(</span><span class="n">split_num</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">ids</span><span class="p">)[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">fdtype</span><span class="p">)</span>
      <span class="n">segment_ids</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">segment_ids</span><span class="p">,</span> <span class="p">[</span><span class="n">bs</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
      <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">segment_ids</span><span class="p">,</span> <span class="n">fdtype</span><span class="p">)</span>

    <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">segment_pos</span> <span class="o">=</span> <span class="n">GenerateSegmentPos</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">segment_ids</span> <span class="o">=</span> <span class="n">GenerateSegmentIds</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">segment_pos</span> <span class="o">=</span> <span class="n">GenerateSegmentPos</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">segment_ids</span> <span class="o">=</span> <span class="n">GenerateSegmentIds</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;other_src&#39;</span> <span class="ow">in</span> <span class="n">batch</span><span class="p">:</span>
      <span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">segment_pos</span> <span class="o">=</span> <span class="n">GenerateSegmentPos</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
      <span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">segment_ids</span> <span class="o">=</span> <span class="n">GenerateSegmentIds</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
      <span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">segment_pos</span> <span class="o">=</span> <span class="n">GenerateSegmentPos</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>
      <span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">segment_ids</span> <span class="o">=</span> <span class="n">GenerateSegmentIds</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="o">.</span><span class="n">ids</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ApplyPacking</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="n">bs</span><span class="p">,</span> <span class="n">split_num</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">1</span><span class="p">]])</span>
      <span class="k">return</span> <span class="n">x</span>

    <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">Transform</span><span class="p">(</span><span class="n">ApplyPacking</span><span class="p">)</span>

    <span class="n">data_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">bs</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">bucket_upper_bound</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">max_length</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">bucket_upper_bound</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">PadBatch</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
      <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">src</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;paddings&#39;</span><span class="p">:</span>
          <span class="n">src</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">max_length</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                                   <span class="n">data_shape</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">src</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">py_utils</span><span class="o">.</span><span class="n">PadSequenceDimension</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">max_length</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                   <span class="n">data_shape</span><span class="p">)</span>

    <span class="n">PadBatch</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">src</span><span class="p">)</span>
    <span class="n">PadBatch</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">tgt</span><span class="p">)</span>
    <span class="n">PadBatch</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_src</span><span class="p">)</span>
    <span class="n">PadBatch</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">other_tgt</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">batch</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>