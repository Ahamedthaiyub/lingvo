

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lingvo.core.layers_with_gpipe module &mdash; Lingvo  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="lingvo.core.learner module" href="lingvo.core.learner.html" />
    <link rel="prev" title="lingvo.core.layers_with_attention module" href="lingvo.core.layers_with_attention.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Lingvo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="lingvo.html">lingvo package</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="lingvo.html#subpackages">Subpackages</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="lingvo.core.html">lingvo.core package</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="lingvo.core.html#subpackages">Subpackages</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="lingvo.core.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="lingvo.tasks.html">lingvo.tasks package</a></li>
<li class="toctree-l3"><a class="reference internal" href="lingvo.tools.html">lingvo.tools package</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lingvo.html#submodules">Submodules</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Lingvo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="lingvo.html">lingvo package</a> &raquo;</li>
        
          <li><a href="lingvo.core.html">lingvo.core package</a> &raquo;</li>
        
      <li>lingvo.core.layers_with_gpipe module</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/lingvo.core.layers_with_gpipe.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="module-lingvo.core.layers_with_gpipe">
<span id="lingvo-core-layers-with-gpipe-module"></span><h1>lingvo.core.layers_with_gpipe module<a class="headerlink" href="#module-lingvo.core.layers_with_gpipe" title="Permalink to this headline">¶</a></h1>
<p>Lingvo layers that depend on layers and gpipe.</p>
<dl class="py function">
<dt id="lingvo.core.layers_with_gpipe._common_gpipe_transformer_params">
<code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">_common_gpipe_transformer_params</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">p</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#_common_gpipe_transformer_params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe._common_gpipe_transformer_params" title="Permalink to this definition">¶</a></dt>
<dd><p>Add GPipe params to layer.</p>
</dd></dl>

<dl class="py function">
<dt id="lingvo.core.layers_with_gpipe._common_gpipe_transformer_init">
<code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">_common_gpipe_transformer_init</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">layer</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#_common_gpipe_transformer_init"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe._common_gpipe_transformer_init" title="Permalink to this definition">¶</a></dt>
<dd><p>Initialize a GPipe layer.</p>
</dd></dl>

<dl class="py function">
<dt id="lingvo.core.layers_with_gpipe._common_gpipe_transformer_encoder_fprop">
<code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">_common_gpipe_transformer_encoder_fprop</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">layer</span></em>, <em class="sig-param"><span class="n">layer_class</span></em>, <em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_vecs</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_vecs</span></em>, <em class="sig-param"><span class="n">target_paddings</span></em>, <em class="sig-param"><span class="n">source_segment_id</span></em>, <em class="sig-param"><span class="n">target_segment_id</span></em>, <em class="sig-param"><span class="n">transparent_acc</span></em>, <em class="sig-param"><span class="n">transparent_acc_helper</span></em>, <em class="sig-param"><span class="n">source_task_id</span></em>, <em class="sig-param"><span class="n">target_task_id</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#_common_gpipe_transformer_encoder_fprop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe._common_gpipe_transformer_encoder_fprop" title="Permalink to this definition">¶</a></dt>
<dd><p>GPipe encoder FProp.</p>
</dd></dl>

<dl class="py function">
<dt id="lingvo.core.layers_with_gpipe._common_gpipe_transformer_decoder_fprop">
<code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">_common_gpipe_transformer_decoder_fprop</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">layer</span></em>, <em class="sig-param"><span class="n">layer_class</span></em>, <em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_vecs</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_vecs</span></em>, <em class="sig-param"><span class="n">target_paddings</span></em>, <em class="sig-param"><span class="n">source_segment_id</span></em>, <em class="sig-param"><span class="n">target_segment_id</span></em>, <em class="sig-param"><span class="n">transparent_acc</span></em>, <em class="sig-param"><span class="n">transparent_acc_helper</span></em>, <em class="sig-param"><span class="n">source_task_id</span></em>, <em class="sig-param"><span class="n">target_task_id</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#_common_gpipe_transformer_decoder_fprop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe._common_gpipe_transformer_decoder_fprop" title="Permalink to this definition">¶</a></dt>
<dd><p>GPipe decoder FProp.</p>
</dd></dl>

<dl class="py function">
<dt id="lingvo.core.layers_with_gpipe._common_gpipe_transformer_fprop_meta">
<code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">_common_gpipe_transformer_fprop_meta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">p</span></em>, <em class="sig-param"><span class="n">inputs</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#_common_gpipe_transformer_fprop_meta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe._common_gpipe_transformer_fprop_meta" title="Permalink to this definition">¶</a></dt>
<dd><p>GPipe FPropMeta function.</p>
</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerLayer">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">GPipeTransformerLayer</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerLayer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerLayer" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.layers_with_attention.html#lingvo.core.layers_with_attention.TransformerLayer" title="lingvo.core.layers_with_attention.TransformerLayer"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.layers_with_attention.TransformerLayer</span></code></a></p>
<p>GPipe compatible transformer layer.</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerLayer.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerLayer.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerLayer.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Configs for TransformerStack.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerLayer.SetupDeterministicDropout">
<em class="property">classmethod </em><code class="sig-name descname">SetupDeterministicDropout</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">params</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerLayer.SetupDeterministicDropout"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerLayer.SetupDeterministicDropout" title="Permalink to this definition">¶</a></dt>
<dd><p>Replaced dropout layers in transformer with deterministic ones.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerLayer.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_vecs</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_vecs</span></em>, <em class="sig-param"><span class="n">target_paddings</span></em>, <em class="sig-param"><span class="n">source_segment_id</span></em>, <em class="sig-param"><span class="n">target_segment_id</span></em>, <em class="sig-param"><span class="n">transparent_acc</span></em>, <em class="sig-param"><span class="n">transparent_acc_helper</span></em>, <em class="sig-param"><span class="n">source_task_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_task_id</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerLayer.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerLayer.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Transformer Layer.</p>
<p>Transformer layer has the naming scheme as follows: <code class="xref py py-obj docutils literal notranslate"><span class="pre">source_vecs</span></code> and
<code class="xref py py-obj docutils literal notranslate"><span class="pre">source_paddings</span></code> are all assumed to be coming from the activations of the
layer below. When <code class="xref py py-obj docutils literal notranslate"><span class="pre">TransformerLayer</span></code> is used in the Encoder (default
behavior of this layer) <code class="xref py py-obj docutils literal notranslate"><span class="pre">source_*</span></code> tensors correspond to the outputs of
previous encoder layer. Further, keys, values and queries are all
forked from <code class="xref py py-obj docutils literal notranslate"><span class="pre">source_vecs</span></code>. When TransformerLayer is used in the Decoder
(has_aux_atten=True), <code class="xref py py-obj docutils literal notranslate"><span class="pre">source_*</span></code> tensors correspond to the outputs of
previous decoder layer and used as the queries.</p>
<p>For the cases when <code class="xref py py-obj docutils literal notranslate"><span class="pre">TransformerLayer</span></code> is used in the decoder
(has_aux_atten=True) <code class="xref py py-obj docutils literal notranslate"><span class="pre">aux_*</span></code> tensors have to be provided.  Auxiliary inputs,
<code class="xref py py-obj docutils literal notranslate"><span class="pre">aux_*</span></code> tensors, are then correspond to the top-most layer encoder outputs
and used by the second <code class="xref py py-obj docutils literal notranslate"><span class="pre">TransformerAttentionLayer</span></code> as keys and values.</p>
<p>Regardless of the encoder or decoder, queries are always assumed to be
coming from the activations of layer below, in particular <code class="xref py py-obj docutils literal notranslate"><span class="pre">source_vecs</span></code>.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing weights’ values of this layer and
its children layers.</p></li>
<li><p><strong>source_vecs</strong> – [source_time, source_batch, dim].</p></li>
<li><p><strong>source_paddings</strong> – [source_time, source_batch]</p></li>
<li><p><strong>aux_vecs</strong> – [aux_time, aux_batch, dim]</p></li>
<li><p><strong>aux_paddings</strong> – [aux_time, aux_batch]</p></li>
<li><p><strong>source_segment_id</strong> – [source_time, source_batch]</p></li>
<li><p><strong>aux_segment_id</strong> – [aux_time, aux_batch]</p></li>
<li><p><strong>**kwargs</strong> – Can be optional params for the attention layer, eg. attention
projection index tensor.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>The attention context vector, [source_time, source_batch, dim].</p>
<p>The attention probability vector, [source_time, source_batch, source_time]
if has_aux_atten is False, otherwise [source_time, source_batch,
aux_time].</p>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerLayer.FPropMeta">
<em class="property">classmethod </em><code class="sig-name descname">FPropMeta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">p</span></em>, <em class="sig-param"><span class="n">inputs</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerLayer.FPropMeta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerLayer.FPropMeta" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns metadata about the <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeTransformerLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeTransformerLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> computation for this layer.</p>
<p><strong>Experimental feature.</strong>
Don’t use or depend on it without consulting Lingvo authors.</p>
<p>E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">SomeComplexLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">FPropMeta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tshape</span><span class="o">.</span><span class="n">Shape</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.flops</span></code> gives an estimate count of floating point operations done by
one <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeTransformerLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeTransformerLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> given an input tensor of shape [128, 20, 50, channels].
<code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.out_shapes</span></code> is a tuple of TShape, which tells you what shape
of tensors this layer will return.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>params</strong> – The param of a layer of this layer type.</p></li>
<li><p><strong>*args</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
<li><p><strong>**kwargs</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> with</p>
<ul class="simple">
<li><p>flops - The estimated number of floating point operations incurred by
this fprop.</p></li>
<li><p>out_shapes - A tuple of <code class="xref py py-obj docutils literal notranslate"><span class="pre">TShape</span></code>. I.e., <code class="xref py py-obj docutils literal notranslate"><span class="pre">out_shapes[i]</span></code>
represents the shape of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">i</span></code>-th returned tensor of the fprop.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">GPipeEvolvedTransformerEncoderLayer</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerEncoderLayer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.layers_with_attention.html#lingvo.core.layers_with_attention.EvolvedTransformerEncoderLayer" title="lingvo.core.layers_with_attention.EvolvedTransformerEncoderLayer"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.layers_with_attention.EvolvedTransformerEncoderLayer</span></code></a></p>
<p>GPipe-compatible Evolved Transformer encoder layer.</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerEncoderLayer.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the layer params.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_vecs</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_vecs</span></em>, <em class="sig-param"><span class="n">target_paddings</span></em>, <em class="sig-param"><span class="n">source_segment_id</span></em>, <em class="sig-param"><span class="n">target_segment_id</span></em>, <em class="sig-param"><span class="n">transparent_acc</span></em>, <em class="sig-param"><span class="n">transparent_acc_helper</span></em>, <em class="sig-param"><span class="n">source_task_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_task_id</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerEncoderLayer.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Forward propagation.</p>
<p>The central interface that subclasses should implement. The caller
calls <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> with a <code class="xref py py-obj docutils literal notranslate"><span class="pre">theta</span></code> dictionary. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span> <span class="o">=</span> <span class="n">InstanceOfASubClassOfFoo</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>The implementation of <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp()</span></code></a> computes a function given
the theta and the inputs. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">a0</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<span class="n">a1</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">softmax</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">softmax</span><span class="p">,</span> <span class="n">a0</span><span class="p">)</span>
<span class="c1"># The same layer applied twice.</span>
<span class="n">a2</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
<span class="k">return</span> <span class="n">a2</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing weights’ values of this
layer and its children layers.</p></li>
<li><p><strong>*args</strong> – List args.</p></li>
<li><p><strong>**kwargs</strong> – Keyward args.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FPropMeta">
<em class="property">classmethod </em><code class="sig-name descname">FPropMeta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">p</span></em>, <em class="sig-param"><span class="n">inputs</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerEncoderLayer.FPropMeta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FPropMeta" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns metadata about the <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> computation for this layer.</p>
<p><strong>Experimental feature.</strong>
Don’t use or depend on it without consulting Lingvo authors.</p>
<p>E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">SomeComplexLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">FPropMeta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tshape</span><span class="o">.</span><span class="n">Shape</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.flops</span></code> gives an estimate count of floating point operations done by
one <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> given an input tensor of shape [128, 20, 50, channels].
<code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.out_shapes</span></code> is a tuple of TShape, which tells you what shape
of tensors this layer will return.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>params</strong> – The param of a layer of this layer type.</p></li>
<li><p><strong>*args</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
<li><p><strong>**kwargs</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> with</p>
<ul class="simple">
<li><p>flops - The estimated number of floating point operations incurred by
this fprop.</p></li>
<li><p>out_shapes - A tuple of <code class="xref py py-obj docutils literal notranslate"><span class="pre">TShape</span></code>. I.e., <code class="xref py py-obj docutils literal notranslate"><span class="pre">out_shapes[i]</span></code>
represents the shape of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">i</span></code>-th returned tensor of the fprop.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer._AttentionSetupDeterministicDropout">
<em class="property">classmethod </em><code class="sig-name descname">_AttentionSetupDeterministicDropout</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">tr_atten_tpl</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerEncoderLayer._AttentionSetupDeterministicDropout"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer._AttentionSetupDeterministicDropout" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer._TransformerSetupDeterministicDropout">
<em class="property">classmethod </em><code class="sig-name descname">_TransformerSetupDeterministicDropout</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">transformer_tpl</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerEncoderLayer._TransformerSetupDeterministicDropout"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer._TransformerSetupDeterministicDropout" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.SetupDeterministicDropout">
<em class="property">classmethod </em><code class="sig-name descname">SetupDeterministicDropout</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">params</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerEncoderLayer.SetupDeterministicDropout"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerEncoderLayer.SetupDeterministicDropout" title="Permalink to this definition">¶</a></dt>
<dd><p>Replaces dropout layers in ET with deterministic ones.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">GPipeEvolvedTransformerDecoderLayer</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerDecoderLayer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.layers_with_attention.html#lingvo.core.layers_with_attention.EvolvedTransformerDecoderLayer" title="lingvo.core.layers_with_attention.EvolvedTransformerDecoderLayer"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.layers_with_attention.EvolvedTransformerDecoderLayer</span></code></a></p>
<p>GPipe-compatible Evolved Transformer decoder layer.</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerDecoderLayer.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the layer params.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_vecs</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_vecs</span></em>, <em class="sig-param"><span class="n">target_paddings</span></em>, <em class="sig-param"><span class="n">source_segment_id</span></em>, <em class="sig-param"><span class="n">target_segment_id</span></em>, <em class="sig-param"><span class="n">transparent_acc</span></em>, <em class="sig-param"><span class="n">transparent_acc_helper</span></em>, <em class="sig-param"><span class="n">source_task_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_task_id</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerDecoderLayer.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Forward propagation.</p>
<p>The central interface that subclasses should implement. The caller
calls <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> with a <code class="xref py py-obj docutils literal notranslate"><span class="pre">theta</span></code> dictionary. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span> <span class="o">=</span> <span class="n">InstanceOfASubClassOfFoo</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>The implementation of <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp()</span></code></a> computes a function given
the theta and the inputs. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">a0</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<span class="n">a1</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">softmax</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">softmax</span><span class="p">,</span> <span class="n">a0</span><span class="p">)</span>
<span class="c1"># The same layer applied twice.</span>
<span class="n">a2</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
<span class="k">return</span> <span class="n">a2</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing weights’ values of this
layer and its children layers.</p></li>
<li><p><strong>*args</strong> – List args.</p></li>
<li><p><strong>**kwargs</strong> – Keyward args.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FPropMeta">
<em class="property">classmethod </em><code class="sig-name descname">FPropMeta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">p</span></em>, <em class="sig-param"><span class="n">inputs</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerDecoderLayer.FPropMeta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FPropMeta" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns metadata about the <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> computation for this layer.</p>
<p><strong>Experimental feature.</strong>
Don’t use or depend on it without consulting Lingvo authors.</p>
<p>E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">SomeComplexLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">FPropMeta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tshape</span><span class="o">.</span><span class="n">Shape</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.flops</span></code> gives an estimate count of floating point operations done by
one <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> given an input tensor of shape [128, 20, 50, channels].
<code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.out_shapes</span></code> is a tuple of TShape, which tells you what shape
of tensors this layer will return.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>params</strong> – The param of a layer of this layer type.</p></li>
<li><p><strong>*args</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
<li><p><strong>**kwargs</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> with</p>
<ul class="simple">
<li><p>flops - The estimated number of floating point operations incurred by
this fprop.</p></li>
<li><p>out_shapes - A tuple of <code class="xref py py-obj docutils literal notranslate"><span class="pre">TShape</span></code>. I.e., <code class="xref py py-obj docutils literal notranslate"><span class="pre">out_shapes[i]</span></code>
represents the shape of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">i</span></code>-th returned tensor of the fprop.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer._AttentionSetupDeterministicDropout">
<em class="property">classmethod </em><code class="sig-name descname">_AttentionSetupDeterministicDropout</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">tr_atten_tpl</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerDecoderLayer._AttentionSetupDeterministicDropout"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer._AttentionSetupDeterministicDropout" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer._TransformerSetupDeterministicDropout">
<em class="property">classmethod </em><code class="sig-name descname">_TransformerSetupDeterministicDropout</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">transformer_tpl</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerDecoderLayer._TransformerSetupDeterministicDropout"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer._TransformerSetupDeterministicDropout" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.SetupDeterministicDropout">
<em class="property">classmethod </em><code class="sig-name descname">SetupDeterministicDropout</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">params</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerDecoderLayer.SetupDeterministicDropout"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerDecoderLayer.SetupDeterministicDropout" title="Permalink to this definition">¶</a></dt>
<dd><p>Replaces dropout layers in ET with deterministic ones.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">GPipeTransformerSoftmaxLayer</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerSoftmaxLayer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.layers.html#lingvo.core.layers.SimpleFullSoftmax" title="lingvo.core.layers.SimpleFullSoftmax"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.layers.SimpleFullSoftmax</span></code></a></p>
<p>GPipe compatible softmax layer for transformers for computing logits.</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerSoftmaxLayer.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Params for SimpleFullSoftmax.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_vecs</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_vecs</span></em>, <em class="sig-param"><span class="n">target_paddings</span></em>, <em class="sig-param"><span class="n">source_segment_id</span></em>, <em class="sig-param"><span class="n">target_segment_id</span></em>, <em class="sig-param"><span class="n">transparent_acc</span></em>, <em class="sig-param"><span class="n">transparent_acc_helper</span></em>, <em class="sig-param"><span class="n">source_task_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_task_id</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerSoftmaxLayer.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Computes logit, cross entropy etc.</p>
<p>This function can both work with class_ids, or probability distributions
over classes. Exactly one of class_ids or class_probabilities must be
provided.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing weights’ values of this layer and
its children layers.</p></li>
<li><p><strong>inputs</strong> – a list of a single tensor, or a single tensor with the shape […,
input_dim].</p></li>
<li><p><strong>class_weights</strong> – a tensor with shape […] containing the weights for each
target word.</p></li>
<li><p><strong>class_ids</strong> – a tensor with shape […, 1] of int32 dtype containing the
target class labels.</p></li>
<li><p><strong>class_probabilities</strong> – a tensor with shape […, num_classes] of float
values indicating class-membership probabilities.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> containing the following fields</p>
<ul class="simple">
<li><p>logits: with shape […, num_classes]. Unnormalized softmax’s logits.</p></li>
<li><p>per_example_argmax: with shape […]. argmax of i-th example.</p></li>
<li><p>per_example_xent: with shape […]. Cross entropy between i-th example’s
prediction and its label.</p></li>
<li><p>per_example_weight: with shape […]. class_weights casted to
this layer’s dtype.</p></li>
<li><p>total_xent: A scalar. The sum of per_example_weight * per_example_xent.</p></li>
<li><p>total_weight: A scalar. The sum of per_example_weight.</p></li>
<li><p>avg_xent: A scalar. total_loss / total_weight.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer.FPropMeta">
<em class="property">classmethod </em><code class="sig-name descname">FPropMeta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">p</span></em>, <em class="sig-param"><span class="n">inputs</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerSoftmaxLayer.FPropMeta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer.FPropMeta" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns metadata about the <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> computation for this layer.</p>
<p><strong>Experimental feature.</strong>
Don’t use or depend on it without consulting Lingvo authors.</p>
<p>E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">SomeComplexLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">FPropMeta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tshape</span><span class="o">.</span><span class="n">Shape</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.flops</span></code> gives an estimate count of floating point operations done by
one <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeTransformerSoftmaxLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> given an input tensor of shape [128, 20, 50, channels].
<code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.out_shapes</span></code> is a tuple of TShape, which tells you what shape
of tensors this layer will return.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>params</strong> – The param of a layer of this layer type.</p></li>
<li><p><strong>*args</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
<li><p><strong>**kwargs</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> with</p>
<ul class="simple">
<li><p>flops - The estimated number of floating point operations incurred by
this fprop.</p></li>
<li><p>out_shapes - A tuple of <code class="xref py py-obj docutils literal notranslate"><span class="pre">TShape</span></code>. I.e., <code class="xref py py-obj docutils literal notranslate"><span class="pre">out_shapes[i]</span></code>
represents the shape of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">i</span></code>-th returned tensor of the fprop.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">GPipeTransformerEmbeddingLayer</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerEmbeddingLayer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.base_layer.html#lingvo.core.base_layer.BaseLayer" title="lingvo.core.base_layer.BaseLayer"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.base_layer.BaseLayer</span></code></a></p>
<p>GPipe compatible embeddings for transformers.</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerEmbeddingLayer.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Configs of Embedding layers for TransformerStack.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.GetEmbeddings">
<code class="sig-name descname">GetEmbeddings</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">emb_theta</span></em>, <em class="sig-param"><span class="n">emb</span></em>, <em class="sig-param"><span class="n">pos_emb_theta</span></em>, <em class="sig-param"><span class="n">pos_emb</span></em>, <em class="sig-param"><span class="n">dropout_theta</span></em>, <em class="sig-param"><span class="n">dropout</span></em>, <em class="sig-param"><span class="n">input_ids</span></em>, <em class="sig-param"><span class="n">input_segment_pos</span></em>, <em class="sig-param"><span class="n">task_emb_theta</span></em>, <em class="sig-param"><span class="n">task_emb</span></em>, <em class="sig-param"><span class="n">task_ids</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerEmbeddingLayer.GetEmbeddings"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.GetEmbeddings" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.GetEncoderEmbeddingsDefaultTheta">
<code class="sig-name descname">GetEncoderEmbeddingsDefaultTheta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">input_ids</span></em>, <em class="sig-param"><span class="n">task_ids</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerEmbeddingLayer.GetEncoderEmbeddingsDefaultTheta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.GetEncoderEmbeddingsDefaultTheta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.GetDecoderEmbeddingsDefaultTheta">
<code class="sig-name descname">GetDecoderEmbeddingsDefaultTheta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">input_ids</span></em>, <em class="sig-param"><span class="n">task_ids</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">t</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerEmbeddingLayer.GetDecoderEmbeddingsDefaultTheta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.GetDecoderEmbeddingsDefaultTheta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_id</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_id</span></em>, <em class="sig-param"><span class="n">target_paddings</span></em>, <em class="sig-param"><span class="n">source_segment_id</span></em>, <em class="sig-param"><span class="n">target_segment_id</span></em>, <em class="sig-param"><span class="n">source_segment_pos</span></em>, <em class="sig-param"><span class="n">target_segment_pos</span></em>, <em class="sig-param"><span class="n">source_task_id</span></em>, <em class="sig-param"><span class="n">target_task_id</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerEmbeddingLayer.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Forward propagation.</p>
<p>The central interface that subclasses should implement. The caller
calls <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> with a <code class="xref py py-obj docutils literal notranslate"><span class="pre">theta</span></code> dictionary. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span> <span class="o">=</span> <span class="n">InstanceOfASubClassOfFoo</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>The implementation of <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp()</span></code></a> computes a function given
the theta and the inputs. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">a0</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<span class="n">a1</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">softmax</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">softmax</span><span class="p">,</span> <span class="n">a0</span><span class="p">)</span>
<span class="c1"># The same layer applied twice.</span>
<span class="n">a2</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
<span class="k">return</span> <span class="n">a2</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing weights’ values of this
layer and its children layers.</p></li>
<li><p><strong>*args</strong> – List args.</p></li>
<li><p><strong>**kwargs</strong> – Keyward args.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FPropMeta">
<em class="property">classmethod </em><code class="sig-name descname">FPropMeta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">p</span></em>, <em class="sig-param"><span class="n">inputs</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerEmbeddingLayer.FPropMeta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FPropMeta" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns metadata about the <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> computation for this layer.</p>
<p><strong>Experimental feature.</strong>
Don’t use or depend on it without consulting Lingvo authors.</p>
<p>E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">SomeComplexLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">FPropMeta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tshape</span><span class="o">.</span><span class="n">Shape</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.flops</span></code> gives an estimate count of floating point operations done by
one <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeTransformerEmbeddingLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> given an input tensor of shape [128, 20, 50, channels].
<code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.out_shapes</span></code> is a tuple of TShape, which tells you what shape
of tensors this layer will return.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>params</strong> – The param of a layer of this layer type.</p></li>
<li><p><strong>*args</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
<li><p><strong>**kwargs</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> with</p>
<ul class="simple">
<li><p>flops - The estimated number of floating point operations incurred by
this fprop.</p></li>
<li><p>out_shapes - A tuple of <code class="xref py py-obj docutils literal notranslate"><span class="pre">TShape</span></code>. I.e., <code class="xref py py-obj docutils literal notranslate"><span class="pre">out_shapes[i]</span></code>
represents the shape of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">i</span></code>-th returned tensor of the fprop.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerStack">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">GPipeTransformerStack</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerStack"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.gpipe.html#lingvo.core.gpipe.PipeliningLayer" title="lingvo.core.gpipe.PipeliningLayer"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.gpipe.PipeliningLayer</span></code></a></p>
<p>Stacked self- multi-head attention and fully connected layers.</p>
<p>With optional layer normalization applied to the final output.</p>
<p>See ‘Attention Is All You Need’ <a class="reference external" href="https://arxiv.org/abs/1706.03762">https://arxiv.org/abs/1706.03762</a>
for details.</p>
<p>The use of this stack for batch major transformer is deprecated.
Use GPipeBatchMajorTransformerStack instead.</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerStack.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerStack.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Configs for TransformerStack.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerStack._CreateChildrenVariables">
<code class="sig-name descname">_CreateChildrenVariables</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerStack._CreateChildrenVariables"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack._CreateChildrenVariables" title="Permalink to this definition">¶</a></dt>
<dd><p>Create variables for child layers.</p>
<p>Should be rarely overridden, only in cases when control over the context of
children InstantiateVariables calls are needed. eg, if children variables
need to be created inside of a specific context manager.</p>
<p>There are a few cases of this in the codebase marked as for backwards
compability. This is only to ensure that variable scopes remain compatible
through the code migration. New layers should not copy that pattern, and
instead follow the standard pattern of self.CreateChild() in __init__() and
self.CreateVariable() in _CreateLayerVariables(). If you are okay with
breaking old checkpoints, you can go ahead and delete those functions.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerStack.Logits">
<code class="sig-name descname">Logits</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">inputs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerStack.Logits"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack.Logits" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerStack.GetEncoders">
<code class="sig-name descname">GetEncoders</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerStack.GetEncoders"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack.GetEncoders" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerStack.GetDecoders">
<code class="sig-name descname">GetDecoders</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerStack.GetDecoders"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack.GetDecoders" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerStack.EncoderEmbedFPropDefaultTheta">
<code class="sig-name descname">EncoderEmbedFPropDefaultTheta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">source_id</span></em>, <em class="sig-param"><span class="n">source_task_id</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerStack.EncoderEmbedFPropDefaultTheta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack.EncoderEmbedFPropDefaultTheta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerStack.DecoderEmbedFPropDefaultTheta">
<code class="sig-name descname">DecoderEmbedFPropDefaultTheta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">tgt_id</span></em>, <em class="sig-param"><span class="n">tgt_task_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">t</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerStack.DecoderEmbedFPropDefaultTheta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack.DecoderEmbedFPropDefaultTheta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerStack.EncoderFPropDefaultTheta">
<code class="sig-name descname">EncoderFPropDefaultTheta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">source_vecs</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">source_segment_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">source_task_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_task_id</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerStack.EncoderFPropDefaultTheta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack.EncoderFPropDefaultTheta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeTransformerStack.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_input</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_input</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_paddings</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">source_segment_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_segment_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">labels</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">label_weights</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">source_segment_pos</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_segment_pos</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">source_task_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_task_id</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeTransformerStack.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Transforms source sequence of Tensors with Transformers layers.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing weights’ values of this layer and
its children layers.</p></li>
<li><p><strong>source_input</strong> – A sequence of ints indicating source input ids of [time,
batch] shape or [batch, time] if batch_dim is 0.</p></li>
<li><p><strong>source_paddings</strong> – A sequence of 0s and 1s indicating input paddings of
[time, batch] shape or [batch, time] if batch_dim is 0.</p></li>
<li><p><strong>target_input</strong> – A sequence of ints indicating target input ids of [time,
batch] shape or [batch, time] if batch_dim is 0.</p></li>
<li><p><strong>target_paddings</strong> – [target_time, target_batch] or [target_batch,
target_time] if batch_dim is 0.</p></li>
<li><p><strong>source_segment_id</strong> – A sequence of ints indicating source segment ids of
[time, batch] shape or [batch, time] if batch_dim is 0.</p></li>
<li><p><strong>target_segment_id</strong> – A sequence of ints indicating target segment ids of
[time, batch] shape or [batch, time] if batch_dim is 0.</p></li>
<li><p><strong>labels</strong> – A sequence of ints indicating label ids of [time, batch] shape, or
[batch, time] if batch_dim is 0.</p></li>
<li><p><strong>label_weights</strong> – A sequence of floats indicates label weights of [time,
batch] shape, or [batch, time] if batch_dim is 0.</p></li>
<li><p><strong>source_segment_pos</strong> – A sequence of ints indicating source position ids of
[time, batch] shape, or [batch, time] if batch_dim is 0.</p></li>
<li><p><strong>target_segment_pos</strong> – A sequence of ints indicating target position ids of
[time, batch] shape, or [batch, time] if batch_dim is 0.</p></li>
<li><p><strong>source_task_id</strong> – A sequence of ints indicating source task ids of [time,
batch] shape, or [batch, time] if batch_dim is 0.</p></li>
<li><p><strong>target_task_id</strong> – A sequence of ints indicating target task ids of [time,
batch] shape, or [batch, time] if batch_dim is 0.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>transformer_output with shape [time, batch, dim] or [batch, time, dim]
if batch_dim is 0.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerStack">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">GPipeEvolvedTransformerStack</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerStack"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerStack" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeTransformerStack" title="lingvo.core.layers_with_gpipe.GPipeTransformerStack"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.layers_with_gpipe.GPipeTransformerStack</span></code></a></p>
<p>Evolved Transformer stack for GPipe.</p>
<p>With optional layer normalization applied to the final output.</p>
<p>See ‘Evolved Transformer’ for more details:
<a class="reference external" href="https://arxiv.org/abs/1901.11117">https://arxiv.org/abs/1901.11117</a> .</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerStack.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeEvolvedTransformerStack.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeEvolvedTransformerStack.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Configs for EvolvedTransformerStack.</p>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.DeterministicWeightsLayer">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">DeterministicWeightsLayer</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#DeterministicWeightsLayer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.DeterministicWeightsLayer" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.base_layer.html#lingvo.core.base_layer.BaseLayer" title="lingvo.core.base_layer.BaseLayer"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.base_layer.BaseLayer</span></code></a></p>
<p>WeightedSumLayer with deterministic dropout.</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.DeterministicWeightsLayer.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#DeterministicWeightsLayer.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.DeterministicWeightsLayer.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Params for this MergerLayer class.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.DeterministicWeightsLayer._CreateLayerVariables">
<code class="sig-name descname">_CreateLayerVariables</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#DeterministicWeightsLayer._CreateLayerVariables"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.DeterministicWeightsLayer._CreateLayerVariables" title="Permalink to this definition">¶</a></dt>
<dd><p>Actually create variables for this layer.</p>
<p>Subclasses should override this function.</p>
<p>Variables are created inside of tf.variable_scope(self.params.name).</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.DeterministicWeightsLayer.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#DeterministicWeightsLayer.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.DeterministicWeightsLayer.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Combines the list of input tensors into a single tensor.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><p><strong>theta</strong> – A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing weights’ values of this layer and
its children layers.</p>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A tensor of weights with dropout applied with shape [num_sources].</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">GPipeBatchMajorTransformerSoftmaxLayer</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerSoftmaxLayer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.layers.html#lingvo.core.layers.SimpleFullSoftmax" title="lingvo.core.layers.SimpleFullSoftmax"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.layers.SimpleFullSoftmax</span></code></a></p>
<p>GPipe compatible softmax layer for transformers for computing logits.</p>
<p>FProp interface is different for batch major stack, using segment_masks
instead of segment_ids.</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerSoftmaxLayer.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Params for SimpleFullSoftmax.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_vecs</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_vecs</span></em>, <em class="sig-param"><span class="n">target_paddings</span></em>, <em class="sig-param"><span class="n">encoder_self_atten_segment_mask</span></em>, <em class="sig-param"><span class="n">decoder_self_atten_segment_mask</span></em>, <em class="sig-param"><span class="n">decoder_cross_atten_segment_mask</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerSoftmaxLayer.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Computes logit, cross entropy etc.</p>
<p>This function can both work with class_ids, or probability distributions
over classes. Exactly one of class_ids or class_probabilities must be
provided.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing weights’ values of this layer and
its children layers.</p></li>
<li><p><strong>inputs</strong> – a list of a single tensor, or a single tensor with the shape […,
input_dim].</p></li>
<li><p><strong>class_weights</strong> – a tensor with shape […] containing the weights for each
target word.</p></li>
<li><p><strong>class_ids</strong> – a tensor with shape […, 1] of int32 dtype containing the
target class labels.</p></li>
<li><p><strong>class_probabilities</strong> – a tensor with shape […, num_classes] of float
values indicating class-membership probabilities.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> containing the following fields</p>
<ul class="simple">
<li><p>logits: with shape […, num_classes]. Unnormalized softmax’s logits.</p></li>
<li><p>per_example_argmax: with shape […]. argmax of i-th example.</p></li>
<li><p>per_example_xent: with shape […]. Cross entropy between i-th example’s
prediction and its label.</p></li>
<li><p>per_example_weight: with shape […]. class_weights casted to
this layer’s dtype.</p></li>
<li><p>total_xent: A scalar. The sum of per_example_weight * per_example_xent.</p></li>
<li><p>total_weight: A scalar. The sum of per_example_weight.</p></li>
<li><p>avg_xent: A scalar. total_loss / total_weight.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer.FPropMeta">
<em class="property">classmethod </em><code class="sig-name descname">FPropMeta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">p</span></em>, <em class="sig-param"><span class="n">inputs</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerSoftmaxLayer.FPropMeta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer.FPropMeta" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns metadata about the <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> computation for this layer.</p>
<p><strong>Experimental feature.</strong>
Don’t use or depend on it without consulting Lingvo authors.</p>
<p>E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">SomeComplexLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">FPropMeta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tshape</span><span class="o">.</span><span class="n">Shape</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.flops</span></code> gives an estimate count of floating point operations done by
one <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerSoftmaxLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> given an input tensor of shape [128, 20, 50, channels].
<code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.out_shapes</span></code> is a tuple of TShape, which tells you what shape
of tensors this layer will return.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>params</strong> – The param of a layer of this layer type.</p></li>
<li><p><strong>*args</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
<li><p><strong>**kwargs</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> with</p>
<ul class="simple">
<li><p>flops - The estimated number of floating point operations incurred by
this fprop.</p></li>
<li><p>out_shapes - A tuple of <code class="xref py py-obj docutils literal notranslate"><span class="pre">TShape</span></code>. I.e., <code class="xref py py-obj docutils literal notranslate"><span class="pre">out_shapes[i]</span></code>
represents the shape of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">i</span></code>-th returned tensor of the fprop.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">GPipeBatchMajorTransformerEmbeddingLayer</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerEmbeddingLayer"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.base_layer.html#lingvo.core.base_layer.BaseLayer" title="lingvo.core.base_layer.BaseLayer"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.base_layer.BaseLayer</span></code></a></p>
<p>GPipe compatible embeddings for transformers.</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerEmbeddingLayer.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Configs of Embedding layers for TransformerStack.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.GetEmbeddings">
<code class="sig-name descname">GetEmbeddings</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">emb_theta</span></em>, <em class="sig-param"><span class="n">emb</span></em>, <em class="sig-param"><span class="n">pos_emb_theta</span></em>, <em class="sig-param"><span class="n">pos_emb</span></em>, <em class="sig-param"><span class="n">dropout_theta</span></em>, <em class="sig-param"><span class="n">dropout</span></em>, <em class="sig-param"><span class="n">input_ids</span></em>, <em class="sig-param"><span class="n">input_segment_pos</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerEmbeddingLayer.GetEmbeddings"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.GetEmbeddings" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.GetEncoderEmbeddingsDefaultTheta">
<code class="sig-name descname">GetEncoderEmbeddingsDefaultTheta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">input_ids</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerEmbeddingLayer.GetEncoderEmbeddingsDefaultTheta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.GetEncoderEmbeddingsDefaultTheta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.GetDecoderEmbeddingsDefaultTheta">
<code class="sig-name descname">GetDecoderEmbeddingsDefaultTheta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">input_ids</span></em>, <em class="sig-param"><span class="n">t</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerEmbeddingLayer.GetDecoderEmbeddingsDefaultTheta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.GetDecoderEmbeddingsDefaultTheta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_id</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_id</span></em>, <em class="sig-param"><span class="n">target_paddings</span></em>, <em class="sig-param"><span class="n">encoder_self_atten_segment_mask</span></em>, <em class="sig-param"><span class="n">decoder_self_atten_segment_mask</span></em>, <em class="sig-param"><span class="n">decoder_cross_atten_segment_mask</span></em>, <em class="sig-param"><span class="n">source_segment_pos</span></em>, <em class="sig-param"><span class="n">target_segment_pos</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerEmbeddingLayer.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Forward propagation.</p>
<p>The central interface that subclasses should implement. The caller
calls <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> with a <code class="xref py py-obj docutils literal notranslate"><span class="pre">theta</span></code> dictionary. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">foo</span> <span class="o">=</span> <span class="n">InstanceOfASubClassOfFoo</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">foo</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">foo</span><span class="o">.</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
<p>The implementation of <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp()</span></code></a> computes a function given
the theta and the inputs. E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">children</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">a0</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
<span class="n">a1</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">softmax</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">softmax</span><span class="p">,</span> <span class="n">a0</span><span class="p">)</span>
<span class="c1"># The same layer applied twice.</span>
<span class="n">a2</span> <span class="o">=</span> <span class="n">subs</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">FProp</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">linear</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
<span class="k">return</span> <span class="n">a2</span>
</pre></div>
</div>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing weights’ values of this
layer and its children layers.</p></li>
<li><p><strong>*args</strong> – List args.</p></li>
<li><p><strong>**kwargs</strong> – Keyward args.</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FPropMeta">
<em class="property">classmethod </em><code class="sig-name descname">FPropMeta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">p</span></em>, <em class="sig-param"><span class="n">inputs</span></em>, <em class="sig-param"><span class="o">*</span><span class="n">args</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerEmbeddingLayer.FPropMeta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FPropMeta" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns metadata about the <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> computation for this layer.</p>
<p><strong>Experimental feature.</strong>
Don’t use or depend on it without consulting Lingvo authors.</p>
<p>E.g.:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">SomeComplexLayer</span><span class="o">.</span><span class="n">Params</span><span class="p">()</span>
<span class="n">meta</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">FPropMeta</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">tshape</span><span class="o">.</span><span class="n">Shape</span><span class="p">([</span><span class="mi">128</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;channels&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<p><code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.flops</span></code> gives an estimate count of floating point operations done by
one <a class="reference internal" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FProp" title="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerEmbeddingLayer.FProp"><code class="xref py py-obj docutils literal notranslate"><span class="pre">FProp</span></code></a> given an input tensor of shape [128, 20, 50, channels].
<code class="xref py py-obj docutils literal notranslate"><span class="pre">meta.out_shapes</span></code> is a tuple of TShape, which tells you what shape
of tensors this layer will return.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>params</strong> – The param of a layer of this layer type.</p></li>
<li><p><strong>*args</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
<li><p><strong>**kwargs</strong> – Corresponds to FProp with Tensors replaced by <code class="xref py py-obj docutils literal notranslate"><span class="pre">TensorShape</span></code>.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> with</p>
<ul class="simple">
<li><p>flops - The estimated number of floating point operations incurred by
this fprop.</p></li>
<li><p>out_shapes - A tuple of <code class="xref py py-obj docutils literal notranslate"><span class="pre">TShape</span></code>. I.e., <code class="xref py py-obj docutils literal notranslate"><span class="pre">out_shapes[i]</span></code>
represents the shape of the <code class="xref py py-obj docutils literal notranslate"><span class="pre">i</span></code>-th returned tensor of the fprop.</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.layers_with_gpipe.</code><code class="sig-name descname">GPipeBatchMajorTransformerStack</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerStack"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.gpipe.html#lingvo.core.gpipe.PipeliningLayer" title="lingvo.core.gpipe.PipeliningLayer"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.gpipe.PipeliningLayer</span></code></a></p>
<p>Stacked self- multi-head attention and fully connected layers.</p>
<p>With optional layer normalization applied to the final output.</p>
<p>See ‘Attention Is All You Need’ <a class="reference external" href="https://arxiv.org/abs/1706.03762">https://arxiv.org/abs/1706.03762</a>
for details.</p>
<p>Implements a gipe stack for the batch major transformer variant.</p>
<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerStack.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Configs for TransformerStack.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack._CreateChildrenVariables">
<code class="sig-name descname">_CreateChildrenVariables</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerStack._CreateChildrenVariables"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack._CreateChildrenVariables" title="Permalink to this definition">¶</a></dt>
<dd><p>Create variables for child layers.</p>
<p>Should be rarely overridden, only in cases when control over the context of
children InstantiateVariables calls are needed. eg, if children variables
need to be created inside of a specific context manager.</p>
<p>There are a few cases of this in the codebase marked as for backwards
compability. This is only to ensure that variable scopes remain compatible
through the code migration. New layers should not copy that pattern, and
instead follow the standard pattern of self.CreateChild() in __init__() and
self.CreateVariable() in _CreateLayerVariables(). If you are okay with
breaking old checkpoints, you can go ahead and delete those functions.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.Logits">
<code class="sig-name descname">Logits</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">inputs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerStack.Logits"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.Logits" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.GetEncoders">
<code class="sig-name descname">GetEncoders</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerStack.GetEncoders"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.GetEncoders" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.GetDecoders">
<code class="sig-name descname">GetDecoders</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerStack.GetDecoders"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.GetDecoders" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.EncoderEmbedFPropDefaultTheta">
<code class="sig-name descname">EncoderEmbedFPropDefaultTheta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">source_id</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerStack.EncoderEmbedFPropDefaultTheta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.EncoderEmbedFPropDefaultTheta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.DecoderEmbedFPropDefaultTheta">
<code class="sig-name descname">DecoderEmbedFPropDefaultTheta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">tgt_id</span></em>, <em class="sig-param"><span class="n">t</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerStack.DecoderEmbedFPropDefaultTheta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.DecoderEmbedFPropDefaultTheta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.EncoderFPropDefaultTheta">
<code class="sig-name descname">EncoderFPropDefaultTheta</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">source_vecs</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">encoder_self_atten_segment_mask</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerStack.EncoderFPropDefaultTheta"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.EncoderFPropDefaultTheta" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">source_input</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">target_input</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_paddings</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">source_segment_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_segment_id</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">labels</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">label_weights</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">source_segment_pos</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">target_segment_pos</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/layers_with_gpipe.html#GPipeBatchMajorTransformerStack.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.layers_with_gpipe.GPipeBatchMajorTransformerStack.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Transforms source sequence of Tensors with Transformers layers.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A <a class="reference internal" href="lingvo.core.py_utils.html#lingvo.core.py_utils.NestedMap" title="lingvo.core.py_utils.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing weights’ values of this layer and
its children layers.</p></li>
<li><p><strong>source_input</strong> – A sequence of ints indicating source input ids of [batch,
time].</p></li>
<li><p><strong>source_paddings</strong> – A sequence of 0s and 1s indicating input paddings of
[batch, time].</p></li>
<li><p><strong>target_input</strong> – A sequence of ints indicating target input ids of [batch,
time].</p></li>
<li><p><strong>target_paddings</strong> – [target_batch, target_time].</p></li>
<li><p><strong>source_segment_id</strong> – A sequence of ints indicating source segment ids of
[batch, time].</p></li>
<li><p><strong>target_segment_id</strong> – A sequence of ints indicating target segment ids of
[batch, time].</p></li>
<li><p><strong>labels</strong> – A sequence of ints indicating label ids of [batch, time].</p></li>
<li><p><strong>label_weights</strong> – A sequence of floats indicates label weights of [batch,
time].</p></li>
<li><p><strong>source_segment_pos</strong> – A sequence of ints indicating source position ids of
[batch, time].</p></li>
<li><p><strong>target_segment_pos</strong> – A sequence of ints indicating target position ids of
[batch, time].</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>transformer_output with shape [batch, time, dim].</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lingvo.core.learner.html" class="btn btn-neutral float-right" title="lingvo.core.learner module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lingvo.core.layers_with_attention.html" class="btn btn-neutral float-left" title="lingvo.core.layers_with_attention module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>