

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>lingvo.core.learner module &mdash; Lingvo  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="lingvo.core.lstm_frnn_layer module" href="lingvo.core.lstm_frnn_layer.html" />
    <link rel="prev" title="lingvo.core.layers_with_gpipe module" href="lingvo.core.layers_with_gpipe.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Lingvo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="lingvo.html">lingvo package</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="lingvo.html#subpackages">Subpackages</a><ul class="current">
<li class="toctree-l3 current"><a class="reference internal" href="lingvo.core.html">lingvo.core package</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="lingvo.core.html#subpackages">Subpackages</a></li>
<li class="toctree-l4 current"><a class="reference internal" href="lingvo.core.html#submodules">Submodules</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="lingvo.tasks.html">lingvo.tasks package</a></li>
<li class="toctree-l3"><a class="reference internal" href="lingvo.tools.html">lingvo.tools package</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lingvo.html#submodules">Submodules</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Lingvo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="lingvo.html">lingvo package</a> &raquo;</li>
        
          <li><a href="lingvo.core.html">lingvo.core package</a> &raquo;</li>
        
      <li>lingvo.core.learner module</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/lingvo.core.learner.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="module-lingvo.core.learner">
<span id="lingvo-core-learner-module"></span><h1>lingvo.core.learner module<a class="headerlink" href="#module-lingvo.core.learner" title="Permalink to this headline">¶</a></h1>
<p>A learner optimizes a subset of variables according to a loss.</p>
<p>It consists of a learning rate schedule, an optimizer, and gradient clipping
mechanisms. A BaseTask can have multiple learners, each optimizing a (usually
disjoint) subset of variables.</p>
<dl class="py class">
<dt id="lingvo.core.learner.Learner">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.core.learner.</code><code class="sig-name descname">Learner</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.base_layer.html#lingvo.core.base_layer.BaseLayer" title="lingvo.core.base_layer.BaseLayer"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.base_layer.BaseLayer</span></code></a></p>
<p>A training program layer.</p>
<p>The layer takes a loss tensor as input and outputs a trainer op.</p>
<dl class="py method">
<dt id="lingvo.core.learner.Learner.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the layer params.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner._CreateChildrenVariables">
<code class="sig-name descname">_CreateChildrenVariables</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner._CreateChildrenVariables"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner._CreateChildrenVariables" title="Permalink to this definition">¶</a></dt>
<dd><p>Create variables for child layers.</p>
<p>Should be rarely overridden, only in cases when control over the context of
children InstantiateVariables calls are needed. eg, if children variables
need to be created inside of a specific context manager.</p>
<p>There are a few cases of this in the codebase marked as for backwards
compability. This is only to ensure that variable scopes remain compatible
through the code migration. New layers should not copy that pattern, and
instead follow the standard pattern of self.CreateChild() in __init__() and
self.CreateVariable() in _CreateLayerVariables(). If you are okay with
breaking old checkpoints, you can go ahead and delete those functions.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner.GetVarGrads">
<code class="sig-name descname">GetVarGrads</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner.GetVarGrads"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner.GetVarGrads" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner.GetTrainableVariables">
<code class="sig-name descname">GetTrainableVariables</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">vmap</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner.GetTrainableVariables"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner.GetTrainableVariables" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner.ApplyPostTrainingLoop">
<code class="sig-name descname">ApplyPostTrainingLoop</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner.ApplyPostTrainingLoop"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner.ApplyPostTrainingLoop" title="Permalink to this definition">¶</a></dt>
<dd><p>Applies any computation to run after each tpu trainining loop.</p>
<dl class="field-list simple">
<dt class="field-odd">Returns</dt>
<dd class="field-odd"><p>Ops to run after training loop ends.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner.LearningRate">
<code class="sig-name descname">LearningRate</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner.LearningRate"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner.LearningRate" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner.Apply">
<code class="sig-name descname">Apply</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">metrics</span></em>, <em class="sig-param"><span class="n">vmap</span></em>, <em class="sig-param"><span class="n">gradient_mask</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">gradient_adjuster</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner.Apply"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner.Apply" title="Permalink to this definition">¶</a></dt>
<dd><p>Computes updates on ‘vmap’ to optimize ‘loss’.</p>
<p>TODO(rpang): explore merging gradient_mask and gradient_adjuster.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>metrics</strong> – A Dict[str, (value, weight)], from which loss can be extracted
according to p.loss_name.</p></li>
<li><p><strong>vmap</strong> – A <a class="reference internal" href="lingvo.core.nested_map.html#lingvo.core.nested_map.NestedMap" title="lingvo.core.nested_map.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> object containing variables to optimize.</p></li>
<li><p><strong>gradient_mask</strong> – if not None, a dict mapping variable names to a 0/1 scalar.</p></li>
<li><p><strong>gradient_adjuster</strong> – if not None, a function that mutates a given var_grads.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><dl class="simple">
<dt>(losses, op, eval_metrics), where</dt><dd><ul class="simple">
<li><p>losses is a list of scalar tensors;</p></li>
<li><p>op is a tf.Operation to update variables;</p></li>
<li><p>eval_metrics is a Dict[str, (value, weight)], where each value/weight
is a scalar tensor.</p></li>
</ul>
</dd>
</dl>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner.ComputeActivationGradients">
<code class="sig-name descname">ComputeActivationGradients</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">activations</span></em>, <em class="sig-param"><span class="n">activations_grad</span></em>, <em class="sig-param"><span class="n">vmap</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner.ComputeActivationGradients"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner.ComputeActivationGradients" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner.ComputeLosses">
<code class="sig-name descname">ComputeLosses</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">metrics</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner.ComputeLosses"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner.ComputeLosses" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner._CustomComputeGradientsFn">
<code class="sig-name descname">_CustomComputeGradientsFn</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner._CustomComputeGradientsFn"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner._CustomComputeGradientsFn" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the compute_gradients_fn to use for py_utils.ComputeGradients.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner._ComputeLossesAndGradients">
<code class="sig-name descname">_ComputeLossesAndGradients</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">metrics</span></em>, <em class="sig-param"><span class="n">vmap</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner._ComputeLossesAndGradients"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner._ComputeLossesAndGradients" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner.AdjustGradients">
<code class="sig-name descname">AdjustGradients</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">var_grads</span></em>, <em class="sig-param"><span class="n">gradient_mask</span><span class="o">=</span><span class="default_value">None</span></em>, <em class="sig-param"><span class="n">gradient_adjuster</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner.AdjustGradients"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner.AdjustGradients" title="Permalink to this definition">¶</a></dt>
<dd><p>Adjusts gradients according to learner params.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>var_grads</strong> – a <a class="reference internal" href="lingvo.core.nested_map.html#lingvo.core.nested_map.NestedMap" title="lingvo.core.nested_map.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> whose values are (var, grad) pairs.</p></li>
<li><p><strong>gradient_mask</strong> – if not None, a dict mapping variable names to a 0/1 scalar.</p></li>
<li><p><strong>gradient_adjuster</strong> – if not None, a function that mutates a given var_grads.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>(var_grads, eval_metrics), where var_grads is a <a class="reference internal" href="lingvo.core.nested_map.html#lingvo.core.nested_map.NestedMap" title="lingvo.core.nested_map.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> whose values
(var, grad) pairs representing adjusted gradients.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner._GetGlobalGradScale">
<code class="sig-name descname">_GetGlobalGradScale</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">all_grad_norm</span></em>, <em class="sig-param"><span class="n">has_nan_or_inf</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner._GetGlobalGradScale"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner._GetGlobalGradScale" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns a scaling factor for all gradients according to their norm.</p>
<p>In case there are NaN or Inf values the function will return 0.0.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>all_grad_norm</strong> – A scalar represeting the total norm of all vars.</p></li>
<li><p><strong>has_nan_or_inf</strong> – A scalar of 0 or 1, indicating whether there is any NaN or
Inf in input gradients.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>The gradient scale. 0 if gradient updates should be skipped for the step.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner.ScaleGradients">
<code class="sig-name descname">ScaleGradients</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">var_grads</span></em>, <em class="sig-param"><span class="n">gradient_adjuster</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner.ScaleGradients"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner.ScaleGradients" title="Permalink to this definition">¶</a></dt>
<dd><p>Scales gradients according to training params.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>var_grads</strong> – a <a class="reference internal" href="lingvo.core.nested_map.html#lingvo.core.nested_map.NestedMap" title="lingvo.core.nested_map.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> whose values are (var, grad) pairs.</p></li>
<li><p><strong>gradient_adjuster</strong> – if not None, a function that mutates a given var_grads.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><p>A <a class="reference internal" href="lingvo.core.nested_map.html#lingvo.core.nested_map.NestedMap" title="lingvo.core.nested_map.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> containing</p>
<ul class="simple">
<li><p>final_var_grads: a <a class="reference internal" href="lingvo.core.nested_map.html#lingvo.core.nested_map.NestedMap" title="lingvo.core.nested_map.NestedMap"><code class="xref py py-obj docutils literal notranslate"><span class="pre">NestedMap</span></code></a> whose values are (var, grad) pairs,
where gradients have already been scaled.</p></li>
<li><p>grad_scale: the gradient scale. 0 if gradient updates should be skipped
for the step. (Optional, only returned in case global norm clipping is
used.)</p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.core.learner.Learner._AddEvalMetric">
<code class="sig-name descname">_AddEvalMetric</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">key</span></em>, <em class="sig-param"><span class="n">value</span></em>, <em class="sig-param"><span class="n">weight</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#Learner._AddEvalMetric"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.Learner._AddEvalMetric" title="Permalink to this definition">¶</a></dt>
<dd></dd></dl>

</dd></dl>

<dl class="py function">
<dt id="lingvo.core.learner.ExtractLearnerFromLegacyParams">
<code class="sig-prename descclassname">lingvo.core.learner.</code><code class="sig-name descname">ExtractLearnerFromLegacyParams</code><span class="sig-paren">(</span><em class="sig-param">tp</em>, <em class="sig-param">cls=&lt;class 'lingvo.core.learner.Learner'&gt;</em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/core/learner.html#ExtractLearnerFromLegacyParams"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.core.learner.ExtractLearnerFromLegacyParams" title="Permalink to this definition">¶</a></dt>
<dd><p>Extracts legacy learner params from ‘tp’ to a Learner params.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>tp</strong> – BaseTask training params (p.train). Its legacy params will be cleared to
be None after the conversion.</p></li>
<li><p><strong>cls</strong> – Learner class where we set the params.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>A params for Learner.</p>
</dd>
</dl>
</dd></dl>

</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="lingvo.core.lstm_frnn_layer.html" class="btn btn-neutral float-right" title="lingvo.core.lstm_frnn_layer module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="lingvo.core.layers_with_gpipe.html" class="btn btn-neutral float-left" title="lingvo.core.layers_with_gpipe module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2018.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>