

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lingvo.tasks.asr.fusion module &mdash; Lingvo  documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="lingvo.tasks.asr.input_generator module" href="lingvo.tasks.asr.input_generator.html" />
    <link rel="prev" title="lingvo.tasks.asr.frontend module" href="lingvo.tasks.asr.frontend.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Lingvo
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="lingvo.html">lingvo package</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="lingvo.html#subpackages">Subpackages</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="lingvo.core.html">lingvo.core package</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="lingvo.tasks.html">lingvo.tasks package</a><ul class="current">
<li class="toctree-l4 current"><a class="reference internal" href="lingvo.tasks.html#subpackages">Subpackages</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="lingvo.tools.html">lingvo.tools package</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="lingvo.html#submodules">Submodules</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Lingvo</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="lingvo.html">lingvo package</a> &raquo;</li>
        
          <li><a href="lingvo.tasks.html">lingvo.tasks package</a> &raquo;</li>
        
          <li><a href="lingvo.tasks.asr.html">lingvo.tasks.asr package</a> &raquo;</li>
        
      <li>lingvo.tasks.asr.fusion module</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/lingvo.tasks.asr.fusion.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="module-lingvo.tasks.asr.fusion">
<span id="lingvo-tasks-asr-fusion-module"></span><h1>lingvo.tasks.asr.fusion module<a class="headerlink" href="#module-lingvo.tasks.asr.fusion" title="Permalink to this headline">¶</a></h1>
<p>Utilities for fusing language models with the decoder output.</p>
<dl class="py class">
<dt id="lingvo.tasks.asr.fusion.FusionBase">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.tasks.asr.fusion.</code><code class="sig-name descname">FusionBase</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#FusionBase"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.FusionBase" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="lingvo.core.base_layer.html#lingvo.core.base_layer.BaseLayer" title="lingvo.core.base_layer.BaseLayer"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.core.base_layer.BaseLayer</span></code></a></p>
<p>Base class for fusion with LMs.</p>
<dl class="py method">
<dt id="lingvo.tasks.asr.fusion.FusionBase.Params">
<em class="property">classmethod </em><code class="sig-name descname">Params</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#FusionBase.Params"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.FusionBase.Params" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the layer params.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.tasks.asr.fusion.FusionBase._CreateChildrenVariables">
<code class="sig-name descname">_CreateChildrenVariables</code><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#FusionBase._CreateChildrenVariables"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.FusionBase._CreateChildrenVariables" title="Permalink to this definition">¶</a></dt>
<dd><p>Create variables for child layers.</p>
<p>Should be rarely overridden, only in cases when control over the context of
children InstantiateVariables calls are needed. eg, if children variables
need to be created inside of a specific context manager.</p>
<p>There are a few cases of this in the codebase marked as for backwards
compability. This is only to ensure that variable scopes remain compatible
through the code migration. New layers should not copy that pattern, and
instead follow the standard pattern of self.CreateChild() in __init__() and
self.CreateVariable() in _CreateLayerVariables(). If you are okay with
breaking old checkpoints, you can go ahead and delete those functions.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.tasks.asr.fusion.FusionBase.zero_state">
<code class="sig-name descname">zero_state</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">batch_size</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#FusionBase.zero_state"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.FusionBase.zero_state" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns initial model state for fusion model.</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.tasks.asr.fusion.FusionBase._FPropLm">
<code class="sig-name descname">_FPropLm</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">state0</span></em>, <em class="sig-param"><span class="n">ids</span></em>, <em class="sig-param"><span class="n">paddings</span></em>, <em class="sig-param"><span class="n">misc</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#FusionBase._FPropLm"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.FusionBase._FPropLm" title="Permalink to this definition">¶</a></dt>
<dd><p>LM FProp.</p>
<p>Works for single step or entire seq.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A NestedMap object containing weights for the layer and its
children.</p></li>
<li><p><strong>state0</strong> – A NestedMap of states (specific to the layer).</p></li>
<li><p><strong>ids</strong> – Target ids, of shape [batch_size] for single step unrolling or
[batch_size, base_model_logits_dim] for the entire sequence.</p></li>
<li><p><strong>paddings</strong> – Target paddings, of the same shape as ‘ids’.</p></li>
<li><p><strong>misc</strong> – NestedMap of miscellaneous items, which might be needed during
training.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p>lm_output: A NestedMap containing lm output. If ‘ids’ is 1-D, then
lm_output should have shape [batch_size, dim]; if it is 2-D then the
shape should be [seq_len, batch_size, dim].</p></li>
<li><p>state1: A NestedMap of updated states.</p></li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>(lm_output, state1)</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.tasks.asr.fusion.FusionBase.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">state0</span></em>, <em class="sig-param"><span class="n">am_output</span></em>, <em class="sig-param"><span class="n">ids</span></em>, <em class="sig-param"><span class="n">paddings</span></em>, <em class="sig-param"><span class="n">misc</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#FusionBase.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.FusionBase.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Real fusion logic happens here.</p>
<p>Works for single step or for the entire sequence.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A NestedMap object containing weights for the layer and its
children.</p></li>
<li><p><strong>state0</strong> – A NestedMap of states (specific to the layer).</p></li>
<li><p><strong>am_output</strong> – The output from the speech model. ‘am_output’ can have shape
[batch_size, base_model_logits_dim] for a single step unrolling or
[seq_len, batch_size, base_model_logits_dim] for the entire sequence.</p></li>
<li><p><strong>ids</strong> – Target ids, of shape [batch_size] for single step unrolling or
[batch_size, base_model_logits_dim] for the entire sequence.</p></li>
<li><p><strong>paddings</strong> – Target paddings, of the same shape as ‘ids’.</p></li>
<li><p><strong>misc</strong> – NestedMap of miscellaneous items, which might be needed during
training.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p>fused_output: A tensor containing the fused result. If am_output is 2-D,
then the fused_output should have shape [batch_size, dim]; if
am_output is 3-D, then the shape should be [seq_len, batch_size, dim].</p></li>
<li><p>state1: a NestedMap of updated states (specific to the layer).</p></li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>(fused_output, state1)</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.tasks.asr.fusion.FusionBase._ModifyLmBeforeFProp">
<code class="sig-name descname">_ModifyLmBeforeFProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">state0</span></em>, <em class="sig-param"><span class="n">ids</span></em>, <em class="sig-param"><span class="n">paddings</span></em>, <em class="sig-param"><span class="n">misc</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#FusionBase._ModifyLmBeforeFProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.FusionBase._ModifyLmBeforeFProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Perform any LM modifications before LM FProp (no-op by default).</p>
</dd></dl>

<dl class="py method">
<dt id="lingvo.tasks.asr.fusion.FusionBase.ComputeLogitsWithLM">
<code class="sig-name descname">ComputeLogitsWithLM</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">state</span></em>, <em class="sig-param"><span class="n">logits</span></em>, <em class="sig-param"><span class="n">is_eval</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#FusionBase.ComputeLogitsWithLM"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.FusionBase.ComputeLogitsWithLM" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute resulting logits based on the fusion method.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>state</strong> – a NestedMap of states (specific to the layer).</p></li>
<li><p><strong>logits</strong> – a tensor corresponds to AM logits.</p></li>
<li><p><strong>is_eval</strong> – whether this is used in eval model (for example, beam search).</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Resulting logits after fusion with the LM.</p>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3.7/library/exceptions.html#NotImplementedError" title="(in Python v3.7)"><strong>NotImplementedError</strong></a> – If method is not implemented.</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.tasks.asr.fusion.FusionBase.AddAdditionalDecoderSummaries">
<code class="sig-name descname">AddAdditionalDecoderSummaries</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">source_encs</span></em>, <em class="sig-param"><span class="n">source_paddings</span></em>, <em class="sig-param"><span class="n">targets</span></em>, <em class="sig-param"><span class="n">seq_out_tas</span></em>, <em class="sig-param"><span class="n">softmax_input</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#FusionBase.AddAdditionalDecoderSummaries"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.FusionBase.AddAdditionalDecoderSummaries" title="Permalink to this definition">¶</a></dt>
<dd><p>Add any fusion related summaries (no-op by default).</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>source_encs</strong> – A tensor of shape [time, batch_size, source_dim].</p></li>
<li><p><strong>source_paddings</strong> – A tensor of shape [time, batch_size].</p></li>
<li><p><strong>targets</strong> – A NestedMap containing target info.</p></li>
<li><p><strong>seq_out_tas</strong> – A SequenceOutTensorArrays.</p></li>
<li><p><strong>softmax_input</strong> – A tensor of shape [batch, time, vocab_size].</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</dd></dl>

<dl class="py class">
<dt id="lingvo.tasks.asr.fusion.NullFusion">
<em class="property">class </em><code class="sig-prename descclassname">lingvo.tasks.asr.fusion.</code><code class="sig-name descname">NullFusion</code><span class="sig-paren">(</span><em class="sig-param"><span class="o">*</span><span class="n">args</span></em>, <em class="sig-param"><span class="o">**</span><span class="n">kwargs</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#NullFusion"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.NullFusion" title="Permalink to this definition">¶</a></dt>
<dd><p>Bases: <a class="reference internal" href="#lingvo.tasks.asr.fusion.FusionBase" title="lingvo.tasks.asr.fusion.FusionBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">lingvo.tasks.asr.fusion.FusionBase</span></code></a></p>
<p>A trivial fusion layer which does nothing.</p>
<dl class="py method">
<dt id="lingvo.tasks.asr.fusion.NullFusion.FProp">
<code class="sig-name descname">FProp</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">theta</span></em>, <em class="sig-param"><span class="n">state0</span></em>, <em class="sig-param"><span class="n">am_output</span></em>, <em class="sig-param"><span class="n">ids</span></em>, <em class="sig-param"><span class="n">paddings</span></em>, <em class="sig-param"><span class="n">misc</span><span class="o">=</span><span class="default_value">None</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#NullFusion.FProp"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.NullFusion.FProp" title="Permalink to this definition">¶</a></dt>
<dd><p>Real fusion logic happens here.</p>
<p>Works for single step or for the entire sequence.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>theta</strong> – A NestedMap object containing weights for the layer and its
children.</p></li>
<li><p><strong>state0</strong> – A NestedMap of states (specific to the layer).</p></li>
<li><p><strong>am_output</strong> – The output from the speech model. ‘am_output’ can have shape
[batch_size, base_model_logits_dim] for a single step unrolling or
[seq_len, batch_size, base_model_logits_dim] for the entire sequence.</p></li>
<li><p><strong>ids</strong> – Target ids, of shape [batch_size] for single step unrolling or
[batch_size, base_model_logits_dim] for the entire sequence.</p></li>
<li><p><strong>paddings</strong> – Target paddings, of the same shape as ‘ids’.</p></li>
<li><p><strong>misc</strong> – NestedMap of miscellaneous items, which might be needed during
training.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p>fused_output: A tensor containing the fused result. If am_output is 2-D,
then the fused_output should have shape [batch_size, dim]; if
am_output is 3-D, then the shape should be [seq_len, batch_size, dim].</p></li>
<li><p>state1: a NestedMap of updated states (specific to the layer).</p></li>
</ul>
</p>
</dd>
<dt class="field-odd">Return type</dt>
<dd class="field-odd"><p>(fused_output, state1)</p>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt id="lingvo.tasks.asr.fusion.NullFusion.ComputeLogitsWithLM">
<code class="sig-name descname">ComputeLogitsWithLM</code><span class="sig-paren">(</span><em class="sig-param"><span class="n">state</span></em>, <em class="sig-param"><span class="n">logits</span></em>, <em class="sig-param"><span class="n">is_eval</span><span class="o">=</span><span class="default_value">False</span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/lingvo/tasks/asr/fusion.html#NullFusion.ComputeLogitsWithLM"><span class="viewcode-link">[source]</span></a><a class="headerlink" href="#lingvo.tasks.asr.fusion.NullFusion.ComputeLogitsWithLM" title="Permalink to this definition">¶</a></dt>
<dd><p>Compute resulting logits based on the fusion method.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>state</strong> – a NestedMap of states (specific to the layer).</p></li>
<li><p><strong>logits</strong> – a tensor corresponds to AM logits.</p></li>
<li><p><strong>is_eval</strong> – whether this is used in eval model (for example, beam search).</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>Resulting logits after fusion with the LM.</p>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><a class="reference external" href="https://docs.python.org/3.7/library/exceptions.html#NotImplementedError" title="(in Python v3.7)"><strong>NotImplementedError</strong></a> – If method is not implemented.</p>
</dd>
</dl>
</dd></dl>

</dd></dl>

</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="lingvo.tasks.asr.input_generator.html" class="btn btn-neutral float-right" title="lingvo.tasks.asr.input_generator module" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="lingvo.tasks.asr.frontend.html" class="btn btn-neutral float-left" title="lingvo.tasks.asr.frontend module" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2018

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>